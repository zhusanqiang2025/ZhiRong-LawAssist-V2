# docker-compose.yml - 优化版（无 Redis 依赖，PostgreSQL Broker）
version: '3.8'

services:
  db:
    image: pgvector/pgvector:pg15
    env_file: .env
    ports:
      - "${DB_PORT:-5433}:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-legal_assistant_db}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme_secure_password_123}
    volumes:
       - pgdata:/var/lib/postgresql/data
    restart: always
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-legal_assistant_db}"]
      interval: 5s
      timeout: 5s
      retries: 5

  onlyoffice:
    image: onlyoffice/documentserver:latest
    restart: always
    depends_on:  # 确保数据库先启动
      db:
        condition: service_healthy
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET:-changeme_onlyoffice_jwt_secret_2025}
      - JWT_HEADER=Authorization
      - JWT_IN_BODY=true
    ports:
      - "${ONLYOFFICE_PORT:-8083}:80"
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_log:/var/log/onlyoffice
      - onlyoffice_cache:/var/www/onlyoffice/documentserver/App_Data/cache/files
      - onlyoffice_fonts_cache:/var/www/onlyoffice/documentserver/.cache
    entrypoint:
      - /bin/sh
      - -c
      - |
        mkdir -p /var/www/onlyoffice/documentserver/.cache/pkg
        chmod -R 777 /var/www/onlyoffice/documentserver/.cache || true
        chown -R onlyoffice:onlyoffice /var/www/onlyoffice/documentserver/.cache || true
        /app/ds/run-document-server.sh
    networks:
      - app-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file: .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-changeme_secure_password_123}@db:5432/${POSTGRES_DB:-legal_assistant_db}
    ports:
      - "${BACKEND_PORT:-9000}:8000"
    volumes:
      - ./backend:/app:rw
      - ./storage:/app/storage:rw
    depends_on:
      db:
        condition: service_healthy
      onlyoffice:
        condition: service_started
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--ws-ping-interval", "20", "--ws-ping-timeout", "300"]
    restart: always
    networks:
      - app-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-}
        - VITE_ONLYOFFICE_URL=${VITE_ONLYOFFICE_URL:-http://localhost:8083}
        - VITE_BASE_PATH=${VITE_BASE_PATH:-/}
    ports:
      - "${FRONTEND_PORT:-3001}:80"
    volumes:
      - ./frontend:/app:rw  # 源码挂载（热更新）
    depends_on:
      - backend
      - onlyoffice
    restart: always
    networks:
      - app-network

  # ==================== Celery Worker（PostgreSQL Broker，无 Redis 依赖）====================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file: .env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-changeme_secure_password_123}@db:5432/${POSTGRES_DB:-legal_assistant_db}
    volumes:
      - ./backend:/app:rw
      - ./storage:/app/storage:rw
    depends_on:
      db:
        condition: service_healthy
    command: |-
      celery -A app.tasks.celery_app worker
      --loglevel=info
      --concurrency=2
      --pool=solo
      --queues=high_priority,medium_priority,low_priority,default
      --max-tasks-per-child=100
    restart: always
    networks:
      - app-network

volumes:
  pgdata:
  onlyoffice_data:
  onlyoffice_log:
  onlyoffice_cache:
  onlyoffice_fonts_cache:

networks:
  app-network:
    driver: bridge