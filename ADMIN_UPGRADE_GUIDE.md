# 管理员后台升级文档

## 升级概述

本次升级针对管理员后台的「合同分类配置」和「模板管理」两个核心功能进行了全面改进，将旧的分类系统升级为基于 `PrimaryContractType` 枚举的 V2 合同分类体系，并完整集成 V2 四维法律特征。

## 主要改进

### 1. 合同分类配置 (CategoryManagerView)

#### 改进前
- 使用旧的 `categories` 表进行分类管理
- 支持树形结构的二级分类
- 需要手动创建和编辑分类
- 与智能匹配系统脱节

#### 改进后
- 基于 `PrimaryContractType` 枚举（13种标准合同类型）
- 自动统计每种类型的模板数量
- 实时显示 V2 特征完整率
- 可视化展示模板分布和完整度
- 一键查看每种类型的详细模板列表

#### 13种标准合同类型
```
1. 买卖合同       - 货物买卖、设备采购等
2. 建设工程合同    - 工程总承包、施工合同等
3. 承揽合同       - 加工承揽、定作等
4. 技术转让合同    - 专利转让、技术许可等
5. 租赁合同       - 房屋租赁、设备租赁等
6. 借款合同       - 借款、融资租赁等
7. 劳动合同       - 雇佣、劳务合同等
8. 委托合同       - 软件开发、委托创作等
9. 服务合同       - 技术服务、咨询服务等
10. 合伙合同      - 合伙、联营协议等
11. 合作协议      - 战略合作、联合经营等
12. 保密协议      - NDA、保密条款等
13. 其他          - 其他类型合同
```

#### 功能特性
- **模板统计**: 显示每种类型的总数、V2完整数、待补充数
- **完整率**: 进度条可视化展示 V2 特征完整百分比
- **状态标识**: 🟢完整 / 🟡良好 / 🔴需完善 / ⚪无模板
- **详情查看**: 点击查看该类型的所有模板及其 V2 特征状态

### 2. 模板管理 (TemplateManagerView)

#### 改进前
- 基础的模板CRUD操作
- 简单的分类选择（旧系统）
- 无法编辑 V2 法律特征

#### 改进后
- 完整集成 V2 四维法律特征
- 上传时可填写 V2 特征（可选，后续可补充）
- 独立的 V2 特征编辑器
- 实时显示模板的 V2 特征标签
- 支持按主合同类型和 V2 特征筛选

#### 上传表单新增字段
```
基础信息：
- 模板名称
- 主合同类型（PrimaryContractType下拉选择）
- 模板描述

V2 法律特征：
- 交易性质：转移所有权/提供服务/许可使用/合作经营/融资借贷/劳动用工
- 合同标的：货物/工程/ip/服务/股权/资金/human_labor/real_estate
- 复杂程度：simple/standard_commercial/complex
- 立场：neutral/party_a/party_b/balanced
- 风险等级：low/mid/high
- 推荐模板：是/否

权限设置：
- 公开/私有
```

#### 表格显示
- **主合同类型**: 蓝色标签
- **V2 特征**: 4个彩色标签（交易性质、合同标的、复杂度、立场）
- **风险等级**: 绿/橙/红色标签
- **推荐标识**: ⭐ 金色标签
- **操作按钮**: V2特征编辑 + 删除

## API 端点更新

### 合同分类配置相关
```
GET /api/v1/contract/?scope=all&page_size=1000
获取所有模板用于统计分析
```

### 模板管理相关
```
# 获取所有模板（包含 V2 特征）
GET /api/v1/contract/?scope=all

# 上传新模板（支持 V2 特征）
POST /api/v1/contract/upload
参数：
  - file: 文件
  - name: 模板名称
  - primary_contract_type: 主合同类型
  - transaction_nature: 交易性质（可选）
  - contract_object: 合同标的（可选）
  - complexity: 复杂程度（可选）
  - stance: 立场（可选）
  - risk_level: 风险等级（可选）
  - is_recommended: 推荐模板（可选）
  - description: 描述（可选）
  - is_public: 是否公开（可选）

# 更新 V2 法律特征（仅管理员）
PUT /api/v1/contract/{id}/v2-features
Body: {
  "primary_contract_type": "委托合同",
  "transaction_nature": "提供服务",
  "contract_object": "ip",
  "complexity": "standard_commercial",
  "stance": "neutral",
  "risk_level": "mid",
  "is_recommended": true
}

# 删除模板
DELETE /api/v1/contract/{id}
```

## 前端文件变更

### AdminPage.tsx
- **CategoryManagerView**: 完全重写，基于 PrimaryContractType 枚举
- **TemplateManagerView**: 增强上传表单，添加 V2 特征字段

### 新增组件
- **TemplateV2Editor.tsx**: 独立的 V2 特征编辑器组件

### API 接口
- **contractTemplates.ts**: 添加 `updateTemplateV2Features()` 方法

## 后端文件变更

### contract_templates.py
- **upload_template()**: 支持 V2 特征字段接收
- **TemplateResponse**: 包含所有 V2 字段
- **update_template_v2_features()**: 新增 V2 特征更新端点

## 测试验证

运行测试脚本：
```bash
docker-compose exec backend python scripts/test_admin_upgrade.py
```

测试结果示例：
```
步骤 2: 合同分类配置统计
买卖合同       | 总数: 27 | V2完整: 27 | 待补充:  0 | 完整率:100% | 🟢 完整
建设工程合同   | 总数: 12 | V2完整: 12 | 待补充:  0 | 完整率:100% | 🟢 完整
承揽合同       | 总数:  0 | V2完整:  0 | 待补充:  0 | 完整率:  0% | ⚪  无模板
借款合同       | 总数:  0 | V2完整:  0 | 待补充:  0 | 完整率:  0% | ⚪  无模板
```

## 使用指南

### 查看合同分类配置
1. 登录管理员账户
2. 进入「系统管理后台」
3. 点击左侧「合同分类配置」
4. 查看13种合同类型的统计信息
5. 点击「查看详情」查看具体模板列表

### 补充缺失的合同类型
1. 在「合同分类配置」中识别缺失的类型（标记为⚪无模板）
2. 进入「模板管理」
3. 点击「上传模板」
4. 选择对应的「主合同类型」
5. 填写 V2 法律特征（建议填写，可后续补充）
6. 上传模板文件

### 编辑模板 V2 特征
1. 进入「模板管理」
2. 找到需要编辑的模板
3. 点击「V2特征」按钮
4. 在弹出窗口中编辑 V2 四维法律特征
5. 点击「保存」

## 核心优势

1. **统一标准**: 使用与智能匹配系统相同的 PrimaryContractType 枚举
2. **可视化**: 实时显示模板分布和 V2 特征完整度
3. **易用性**: 上传时可选择性填写 V2 特征，降低使用门槛
4. **完整性**: 提供清晰指引帮助管理员补充缺失的合同类型
5. **一致性**: 确保前端、后端、智能匹配系统使用相同的分类标准

## 当前状态

根据测试结果：
- ✅ 7种合同类型已有模板且 V2 特征完整
- ⚠️ 6种合同类型缺失模板：承揽合同、技术转让合同、借款合同、合作协议、保密协议、其他
- ✅ 所有现有模板的 V2 特征都完整
- ✅ API 端点正常工作

## 后续建议

1. **补充缺失类型**: 优先补充借款合同、保密协议等高频使用的合同类型
2. **V2 特征优化**: 根据实际使用反馈调整 V2 特征的默认值和提示
3. **批量操作**: 添加批量导入和批量编辑 V2 特征功能
4. **模板推荐**: 基于完整率和下载量推荐热门模板
