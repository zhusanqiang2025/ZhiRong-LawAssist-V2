variables:
  CI_REGISTRY_IMAGE_ID: registry.cn-hangzhou.aliyuncs.com/starzz/az:${CI_PROJECT_TITLE}_${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}
  CI_REGISTRY_IMAGE_vendor: registry.cn-hangzhou.aliyuncs.com/starzz/az:${CI_PROJECT_TITLE}_vendor
  CI_REGISTRY_IMAGE_vendor_id: registry.cn-hangzhou.aliyuncs.com/starzz/az:${CI_PROJECT_TITLE}_vendor_${CI_PIPELINE_ID}
  PROJECT_NAME: $CI_PROJECT_TITLE
  GIT_SSL_NO_VERIFY: 'true'
  BUILDKIT_PROGRESS: plain
  DEPLOY_SERVER_NAME: azgpu02/$CI_PROJECT_TITLE
  # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œè™½ç„¶å†™äº†8000ï¼Œä½†å®¹å™¨å®é™…ç›‘å¬7860ã€‚å¦‚æœK8s Serviceé…ç½®äº†8000->7860è½¬å‘åˆ™æ²¡é—®é¢˜ã€‚
  # å¦‚æœæœ‰é—®é¢˜ï¼Œéœ€ç¡®è®¤ K8s çš„ Service é…ç½®ã€‚
  DEPLOY_HTTP_PORT: 8000 

build_vendor_image:
  image: registry.cn-hangzhou.aliyuncs.com/sync/hub:docker
  stage: .pre
  rules:
    - if: '$CI_COMMIT_TITLE =~ /.*\[vendor\].*/'
      when: always
  before_script:
    - sudo docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY_URL
  script:
    - echo "$CI_REGISTRY_IMAGE_vendor_id"
    - sudo docker build --pull --build-arg APP_VERSION="${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}" --build-arg CI_PROJECT_TITLE="${CI_PROJECT_TITLE}" -t "$CI_REGISTRY_IMAGE_vendor_id" . -f docker/Dockerfile.vendor
    - sudo docker push "$CI_REGISTRY_IMAGE_vendor_id"
    - sudo docker tag "$CI_REGISTRY_IMAGE_vendor_id" "$CI_REGISTRY_IMAGE_vendor"
    - sudo docker push "$CI_REGISTRY_IMAGE_vendor"
    - echo "$CI_REGISTRY_IMAGE_vendor_id"


build_image:
  image: registry.cn-hangzhou.aliyuncs.com/sync/hub:docker
  stage: build
  only:
    - master
    - main
    - qa
    - qa2
    - pre
  before_script:
    - sudo docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY_URL
  script:
    - echo "$CI_REGISTRY_IMAGE_ID"
    
    # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€ä¿®å¤å¼€å§‹ï¼šé«˜å¼ºåº¦çš„ .env ç”Ÿæˆé€»è¾‘ã€‘ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    # é€»è¾‘ï¼šåˆ¤æ–­ $PROJECT_ENV_FILE æ˜¯æ–‡ä»¶è·¯å¾„è¿˜æ˜¯æ–‡æœ¬å†…å®¹
    # å¦‚æœæ˜¯æ–‡ä»¶è·¯å¾„(-f)ï¼Œç›´æ¥ cpï¼›å¦‚æœæ˜¯æ–‡æœ¬ï¼Œç”¨ echo å†™å…¥
    - |
      if [ -f "$PROJECT_ENV_FILE" ]; then
        cp "$PROJECT_ENV_FILE" .env
        echo "âœ… Detected PROJECT_ENV_FILE as a file, copied to .env"
      else
        echo "$PROJECT_ENV_FILE" > .env
        echo "âœ… Detected PROJECT_ENV_FILE as text content, wrote to .env"
      fi
    # ğŸ‘†ğŸ‘†ğŸ‘† ã€ä¿®å¤ç»“æŸã€‘ ğŸ‘†ğŸ‘†ğŸ‘†
    
    - sed -i "s/__VERSION__/${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}/g" docker/Dockerfile
    - sudo docker build --pull --build-arg APP_VERSION="${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}" --build-arg CI_PROJECT_TITLE="${CI_PROJECT_TITLE}" -t "$CI_REGISTRY_IMAGE_ID" . -f docker/Dockerfile
    - sudo docker push "$CI_REGISTRY_IMAGE_ID"
    - echo "$CI_REGISTRY_IMAGE_ID"


deploy_production:
  image: registry.cn-hangzhou.aliyuncs.com/starzz/cicd:az-argocd
  stage: deploy
  tags:
    - k8s
  only:
    - master
    - main
    - qa
    - qa2
    - pre
  variables:
    GIT_STRATEGY: none
#  when: manual
  script:
    - export PREFIX=''
    - if [ "$CI_COMMIT_REF_NAME" == "qa" ]; then export PREFIX='qa-' ; fi
    - if [ "$CI_COMMIT_REF_NAME" == "pre" ]; then export PREFIX='pre-' ; fi
    - export DEPLOY_NAME=${PREFIX}${PROJECT_NAME}
    - echo "DEPLOY_NAME=$DEPLOY_NAME"
    - kubectl set image deploy/$DEPLOY_NAME "$DEPLOY_NAME=${CI_REGISTRY_IMAGE_ID}" --record -n shentong