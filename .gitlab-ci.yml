variables:
  CI_REGISTRY_IMAGE_ID: registry.cn-hangzhou.aliyuncs.com/starzz/az:${CI_PROJECT_TITLE}_${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}
  CI_REGISTRY_IMAGE_vendor: registry.cn-hangzhou.aliyuncs.com/starzz/az:${CI_PROJECT_TITLE}_vendor
  CI_REGISTRY_IMAGE_vendor_id: registry.cn-hangzhou.aliyuncs.com/starzz/az:${CI_PROJECT_TITLE}_vendor_${CI_PIPELINE_ID}
  PROJECT_NAME: $CI_PROJECT_TITLE
  GIT_SSL_NO_VERIFY: 'true'
  BUILDKIT_PROGRESS: plain
  DEPLOY_SERVER_NAME: azgpu02/$CI_PROJECT_TITLE
  DEPLOY_HTTP_PORT: 8000

build_vendor_image:
  image: registry.cn-hangzhou.aliyuncs.com/sync/hub:docker
  stage: .pre
  rules:
    - if: '$CI_COMMIT_TITLE =~ /.*\[vendor\].*/'
      when: always
  before_script:
    - sudo docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY_URL
  script:
    - echo "$CI_REGISTRY_IMAGE_vendor_id"
    - sudo docker build --pull --build-arg APP_VERSION="${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}" --build-arg CI_PROJECT_TITLE="${CI_PROJECT_TITLE}" -t "$CI_REGISTRY_IMAGE_vendor_id" . -f docker/Dockerfile.vendor
    - sudo docker push "$CI_REGISTRY_IMAGE_vendor_id"
    - sudo docker tag "$CI_REGISTRY_IMAGE_vendor_id" "$CI_REGISTRY_IMAGE_vendor"
    - sudo docker push "$CI_REGISTRY_IMAGE_vendor"
    - echo "$CI_REGISTRY_IMAGE_vendor_id"


build_image:
  image: registry.cn-hangzhou.aliyuncs.com/sync/hub:docker
  stage: build
  only:
    - master
    - main
    - qa
    - qa2
    - pre
  before_script:
    - sudo docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY_URL
  script:
    - echo "$CI_REGISTRY_IMAGE_ID"
    - sed -i "s/__VERSION__/${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}/g" docker/Dockerfile
    - sudo docker build --pull --build-arg APP_VERSION="${CI_COMMIT_REF_NAME}_${CI_PIPELINE_ID}" --build-arg CI_PROJECT_TITLE="${CI_PROJECT_TITLE}" -t "$CI_REGISTRY_IMAGE_ID" . -f docker/Dockerfile
    - sudo docker push "$CI_REGISTRY_IMAGE_ID"
    - echo "$CI_REGISTRY_IMAGE_ID"


deploy_production:
  image: registry.cn-hangzhou.aliyuncs.com/starzz/cicd:az-argocd
  stage: deploy
  tags:
    - k8s
  only:
    - master
    - main
    - qa
    - qa2
    - pre
  variables:
    GIT_STRATEGY: none
#  when: manual
  script:
    - export PREFIX=''
    - if [ "$CI_COMMIT_REF_NAME" == "qa" ]; then export PREFIX='qa-' ; fi
    - if [ "$CI_COMMIT_REF_NAME" == "pre" ]; then export PREFIX='pre-' ; fi
    - export DEPLOY_NAME=${PREFIX}${PROJECT_NAME}
    - echo "DEPLOY_NAME=$DEPLOY_NAME"
    - kubectl set image deploy/$DEPLOY_NAME "$DEPLOY_NAME=${CI_REGISTRY_IMAGE_ID}" --record -n shentong
