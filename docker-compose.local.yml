# docker-compose.local.yml - 本地开发版本
# 使用轻量级配置，避免网络问题

services:
  redis:
    image: redis:7-alpine
    container_name: legal_doc_redis_local
    ports:
      - "6380:6379"
    # Redis配置（飞书集成本地开发）
    command: redis-server --requirepass 123myredissecret --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "123myredissecret", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - legal_doc_local_network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.local
    container_name: legal_doc_backend_local
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./backend/.env:/app/.env
    env_file:
      - ./backend/.env
    environment:
      # Redis配置（飞书集成本地开发）
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=123myredissecret
      - REDIS_DB=0
      # Celery配置（飞书集成本地开发）
      - CELERY_BROKER_URL=redis://:123myredissecret@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:123myredissecret@redis:6379/0
      - CELERY_ENABLED=true
      # 数据库配置
      - DATABASE_URL=sqlite:///./app.db  # 使用SQLite简化部署
      # 飞书API配置（修复：添加 /open-apis 路径）
      - FEISHU_BASE_API_URL=https://open.feishu.cn/open-apis
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    command: ["python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    networks:
      - legal_doc_local_network

  # ==================== Celery Worker 服务（飞书审查集成） ====================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.local
    container_name: legal_doc_celery_worker_local
    volumes:
      - ./backend:/app
      - ./backend/.env:/app/.env
    env_file:
      - ./backend/.env
    environment:
      # Redis配置
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=123myredissecret
      - REDIS_DB=0
      # Celery配置
      - CELERY_BROKER_URL=redis://:123myredissecret@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:123myredissecret@redis:6379/0
      # 数据库配置
      - DATABASE_URL=sqlite:///./app.db
      # 飞书API配置（修复：添加 /open-apis 路径）
      - FEISHU_BASE_API_URL=https://open.feishu.cn/open-apis
      # 审查模块API配置（Docker网络内使用服务名）
      - REVIEW_API_BASE=http://backend:8000
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_started
    restart: unless-stopped
    command: >
      celery -A app.tasks.celery_app worker
      --loglevel=info
      --concurrency=2
      --queues=high_priority,medium_priority,low_priority,default
      -n worker-local@%h
      --max-tasks-per-child=100
    networks:
      - legal_doc_local_network

# 网络配置（飞书集成本地开发）
networks:
  legal_doc_local_network:
    driver: bridge

# 数据卷（飞书集成本地开发）
volumes:
  redis_data: