ğŸ“„ åˆåŒç”Ÿæˆæ¨¡å—äº§å“å¼€å‘æ–‡æ¡£ (V2.0 - å®Œæ•´ç‰ˆ)
ğŸ¯ 1. æ¦‚è¿°
1.1 äº§å“ç›®æ ‡
æ„å»ºä¸€ä¸ªæ™ºèƒ½ã€é«˜æ•ˆã€å¯æ‰©å±•çš„åˆåŒç”Ÿæˆæ¨¡å—ï¼Œæ”¯æŒä»ç®€å•çš„å•ä¸€åˆåŒåˆ°å¤æ‚çš„åˆåŒè§„åˆ’åœºæ™¯ï¼Œæ»¡è¶³ç”¨æˆ·å¤šæ ·åŒ–çš„æ³•å¾‹æ–‡ä¹¦ç”Ÿæˆéœ€æ±‚ã€‚æ ¸å¿ƒç†å¿µæ˜¯â€œæ¨¡æ¿ä¼˜å…ˆï¼ŒAI è¾…åŠ©â€ï¼Œç¡®ä¿ç”ŸæˆåˆåŒçš„ä¸“ä¸šæ€§ã€ç¨³å®šæ€§å’Œå¯å®šåˆ¶æ€§ã€‚

1.2 æ ¸å¿ƒç†å¿µ
æ¨¡æ¿ä¼˜å…ˆï¼šä¼˜å…ˆåˆ©ç”¨é«˜è´¨é‡çš„åˆåŒæ¨¡æ¿è¿›è¡Œæ”¹å†™ï¼Œè€Œéå®Œå…¨ç”± AI ä»é›¶ç”Ÿæˆï¼Œä»¥ä¿è¯åˆåŒçš„ä¸“ä¸šæ€§å’Œç¨³å®šæ€§ã€‚
AI è¾…åŠ©ï¼šåˆ©ç”¨ AI è¿›è¡Œæ„å›¾åˆ†æã€æ¨¡æ¿åŒ¹é…ã€åˆåŒèµ·è‰å’Œè§„åˆ’ï¼Œæå‡æ•ˆç‡ã€‚
æµç¨‹åŒ–ï¼šå°†åˆåŒç”Ÿæˆæ‹†è§£ä¸ºæ¸…æ™°çš„æ­¥éª¤ï¼Œä¾¿äºç®¡ç†å’Œä¼˜åŒ–ã€‚
å¯æ‰©å±•ï¼šæ”¯æŒå•æ¨¡å‹å’Œå¤šæ¨¡å‹ä¸¤ç§è§„åˆ’æ¨¡å¼ï¼Œé€‚åº”ä¸åŒå¤æ‚åº¦å’Œæ€§èƒ½è¦æ±‚ã€‚
å¯è¿­ä»£ï¼šæ”¯æŒå¯¹ç”Ÿæˆç»“æœè¿›è¡Œä¿®æ”¹å’Œé‡æ–°ç”Ÿæˆï¼Œå½¢æˆç”¨æˆ·åé¦ˆé—­ç¯ã€‚
ğŸ—ï¸ 2. æ¶æ„è®¾è®¡
2.1 æ€»ä½“æ¶æ„
æ¨¡å—é‡‡ç”¨ LangGraph çŠ¶æ€æœº + RAG + Agent çš„æ¶æ„æ¨¡å¼ã€‚

1234567
[å‰ç«¯é¡µé¢] <-API-> [API è·¯ç”±å±‚] <-State-> [LangGraph å·¥ä½œæµ]
                                          |
                                    [çŠ¶æ€ç®¡ç†: ContractGenerationState]
                                          |
                    [éœ€æ±‚åˆ†æ] -> [æ¨¡æ¿åŒ¹é…/è§„åˆ’] -> [åˆåŒèµ·è‰]
                        |            |              |
                    [Agent]      [RAG/DB]        [Agent]
2.2 æ ¸å¿ƒç»„ä»¶
ç»„ä»¶
æ–‡ä»¶/ç›®å½•
èŒè´£
è¯´æ˜
API è·¯ç”±
api/contract_generation_router.py
æš´éœ² REST API æ¥å£
å¤„ç†å‰ç«¯è¯·æ±‚ï¼Œé›†æˆ Celery å¼‚æ­¥ä»»åŠ¡
å·¥ä½œæµå¼•æ“
services/contract_generation/workflow.py
å®šä¹‰å’Œæ‰§è¡Œæ ¸å¿ƒæµç¨‹
ä½¿ç”¨ LangGraph æ„å»ºçŠ¶æ€å›¾
çŠ¶æ€ç®¡ç†
services/contract_generation/workflow.py (State Definition)
å­˜å‚¨æµç¨‹çŠ¶æ€
TypedDict å®šä¹‰ï¼Œè´¯ç©¿æ•´ä¸ªæµç¨‹
éœ€æ±‚åˆ†æå™¨
services/contract_generation/agents/requirement_analyzer.py
åˆ†æç”¨æˆ·è¾“å…¥
åˆ¤æ–­å¤„ç†ç±»å‹ï¼ˆå˜æ›´/è§£é™¤/è§„åˆ’/å•ä¸€ï¼‰ã€æå–å…³é”®ä¿¡æ¯
æ„å›¾åˆ†æå™¨
services/contract_generation/agents/contract_intent_analyzer.py
ç»†åŒ–éœ€æ±‚åˆ†æ
è¯†åˆ«å…·ä½“åˆåŒç±»å‹ï¼Œæå–æ³•å¾‹ç‰¹å¾
æ¨¡æ¿åŠ è½½å™¨
services/contract_generation/structural/template_loader.py
ä» DB åŠ è½½æ¨¡æ¿æ–‡ä»¶
æ ¹æ® ID ä»æ•°æ®åº“è·å–æ¨¡æ¿è·¯å¾„å¹¶è¯»å–å†…å®¹
æ¨¡æ¿æ£€ç´¢å™¨
services/contract_generation/rag/template_retriever.py
RAG æ£€ç´¢åŒ¹é…æ¨¡æ¿
ä½¿ç”¨å‘é‡æ£€ç´¢å’Œé‡æ’åº
åˆåŒèµ·è‰å™¨
services/contract_generation/agents/contract_drafter.py
èµ·è‰åˆåŒå†…å®¹
æ ¹æ®åˆ†æç»“æœå’Œæ¨¡æ¿å†…å®¹ç”Ÿæˆæœ€ç»ˆåˆåŒæ–‡æœ¬
åˆåŒè§„åˆ’å™¨
services/contract_generation/agents/contract_planning_service.py
è§„åˆ’å•ä¸€åˆåŒ
å•æ¨¡å‹è§„åˆ’å™¨
å¤šæ¨¡å‹è§„åˆ’å™¨
services/contract_generation/agents/multi_model_planning_service.py
è§„åˆ’ä¸€æ½å­åè®®
å¤šæ¨¡å‹ååŒåˆ†æä¸èåˆ (å¾…é›†æˆ)
æ–¹æ¡ˆè¯„ä¼°å™¨
services/contract_generation/agents/planning_solution_evaluator.py
è¯„ä¼°å¤šæ¨¡å‹æ–¹æ¡ˆ
å¯¹å¤šæ¨¡å‹è§„åˆ’ç»“æœè¿›è¡Œè¯„åˆ†å’Œé€‰æ‹© (å¾…é›†æˆ)
å‘é‡å­˜å‚¨
services/contract_generation/rag/vector_store.py
å­˜å‚¨æ¨¡æ¿å‘é‡
åŸºäº ChromaDB
BGE å®¢æˆ·ç«¯
services/contract_generation/rag/bge_client.py
è°ƒç”¨ BGE æœåŠ¡
åµŒå…¥å’Œé‡æ’åº API å°è£…
ç»Ÿä¸€æ–‡æ¡£æœåŠ¡
services/unified_document_service.py
æå–ä¸Šä¼ æ–‡ä»¶å†…å®¹
ç”¨äºç”Ÿæˆå‰çš„é¢„å¤„ç†
ğŸ”„ 3. æ ¸å¿ƒæµç¨‹
3.1 ä¸»æµç¨‹å›¾

graph TD
    Start([ç”¨æˆ·è¾“å…¥+ä¸Šä¼ æ–‡ä»¶]) --> PreProc[å¤„ç†ç”¨æˆ·è¾“å…¥ & é¢„å¤„ç†æ–‡ä»¶]
    PreProc --> AnReq[åˆ†æç”¨æˆ·éœ€æ±‚]
    AnReq --> QueryKG[æŸ¥è¯¢çŸ¥è¯†å›¾è°±]
    QueryKG --> ProcType{åˆ¤æ–­å¤„ç†ç±»å‹}
    ProcType -->|å˜æ›´/è§£é™¤| ExtOrig[æå–åŸåˆåŒ]
    ProcType -->|å•ä¸€åˆåŒ| MatchTemp[ç»“æ„åŒ–æ¨¡æ¿åŒ¹é…]
    ProcType -->|åˆåŒè§„åˆ’| DecidePlanMethod[å†³ç­–ï¼šå•æ¨¡å‹/å¤šæ¨¡å‹è§„åˆ’]

    ExtOrig --> ModTerm{åˆ¤æ–­å˜æ›´è¿˜æ˜¯è§£é™¤}
    ModTerm -->|å˜æ›´| DraftMod[èµ·è‰å˜æ›´åè®®]
    ModTerm -->|è§£é™¤| DraftTerm[èµ·è‰è§£é™¤åè®®]

    MatchTemp --> SelStrat[é€‰æ‹©ç”Ÿæˆç­–ç•¥]
    SelStrat --> LoadTemp[åŠ è½½æ¨¡æ¿ç‰©ç†æ–‡ä»¶]
    LoadTemp --> DraftSing[èµ·è‰å•ä¸€åˆåŒ]

    DecidePlanMethod -->|å•æ¨¡å‹| PlanSing[å•æ¨¡å‹è§„åˆ’]
    DecidePlanMethod -->|å¤šæ¨¡å‹| PlanMulti[å¤šæ¨¡å‹è§„åˆ’]

    PlanSing --> GenFromPlan[æ ¹æ®è§„åˆ’èµ·è‰åˆåŒ]
    PlanMulti --> GenFromPlan

    GenFromPlan --> ShouldCont{æ˜¯å¦ç»§ç»­è§„åˆ’?}
    ShouldCont -->|ç»§ç»­| GenFromPlan
    ShouldCont -->|å®Œæˆ| End[ç»“æŸ]

    DraftMod --> End
    DraftTerm --> End
    DraftSing --> End

3.2 è¯¦ç»†æµç¨‹è¯´æ˜
é˜¶æ®µä¸€ï¼šè¾“å…¥å¤„ç†
å¤„ç†ç”¨æˆ·è¾“å…¥ & é¢„å¤„ç†æ–‡ä»¶ (process_user_input):
æ¥æ”¶ user_input å’Œ uploaded_filesã€‚
å¦‚æœå­˜åœ¨ uploaded_filesï¼Œä½¿ç”¨ unified_document_service å¼‚æ­¥æå–æ–‡ä»¶å†…å®¹ï¼Œæ‹¼æ¥æˆ reference_contentã€‚
åˆå§‹åŒ– state ä¸­çš„å„ä¸ªå­—æ®µï¼ŒåŒ…æ‹¬ reference_content, knowledge_graph_features ç­‰ã€‚
é˜¶æ®µäºŒï¼šéœ€æ±‚åˆ†æä¸çŸ¥è¯†å¢å¼º
åˆ†æç”¨æˆ·éœ€æ±‚ (analyze_requirement):
ä½¿ç”¨ RequirementAnalyzer åˆ†æ user_inputã€‚
ç¡®å®š processing_type (å˜æ›´/è§£é™¤/å•ä¸€/è§„åˆ’)ã€‚
æå– key_info (å¦‚åˆåŒç±»å‹ã€äº¤æ˜“å¯¹è±¡ç­‰)ã€‚
åˆ¤æ–­æ˜¯å¦éœ€è¦æ¾„æ¸… (requires_user_input)ã€‚
æ›´æ–° state["analysis_result"] å’Œ state["processing_type"]ã€‚
æŸ¥è¯¢çŸ¥è¯†å›¾è°± (query_knowledge_graph):
æ ¹æ® analysis_result ä¸­çš„åˆåŒç±»å‹ï¼Œåœ¨çŸ¥è¯†å›¾è°±ä¸­æŸ¥è¯¢æ³•å¾‹ç‰¹å¾ (legal_features)ã€‚
æ›´æ–° state["knowledge_graph_features"]ã€‚
é˜¶æ®µä¸‰ï¼šæµç¨‹åˆ†æ”¯å†³ç­–
æ ¹æ® processing_type åˆ†æ”¯ (determine_processing_type):
å˜æ›´/è§£é™¤: è¿›å…¥å˜æ›´/è§£é™¤åˆ†æ”¯ã€‚
å•ä¸€åˆåŒ: è¿›å…¥æ¨¡æ¿åŒ¹é…åˆ†æ”¯ã€‚
åˆåŒè§„åˆ’: è¿›å…¥è§„åˆ’åˆ†æ”¯ï¼Œéœ€å†³ç­–å•/å¤šæ¨¡å‹ã€‚
åˆ†æ”¯ä¸€ï¼šå˜æ›´/è§£é™¤
æå–åŸåˆåŒ (extract_original_contract):
å°† reference_content ä½œä¸º original_contractã€‚
èµ·è‰åè®® (draft_modification_agreement / draft_termination_agreement):
ä½¿ç”¨ ContractDrafterAgent èµ·è‰å˜æ›´æˆ–è§£é™¤åè®®ã€‚
æ›´æ–° state["generated_contracts"]ã€‚
åˆ†æ”¯äºŒï¼šå•ä¸€åˆåŒ (æ¨¡æ¿ä¼˜å…ˆ)
ç»“æ„åŒ–æ¨¡æ¿åŒ¹é… (match_template):
ä½¿ç”¨ structural_matcher è¿›è¡ŒåŒ¹é…ï¼Œè·å– template_match_result (åŒ…å«åŒ¹é…ç­‰çº§ã€æ¨¡æ¿ ID ç­‰)ã€‚
é€‰æ‹©ç”Ÿæˆç­–ç•¥ (select_generation_strategy):
æ ¹æ® template_match_result å’Œ analysis_result é€‰æ‹©ç­–ç•¥ã€‚
åŠ è½½æ¨¡æ¿ç‰©ç†æ–‡ä»¶ (load_template_file):
æ ¹æ®ç­–ç•¥é€‰æ‹©çš„ template_idï¼Œä½¿ç”¨ TemplateLoader ä»æ•°æ®åº“åŠ è½½æ¨¡æ¿çš„ Markdown å†…å®¹ (template_content)ã€‚
èµ·è‰å•ä¸€åˆåŒ (draft_single_contract):
æ£€æŸ¥ state["template_content"]:
å­˜åœ¨: è°ƒç”¨ ContractDrafterAgent._draft_with_template_newï¼Œè¦æ±‚ LLM åŸºäº template_content è¿›è¡Œæ”¹å†™ï¼Œå¹¶åˆ©ç”¨ reference_content å’Œ knowledge_graph_featuresã€‚
ä¸å­˜åœ¨: è°ƒç”¨ ContractDrafterAgent.draft_from_scratchï¼Œè¦æ±‚ LLM ä»é›¶ç”Ÿæˆï¼ŒåŒæ ·åˆ©ç”¨ reference_content å’Œ knowledge_graph_featuresã€‚
æ›´æ–° state["generated_contracts"]ã€‚
åˆ†æ”¯ä¸‰ï¼šåˆåŒè§„åˆ’ (å•/å¤šæ¨¡å‹é€‰æ‹©)
å†³ç­–ï¼šå•æ¨¡å‹/å¤šæ¨¡å‹è§„åˆ’ (decide_planning_method):
ä» state["planning_mode"] è¯»å–ç”¨æˆ·é€‰æ‹© (é»˜è®¤ single_model)ã€‚
è·¯ç”±åˆ°ç›¸åº”çš„è§„åˆ’èŠ‚ç‚¹ã€‚
å•æ¨¡å‹è§„åˆ’ (plan_contracts):
è°ƒç”¨ ContractPlanningService (å•æ¨¡å‹) è¿›è¡Œè§„åˆ’ã€‚
å°†ç»“æœè½¬æ¢ä¸º List[Dict] æ ¼å¼ï¼Œå­˜å…¥ state["contract_plan"]ã€‚
å¤šæ¨¡å‹è§„åˆ’ (plan_contracts_multi_model):
è°ƒç”¨ MultiModelContractPlanningService å¹¶è¡Œç”Ÿæˆæ–¹æ¡ˆã€‚
è°ƒç”¨ PlanningSolutionEvaluator è¯„ä¼°å¹¶é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆã€‚
å°†æœ€ä¼˜æ–¹æ¡ˆè½¬æ¢ä¸º List[Dict] æ ¼å¼ï¼Œå­˜å…¥ state["contract_plan"]ã€‚
æ ¹æ®è§„åˆ’èµ·è‰åˆåŒ (draft_from_plan):
ä» state["contract_plan"] ä¸­å–å‡ºå½“å‰ current_plan_index å¯¹åº”çš„åˆåŒä¿¡æ¯ã€‚
è°ƒç”¨ ContractDrafterAgent.draft_from_scratch ä¸ºè¯¥åˆåŒèµ·è‰å†…å®¹ã€‚
å°†èµ·è‰ç»“æœåŠ å…¥ state["generated_contracts"]ã€‚
æ›´æ–° state["current_plan_index"]ã€‚
å¾ªç¯æ§åˆ¶ (should_continue_planning):
æ£€æŸ¥ current_plan_index æ˜¯å¦å°äº contract_plan çš„é•¿åº¦ã€‚
å¦‚æœæ˜¯ï¼Œè¿”å› draft_from_plan ç»§ç»­èµ·è‰ã€‚
å¦‚æœå¦ï¼Œç»“æŸè§„åˆ’æµç¨‹ã€‚
3.3 é‡æ–°ç”Ÿæˆæµç¨‹ (Re-generation Flow)
3.3.1 ç›®æ ‡
å½“ç”¨æˆ·å¯¹åˆæ¬¡ç”Ÿæˆçš„åˆåŒå†…å®¹ä¸æ»¡æ„æ—¶ï¼Œæä¾›ä¸€ç§é«˜æ•ˆçš„é‡æ–°ç”Ÿæˆæœºåˆ¶ï¼Œæ— éœ€é‡å¤æ‰§è¡Œå®Œæ•´çš„åˆ†æå’ŒåŒ¹é…æµç¨‹ï¼Œä»…åŸºäºç”¨æˆ·çš„ä¿®æ”¹æˆ–è¡¥å……ä¿¡æ¯é‡æ–°èµ·è‰åˆåŒã€‚

3.3.2 è§¦å‘æ¡ä»¶
ç”¨æˆ·åœ¨å‰ç«¯ç•Œé¢ä¸Šç¼–è¾‘äº†å·²ç”Ÿæˆçš„åˆåŒå†…å®¹ã€‚
ç”¨æˆ·è¡¥å……äº†æ–°çš„éœ€æ±‚ä¿¡æ¯æˆ–æ¾„æ¸…å›ç­”ã€‚
ç”¨æˆ·ç‚¹å‡»â€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®ã€‚
3.3.3 æ ¸å¿ƒé€»è¾‘
çŠ¶æ€å¤ç”¨ï¼šåç«¯ API (/regenerate æˆ– /update-and-regenerate) æ¥æ”¶ç”¨æˆ·çš„ä¿®æ”¹å†…å®¹å’Œè¡¥å……ä¿¡æ¯ã€‚å®ƒä¼šå¤ç”¨å­˜å‚¨åœ¨åç«¯ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ session_id æˆ– task_idï¼‰æˆ–å‰ç«¯ä¼ å›çš„ state ä¸­çš„å…³é”®ä¸­é—´ç»“æœï¼š
analysis_result
knowledge_graph_features
template_match_result (å¦‚æœä¹‹å‰åŒ¹é…åˆ°æ¨¡æ¿)
generation_strategy
template_content (å¦‚æœä¹‹å‰åŠ è½½äº†æ¨¡æ¿)
reference_content (å¦‚æœä¹‹å‰ä¸Šä¼ äº†æ–‡ä»¶)
å†…å®¹åˆå¹¶ï¼šå°†ç”¨æˆ·çš„æ–°è¾“å…¥ï¼ˆä¿®æ”¹å†…å®¹/è¡¥å……ä¿¡æ¯ï¼‰ä¸å¤ç”¨çš„çŠ¶æ€ä¿¡æ¯è¿›è¡Œåˆå¹¶æˆ–æ›´æ–°ã€‚
è§¦å‘èµ·è‰ï¼šç›´æ¥è°ƒç”¨å¯¹åº”çš„èµ·è‰èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š
å¦‚æœæ˜¯å•ä¸€åˆåŒï¼Œè°ƒç”¨ draft_single_contractã€‚
å¦‚æœæ˜¯å˜æ›´/è§£é™¤ï¼Œè°ƒç”¨ draft_modification_agreement æˆ– draft_termination_agreementã€‚
å¦‚æœæ˜¯åˆåŒè§„åˆ’ä¸­çš„æŸä¸€ä»½ï¼Œè°ƒç”¨ draft_from_planã€‚
è¿”å›æ–°ç»“æœï¼šå°†é‡æ–°èµ·è‰åçš„å†…å®¹è¿”å›ç»™å‰ç«¯è¿›è¡Œå±•ç¤ºã€‚

ğŸš€ 4. å¼€å‘ä»»åŠ¡æ¸…å• (Roadmap)
é˜¶æ®µä¸€ï¼šå¤šæ¨¡å‹è§„åˆ’é›†æˆ (High Priority)
ä»»åŠ¡ 1.1: ä¿®æ”¹ workflow.py - æ·»åŠ å†³ç­–èŠ‚ç‚¹
å®ç° decide_planning_method è·¯ç”±å‡½æ•°ã€‚
å®ç° plan_contracts_multi_model èŠ‚ç‚¹å‡½æ•°ï¼Œè°ƒç”¨ MultiModelContractPlanningService å’Œ PlanningSolutionEvaluatorã€‚
ä¿®æ”¹ build_workflow å‡½æ•°ï¼Œå°†æ–°èŠ‚ç‚¹å’Œè·¯ç”±é€»è¾‘åŠ å…¥ã€‚
ä»»åŠ¡ 1.2: ä¿®æ”¹ API è·¯ç”± - æ¥æ”¶è§„åˆ’æ¨¡å¼
ä¿®æ”¹ AnalyzeAndGetFormRequest å’Œ GenerateWithFormDataRequest æ¨¡å‹ï¼Œæ·»åŠ  planning_mode: Literal["single_model", "multi_model"] = "single_model"ã€‚
ä¿®æ”¹ analyze_and_get_clarification_form å’Œ generate_with_form_data ç«¯ç‚¹ï¼Œæ¥æ”¶å¹¶ä¼ é€’ planning_modeã€‚
ä¿®æ”¹ generate_contract_simple å‡½æ•°ç­¾åï¼Œå¢åŠ  planning_mode å‚æ•°ï¼Œå¹¶å°†å…¶å­˜å…¥ initial_stateã€‚
ä»»åŠ¡ 1.3: ä¿®æ”¹ multi_model_planning_service.py - è¯„ä¼°å¹¶é€‰æ‹©
ä¿®æ”¹ plan æ–¹æ³•ï¼Œä½¿å…¶è°ƒç”¨ PlanningSolutionEvaluator è¯„ä¼°å„æ¨¡å‹ç»“æœã€‚
é€‰æ‹©å¾—åˆ†æœ€é«˜çš„æ–¹æ¡ˆ (planning_data)ã€‚
å°†é€‰ä¸­çš„ planning_data è½¬æ¢ä¸º ContractPlanning å¯¹è±¡å¹¶è¿”å›ã€‚
æ›´æ–° _generate_synthesis_report ä»¥åæ˜ â€œè¯„ä¼°å¹¶é€‰æ‹©â€è€Œéâ€œèåˆâ€çš„é€»è¾‘ã€‚
ä»»åŠ¡ 1.4: æµ‹è¯•å¤šæ¨¡å‹è§„åˆ’æµç¨‹
éªŒè¯åœ¨ API ä¸­ä¼ é€’ planning_mode="multi_model" æ—¶ï¼Œå·¥ä½œæµæ­£ç¡®æ‰§è¡Œå¤šæ¨¡å‹è·¯å¾„ã€‚
éªŒè¯å•æ¨¡å‹è·¯å¾„ (planning_mode="single_model") ä»æ­£å¸¸å·¥ä½œã€‚
éªŒè¯è¯„ä¼°å’Œé€‰æ‹©é€»è¾‘æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚
é˜¶æ®µäºŒï¼šå†å²ä»»åŠ¡è®°å½•ä¸ç®¡ç† (High Priority)
ä»»åŠ¡ 2.1: è®¾è®¡ä»»åŠ¡çŠ¶æ€æ¨¡å‹
åœ¨ app/models/ ç›®å½•ä¸‹åˆ›å»º contract_generation_task.pyã€‚
å®šä¹‰ ContractGenerationTask æ¨¡å‹ï¼ŒåŒ…å«å­—æ®µï¼š
id: UUID
user_id: åˆ›å»ºä»»åŠ¡çš„ç”¨æˆ·
status: pending, running, paused, waiting_for_input, completed, failed, cancelled
session_data: JSON å­—æ®µï¼Œå­˜å‚¨ LangGraph çš„ checkpoint æˆ–å…³é”® state ä¿¡æ¯ã€‚
result_summary: JSON å­—æ®µï¼Œå­˜å‚¨ç”Ÿæˆç»“æœçš„æ‘˜è¦ï¼ˆå¦‚åˆåŒåˆ—è¡¨ã€æ¾„æ¸…é—®é¢˜ç­‰ï¼‰ã€‚
created_at, updated_at, completed_at: æ—¶é—´æˆ³ã€‚
last_interaction_at: æœ€åä¸€æ¬¡ç”¨æˆ·äº¤äº’æ—¶é—´ã€‚
task_type: åŒºåˆ† single_contract, contract_modification, contract_termination, contract_planningã€‚
celery_task_id: (å¯é€‰) å…³è”çš„ Celery ä»»åŠ¡ IDã€‚
ä»»åŠ¡ 2.2: ä¿®æ”¹ Celery ä»»åŠ¡ (contract_generation_tasks.py)
åœ¨ä»»åŠ¡å¼€å§‹æ—¶ï¼Œæ ¹æ® user_id å’Œ session_id (æˆ–åˆ›å»ºæ–°çš„) åˆ›å»ºæˆ–æ›´æ–°æ•°æ®åº“ä¸­çš„ ContractGenerationTask è®°å½•ï¼ŒçŠ¶æ€è®¾ä¸º runningã€‚
åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å·¥ä½œæµçŠ¶æ€æ›´æ–° session_data å’Œ status (ä¾‹å¦‚ï¼Œè¿›å…¥æ¾„æ¸…ç¯èŠ‚æ—¶è®¾ä¸º waiting_for_input)ã€‚
åœ¨ä»»åŠ¡ç»“æŸæ—¶ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œæ›´æ–° status, result_summary, completed_atï¼Œå¹¶ä¿å­˜æœ€ç»ˆçš„ session_dataã€‚
å¦‚æœä»»åŠ¡éœ€è¦æš‚åœç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œä¿å­˜å½“å‰ state åˆ° session_dataï¼Œå¹¶è®¾ç½® status ä¸º paused æˆ– waiting_for_inputã€‚
ä»»åŠ¡ 2.3: åˆ›å»ºä»»åŠ¡ç®¡ç† API ç«¯ç‚¹
GET /api/contract-generation/tasks: è·å–ç”¨æˆ·çš„å†å²ä»»åŠ¡åˆ—è¡¨ (åˆ†é¡µ)ã€‚
GET /api/contract-generation/tasks/{task_id}: è·å–ç‰¹å®šä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬ session_dataã€result_summaryï¼‰ã€‚
DELETE /api/contract-generation/tasks/{task_id}: åˆ é™¤ä»»åŠ¡è®°å½•ã€‚
PUT /api/contract-generation/tasks/{task_id}/resume: æ¢å¤æš‚åœçš„ä»»åŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼Œå°† session_data ä¼ å›ç»™å·¥ä½œæµç»§ç»­æ‰§è¡Œï¼‰ã€‚
POST /api/contract-generation/tasks/{task_id}/provide-input: ç”¨æˆ·æä¾›æ¾„æ¸…ä¿¡æ¯ï¼Œè§¦å‘ä»»åŠ¡ç»§ç»­æ‰§è¡Œã€‚
ä»»åŠ¡ 2.4: ä¿®æ”¹ä¸»ç”Ÿæˆ API (contract_generation_router.py)
åœ¨ generate_contract ç«¯ç‚¹ä¸­ï¼Œå¦‚æœå¯ç”¨äº† Celeryï¼Œé™¤äº†è¿”å› task_idï¼Œè¿˜åº”ç¡®ä¿åœ¨æ•°æ®åº“ä¸­åˆ›å»ºäº†å¯¹åº”çš„ ContractGenerationTask è®°å½•ã€‚
è€ƒè™‘ä¸ºåŒæ­¥æ¨¡å¼ä¹Ÿåˆ›å»ºä»»åŠ¡è®°å½•ï¼Œä»¥ä¾¿ç»Ÿä¸€ç®¡ç†ã€‚
ä»»åŠ¡ 2.5: å‰ç«¯é€‚é…
åˆ›å»ºâ€œå†å²ä»»åŠ¡â€é¡µé¢ï¼Œå±•ç¤ºç”¨æˆ·çš„å†å²ä»»åŠ¡åˆ—è¡¨ï¼ˆçŠ¶æ€ã€ç±»å‹ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰ã€‚
åœ¨ä»»åŠ¡åˆ—è¡¨é¡¹ä¸­æä¾›â€œæŸ¥çœ‹â€ã€â€œç»§ç»­â€ã€â€œåˆ é™¤â€ç­‰æ“ä½œæŒ‰é’®ã€‚
â€œæŸ¥çœ‹â€æ—¶ï¼ŒåŠ è½½ä»»åŠ¡è¯¦æƒ…å’Œç»“æœã€‚
â€œç»§ç»­â€æ—¶ï¼Œå¦‚æœä»»åŠ¡æ˜¯æš‚åœçŠ¶æ€ï¼Œè°ƒç”¨ resume APIï¼›å¦‚æœæ˜¯ waiting_for_input çŠ¶æ€ï¼Œæ˜¾ç¤ºæ¾„æ¸…è¡¨å•ï¼Œç”¨æˆ·æäº¤åè°ƒç”¨ provide-input APIã€‚
é˜¶æ®µä¸‰ï¼šé•¿æ¨¡æ¿ä¼˜åŒ– (Medium Priority)
ä»»åŠ¡ 3.1: è®¾è®¡æ¨¡æ¿ç»“æ„åŒ–æ‘˜è¦
å®šä¹‰æ¨¡æ¿æ‘˜è¦çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ä¸»è¦æ¡æ¬¾æ¡†æ¶ã€å…³é”®å ä½ç¬¦ç­‰ï¼‰ã€‚
ç¡®å®šæ‘˜è¦ç”Ÿæˆçš„è§„åˆ™æˆ– AI æ¨¡å‹ã€‚
ä»»åŠ¡ 3.2: ä¿®æ”¹ template_loader.py
å¢åŠ åŠ è½½æ¨¡æ¿ç»“æ„åŒ–æ‘˜è¦çš„åŠŸèƒ½ã€‚
ä¿®æ”¹æ¥å£ï¼Œä½¿å…¶èƒ½è¿”å›åŸå§‹å†…å®¹å’Œæ‘˜è¦ã€‚
ä»»åŠ¡ 3.3: ä¿®æ”¹ contract_drafter.py
ä¿®æ”¹ _draft_with_template_new æ–¹æ³•ï¼Œä½¿å…¶èƒ½å¤Ÿæ¥æ”¶ç»“æ„åŒ–æ‘˜è¦ä»£æ›¿åŸå§‹é•¿æ–‡æœ¬ã€‚
è°ƒæ•´æç¤ºè¯ï¼ŒæŒ‡å¯¼ AI åŸºäºæ‘˜è¦å’Œç”¨æˆ·éœ€æ±‚è¿›è¡Œæ”¹å†™ã€‚
ä»»åŠ¡ 3.4: æµ‹è¯•é•¿æ¨¡æ¿å¤„ç†
éªŒè¯å¯¹å¤§å‹åˆåŒï¼ˆå¦‚å»ºå·¥åˆåŒï¼‰çš„å¤„ç†èƒ½åŠ›æå‡ã€‚
é˜¶æ®µå››ï¼šé‡æ–°ç”ŸæˆåŠŸèƒ½ (Medium Priority)
ä»»åŠ¡ 4.1: è®¾è®¡é‡æ–°ç”Ÿæˆ API
å®šä¹‰ /regenerate æˆ– /update-and-regenerate ç«¯ç‚¹ã€‚
ç¡®å®š API æ¥æ”¶çš„å‚æ•°ï¼ˆtask_id/session_id ç”¨äºè·å–çŠ¶æ€ï¼Œnew_input/updated_contentï¼Œuser_corrections ç­‰ï¼‰ã€‚
ä»»åŠ¡ 4.2: å®ç°çŠ¶æ€ç®¡ç†ä¸æ¢å¤
åˆ©ç”¨ é˜¶æ®µäºŒ ä¸­å®ç°çš„ ContractGenerationTask æ¨¡å‹å’Œæ•°æ®åº“è®°å½•ï¼Œæ ¹æ® task_id è·å–ä¹‹å‰çš„çŠ¶æ€ (session_data)ã€‚
å®ç° API ç«¯ç‚¹é€»è¾‘ï¼Œæ ¹æ® task_id è·å–ä¹‹å‰çš„çŠ¶æ€ã€‚
ä»»åŠ¡ 4.3: ä¿®æ”¹å·¥ä½œæµï¼Œæ”¯æŒé‡æ–°ç”Ÿæˆå…¥å£
åœ¨ workflow.py ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„å…¥å£èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ resume_generation æˆ– regenerate_from_stateï¼‰ã€‚
æ ¹æ® state["processing_type"] å’Œ state["current_plan_index"] ç­‰ä¿¡æ¯ï¼Œç›´æ¥è·³è½¬åˆ°å¯¹åº”çš„èµ·è‰èŠ‚ç‚¹ï¼ˆdraft_single_contract, draft_modification_agreement, draft_termination_agreement, draft_from_planï¼‰ã€‚
ç¡®ä¿èµ·è‰èŠ‚ç‚¹èƒ½å¤Ÿæ¥æ”¶æ¥è‡ªé‡æ–°ç”Ÿæˆæµç¨‹çš„è¾“å…¥ï¼ˆå¯èƒ½éœ€è¦ä¿®æ”¹èµ·è‰èŠ‚ç‚¹çš„è¾“å…¥å‚æ•°ï¼‰ã€‚
ä»»åŠ¡ 4.4: å‰ç«¯é€‚é…
åœ¨åˆåŒå±•ç¤ºåŒºåŸŸæ·»åŠ â€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®ã€‚
åœ¨ç”¨æˆ·ç¼–è¾‘å†…å®¹æˆ–è¡¥å……ä¿¡æ¯åï¼Œæä¾›â€œä¿å­˜å¹¶é‡æ–°ç”Ÿæˆâ€çš„é€‰é¡¹ã€‚
è°ƒç”¨æ–°çš„é‡æ–°ç”Ÿæˆ APIï¼Œå¹¶å¤„ç†è¿”å›çš„æ–°å†…å®¹ã€‚
é˜¶æ®µäº”ï¼šæ–‡æ¡£ç”Ÿæˆé›†æˆ (Medium Priority)
ä»»åŠ¡ 5.1: åˆ†æ unified_document_service.py æ¥å£
ç¡®è®¤ get_unified_document_service() è¿”å›çš„æœåŠ¡å¯¹è±¡ã€‚
æ‰¾åˆ° process æ–¹æ³•æˆ–ç±»ä¼¼çš„ç”Ÿæˆ Word/PDF çš„æ–¹æ³•ã€‚
ç¡®è®¤å…¶ process æ–¹æ³•çš„è¾“å…¥å‚æ•°ï¼ˆå¦‚ content, doc_type, output_format, filenameï¼‰ã€‚
ä»»åŠ¡ 5.2: ä¿®æ”¹ contract_generation_router.py - æ·»åŠ æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹
åˆ›å»ºæ–°çš„ç«¯ç‚¹ï¼Œä¾‹å¦‚ POST /api/contract-generation/generate-documentsã€‚
è¯¥ç«¯ç‚¹æ¥æ”¶ä»»åŠ¡ ID æˆ–ç”Ÿæˆçš„åˆåŒå†…å®¹ (contracts) ä½œä¸ºè¾“å…¥ã€‚
è°ƒç”¨ unified_document_service.process æ–¹æ³•ï¼Œå°†æ¯ä¸ª contract.content è½¬æ¢ä¸º Word æˆ– PDFã€‚
è¿”å›ç”Ÿæˆæ–‡ä»¶çš„è·¯å¾„æˆ–ä¸‹è½½é“¾æ¥ã€‚
ä»»åŠ¡ 5.3: å‰ç«¯é€‚é…
åœ¨åˆåŒç”Ÿæˆç»“æœå±•ç¤ºé¡µé¢ï¼Œä¸ºæ¯ä»½ç”Ÿæˆçš„åˆåŒæ·»åŠ â€œç”Ÿæˆ Wordâ€å’Œâ€œç”Ÿæˆ PDFâ€æŒ‰é’®ã€‚
ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè°ƒç”¨åç«¯ generate-documents APIã€‚
API è¿”å›æ–‡ä»¶é“¾æ¥åï¼Œæä¾›â€œé¢„è§ˆâ€æˆ–â€œä¸‹è½½â€é€‰é¡¹ã€‚
é˜¶æ®µå…­ï¼šå‰ç«¯é€‚é… (Medium Priority)
ä»»åŠ¡ 6.1: ä¿®æ”¹ ContractGenerationPage.tsx - æ·»åŠ è§„åˆ’æ¨¡å¼é€‰æ‹©
åœ¨åˆåŒè§„åˆ’åœºæ™¯çš„è¡¨å•æˆ–ç¡®è®¤æ­¥éª¤ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªé€‰æ‹©å™¨ï¼ˆRadio Button æˆ– Dropdownï¼‰ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©â€œå•æ¨¡å‹è§„åˆ’â€æˆ–â€œå¤šæ¨¡å‹è§„åˆ’â€ã€‚
é»˜è®¤é€‰æ‹©â€œå•æ¨¡å‹è§„åˆ’â€ã€‚
å°†ç”¨æˆ·çš„é€‰æ‹© (single_model / multi_model) ä½œä¸º planning_mode å‚æ•°å‘é€ç»™åç«¯ API (/analyze-and-get-form, /generate-with-form, /generate)ã€‚
ä»»åŠ¡ 6.2: ä¿®æ”¹ ContractGenerationPage.tsx - ä¼˜åŒ– UI æç¤º
ä¸ºâ€œå¤šæ¨¡å‹è§„åˆ’â€é€‰é¡¹æ·»åŠ è¯´æ˜æ–‡å­—ï¼Œä¾‹å¦‚ï¼šâ€œè€—æ—¶è¾ƒé•¿ï¼Œä½†ç»“æœæ›´ä¼˜â€ã€‚
ä»»åŠ¡ 6.3: åˆ›å»º HistoryPage.tsx
å®ç°â€œå†å²ä»»åŠ¡â€é¡µé¢ï¼Œè°ƒç”¨ /api/contract-generation/tasks API è·å–åˆ—è¡¨ã€‚
å±•ç¤ºä»»åŠ¡çŠ¶æ€ã€ç±»å‹ã€æ—¶é—´ç­‰ä¿¡æ¯ã€‚
å®ç°â€œæŸ¥çœ‹â€ã€â€œç»§ç»­â€ã€â€œåˆ é™¤â€ç­‰æ“ä½œçš„äº¤äº’é€»è¾‘ã€‚
é˜¶æ®µä¸ƒï¼šä¼˜åŒ–ä¸å®Œå–„ (Low Priority)
ä»»åŠ¡ 7.1: æ¸…ç†æœªä½¿ç”¨çš„ä»£ç 
å®¡æŸ¥ agents/ ç›®å½•ä¸‹æœªè¢«ä¸»æµç¨‹è°ƒç”¨çš„æ–‡ä»¶ï¼ˆå¦‚ single_contract_generation_service.py, contract_modification_service.py ç­‰ï¼‰ï¼Œç¡®è®¤æ˜¯å¦å¯ä»¥å®‰å…¨åˆ é™¤ã€‚
ä»»åŠ¡ 7.2: LLM å®¢æˆ·ç«¯å•ä¾‹åŒ–
å°† workflow.py ä¸­çš„ _get_llm() å‡½æ•°é‡æ„ä¸ºä¾èµ–æ³¨å…¥æˆ–å•ä¾‹æ¨¡å¼ï¼Œé¿å…é‡å¤åˆå§‹åŒ–ã€‚
ä»»åŠ¡ 7.3: é›†æˆ RAG æ£€ç´¢ä¸ç‰©ç†æ¨¡æ¿åŠ è½½
æ¢ç´¢åœ¨ workflow.py ä¸­ç»“åˆ RAG æ£€ç´¢ (template_retriever.py) å’Œç‰©ç†æ¨¡æ¿åŠ è½½ (template_loader.py)ï¼Œä¾‹å¦‚å…ˆ RAG æ£€ç´¢ï¼Œè‹¥åˆ†æ•°é«˜åˆ™åŠ è½½å…¶æ–‡ä»¶ï¼Œå¦åˆ™å›é€€åˆ°ç»“æ„åŒ–åŒ¹é…ã€‚
ä»»åŠ¡ 7.4: SKILL/Tool æ”¹é€  (Future Consideration)
è¯„ä¼°å°†æ ¸å¿ƒ Agent åŠŸèƒ½åŒ…è£…ä¸º LangChain Tool çš„å¯è¡Œæ€§ï¼Œä¸ºæœªæ¥æ›´å¤æ‚çš„ LLM è‡ªä¸»å†³ç­–åœºæ™¯åšå‡†å¤‡ã€‚


ğŸ§ª 5. æµ‹è¯•è®¡åˆ’
5.1 å•å…ƒæµ‹è¯•
workflow.py ä¸­å„èŠ‚ç‚¹å‡½æ•°çš„é€»è¾‘ã€‚
requirement_analyzer.py, contract_drafter.py ç­‰ Agent çš„æ ¸å¿ƒæ–¹æ³•ã€‚
multi_model_planning_service.py å’Œ planning_solution_evaluator.py çš„æ ¸å¿ƒé€»è¾‘ã€‚
5.2 é›†æˆæµ‹è¯•
å•æ¨¡å‹è§„åˆ’æµç¨‹ç«¯åˆ°ç«¯ã€‚
å¤šæ¨¡å‹è§„åˆ’æµç¨‹ç«¯åˆ°ç«¯ã€‚
å•ä¸€åˆåŒç”Ÿæˆï¼ˆæ¨¡æ¿åŒ¹é…å’Œæ— æ¨¡æ¿ï¼‰ç«¯åˆ°ç«¯ã€‚
å˜æ›´/è§£é™¤æµç¨‹ç«¯åˆ°ç«¯ã€‚
é‡æ–°ç”Ÿæˆæµç¨‹ç«¯åˆ°ç«¯ã€‚
API è·¯ç”±ä¸å·¥ä½œæµçš„é›†æˆã€‚
5.3 æ€§èƒ½æµ‹è¯•
å¤šæ¨¡å‹è§„åˆ’çš„è€—æ—¶è¯„ä¼°ã€‚
å¤§æ–‡ä»¶ä¸Šä¼ æ—¶çš„å¼‚æ­¥å¤„ç†æ€§èƒ½ã€‚
é•¿æ¨¡æ¿å¤„ç†çš„æ€§èƒ½ã€‚
ğŸ“š 6. é™„å½•
6.1 çŠ¶æ€å®šä¹‰ (ContractGenerationState)
(å‚è€ƒ workflow.py ä¸­çš„ TypedDict å®šä¹‰)

6.2 API ç«¯ç‚¹åˆ—è¡¨
(å‚è€ƒ contract_generation_router.py ä¸­çš„ @router è£…é¥°å™¨)