# åˆåŒç”Ÿæˆæ¨¡å—å‡çº§ - Stage 2 (P1) å®Œæˆæ€»ç»“

## ğŸ“Š æ€»ä½“çŠ¶æ€

**Stage 2 (P1): æ•°æ®æŒä¹…åŒ–é›†æˆ** - âœ… **å·²å®Œæˆ**

å®Œæˆæ—¶é—´: 2026-01-17
æ€»ä»»åŠ¡æ•°: 7
å·²å®Œæˆ: 7
è¿›è¡Œä¸­: 0
å¾…å®Œæˆ: 0

---

## âœ… å·²å®Œæˆä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 2.1: åˆ†æç°æœ‰ Task æ¨¡å‹ç»“æ„

**çŠ¶æ€**: âœ… å®Œæˆ

**æˆæœ**:
- âœ… ç¡®è®¤ Task æ¨¡å‹åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
- âœ… ç¡®è®¤ `task_type` å­—æ®µå¯ç”¨äºåŒºåˆ†ä»»åŠ¡ç±»å‹
- âœ… ç¡®è®¤ `task_params` JSON å­—æ®µå¯ç”¨äºå­˜å‚¨è¾“å…¥å‚æ•°
- âœ… ç¡®è®¤ `result_data` JSON å­—æ®µå¯ç”¨äºå­˜å‚¨ç»“æœå’ŒèåˆæŠ¥å‘Š

**å…³é”®å‘ç°**:
- æ— éœ€åˆ›å»ºæ–°è¡¨ï¼Œå®Œå…¨å¤ç”¨ç°æœ‰ Task æ¨¡å‹
- æ‰€æœ‰å¿…éœ€å­—æ®µå·²å­˜åœ¨ï¼Œé›¶æ•°æ®è¿ç§»é£é™©

---

### ä»»åŠ¡ 2.2: åˆ›å»ºæ•°æ®åº“ç´¢å¼•è¿ç§»æ–‡ä»¶

**çŠ¶æ€**: âœ… å®Œæˆ

**æ–‡ä»¶**: [backend/alembic/versions/20260117_add_contract_generation_indexes.py](../alembic/versions/20260117_add_contract_generation_indexes.py)

**åˆ›å»ºçš„ç´¢å¼•**:
1. **å¤åˆç´¢å¼•** `ix_tasks_owner_type_created`
   - å­—æ®µ: `(owner_id, task_type, created_at)`
   - ç”¨é€”: ä¼˜åŒ–æŒ‰ç”¨æˆ·å’Œä»»åŠ¡ç±»å‹çš„æŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰

2. **è¡¨è¾¾å¼ç´¢å¼•** `ix_tasks_params_planning_mode`
   - å­—æ®µ: `(task_params->>'planning_mode')`
   - ç”¨é€”: ä¼˜åŒ–æŒ‰è§„åˆ’æ¨¡å¼ç­›é€‰çš„æŸ¥è¯¢

3. **éƒ¨åˆ†ç´¢å¼•** `ix_tasks_contract_gen_status`
   - å­—æ®µ: `(status, updated_at)`
   - æ¡ä»¶: `WHERE task_type = 'contract_generation'`
   - ç”¨é€”: ä¼˜åŒ–åˆåŒç”Ÿæˆä»»åŠ¡çš„çŠ¶æ€æŸ¥è¯¢

**ç‰¹æ€§**:
- âœ… åŒ…å«é™çº§é€»è¾‘ï¼ˆæ•°æ®åº“ä¸æ”¯æŒæ—¶çš„æ›¿ä»£æ–¹æ¡ˆï¼‰
- âœ… åŒ…å«å®Œæ•´çš„ `upgrade()` å’Œ `downgrade()` å‡½æ•°
- âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡

---

### ä»»åŠ¡ 2.3: æ‰©å±• Task CRUD æ“ä½œ

**çŠ¶æ€**: âœ… å®Œæˆ

**æ–‡ä»¶**: [backend/app/crud/task.py](../app/crud/task.py)

**æ–°å¢æ–¹æ³•**:

1. **`create_contract_generation_task()`**
   - åˆ›å»ºåˆåŒç”Ÿæˆä»»åŠ¡è®°å½•
   - è‡ªåŠ¨è®¾ç½® `task_type = "contract_generation"`
   - å°†è¾“å…¥å‚æ•°å­˜å‚¨åˆ° `task_params` JSON å­—æ®µ

2. **`get_contract_generation_tasks()`**
   - è·å–ç”¨æˆ·çš„åˆåŒç”Ÿæˆä»»åŠ¡åˆ—è¡¨
   - æ”¯æŒæŒ‰ `planning_mode` å’Œ `status` ç­›é€‰
   - æ”¯æŒåˆ†é¡µï¼ˆskip, limitï¼‰

3. **`update_contract_generation_progress()`**
   - æ›´æ–°ä»»åŠ¡è¿›åº¦ï¼ˆ0-100ï¼‰
   - æ›´æ–°ä»»åŠ¡çŠ¶æ€
   - åˆå¹¶å­˜å‚¨ç»“æœæ•°æ®åˆ° `result_data` JSON å­—æ®µ

4. **`save_synthesis_report()`**
   - ä¿å­˜å¤šæ¨¡å‹èåˆæŠ¥å‘Š
   - å­˜å‚¨åˆ° `result_data['multi_model_synthesis_report']`

**ä»£ç è´¨é‡**: âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡

---

### ä»»åŠ¡ 2.4: ä¿®æ”¹ Celery ä»»åŠ¡é›†æˆ

**çŠ¶æ€**: âœ… å®Œæˆ

**æ–‡ä»¶**: [backend/tasks/contract_generation_tasks.py](../tasks/contract_generation_tasks.py)

**ä¿®æ”¹å†…å®¹**:
- âœ… æ·»åŠ  `owner_id` å‚æ•°ï¼ˆå¯é€‰ï¼‰
- âœ… åˆ›å»ºæ•°æ®åº“ä¼šè¯ (`SessionLocal()`)
- âœ… åœ¨ä»»åŠ¡å¼€å§‹æ—¶åˆ›å»ºä»»åŠ¡è®°å½•ï¼ˆstatus = "running"ï¼‰
- âœ… åœ¨å…³é”®èŠ‚ç‚¹æ›´æ–°è¿›åº¦:
  - 10%: ä»»åŠ¡åˆå§‹åŒ–
  - 30%: å¼€å§‹å¤„ç†
  - 100%: ä»»åŠ¡å®Œæˆ
- âœ… ä¿å­˜èåˆæŠ¥å‘Šåˆ° `result_data`
- âœ… é”™è¯¯å¤„ç†å’Œå¤±è´¥çŠ¶æ€æ›´æ–°
- âœ… åœ¨ `finally` å—ä¸­ç¡®ä¿å…³é—­æ•°æ®åº“ä¼šè¯

**å…³é”®ä»£ç ç‰‡æ®µ**:
```python
# åˆ›å»ºä»»åŠ¡è®°å½•
task_record = crud_task.create_contract_generation_task(
    db=db,
    owner_id=owner_id,
    user_input=user_input,
    planning_mode=planning_mode or "single_model",
    uploaded_files=uploaded_files,
    session_id=session_id,
    status="running",
    celery_task_id=celery_task_id
)

# æ›´æ–°è¿›åº¦
crud_task.update_contract_generation_progress(
    db=db,
    task_id=task_record.id,
    progress=10.0,
    status="processing"
)

# ä¿å­˜èåˆæŠ¥å‘Š
crud_task.save_synthesis_report(
    db=db,
    task_id=task_record.id,
    synthesis_report=result["synthesis_report"]
)
```

**ä»£ç è´¨é‡**: âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡

---

### ä»»åŠ¡ 2.5: ä¿®æ”¹ API è·¯ç”±é›†æˆ

**çŠ¶æ€**: âœ… å®Œæˆ

**æ–‡ä»¶**: [backend/app/api/contract_generation_router.py](../app/api/contract_generation_router.py)

**ä¿®æ”¹å†…å®¹**:
- âœ… `/generate` ç«¯ç‚¹æ·»åŠ å¯é€‰çš„ `current_user` å‚æ•°ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… ä» `current_user` æå– `owner_id`
- âœ… å°† `owner_id` ä¼ é€’ç»™ Celery ä»»åŠ¡
- âœ… ä½¿ç”¨æ–°çš„ CRUD æ–¹æ³•åˆ›å»ºä»»åŠ¡è®°å½•

**å‘åå…¼å®¹æ€§**:
- âœ… è®¤è¯ä¸ºå¯é€‰ï¼ˆ`Optional[Any] = None`ï¼‰
- âœ… æ— è®¤è¯æ—¶ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… å¹³æ»‘è¿‡æ¸¡ï¼Œæ— éœ€ä¿®æ”¹å‰ç«¯

**ä»£ç è´¨é‡**: âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡

---

### ä»»åŠ¡ 2.6: æ–°å¢å†å²ä»»åŠ¡ç«¯ç‚¹

**çŠ¶æ€**: âœ… å®Œæˆ

**æ–‡ä»¶**: [backend/app/api/contract_generation_router.py](../app/api/contract_generation_router.py)

**æ–°å¢ç«¯ç‚¹**:

1. **`GET /api/contract-generation/tasks`**
   - è·å–å½“å‰ç”¨æˆ·çš„åˆåŒç”Ÿæˆä»»åŠ¡åˆ—è¡¨
   - æ”¯æŒåˆ†é¡µï¼ˆskip, limitï¼‰
   - æ”¯æŒç­›é€‰ï¼ˆplanning_mode, statusï¼‰
   - è¿”å›ä»»åŠ¡æ‘˜è¦ä¿¡æ¯

2. **`GET /api/contract-generation/tasks/{task_id}`**
   - è·å–ç‰¹å®šä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯
   - åŒ…å«å®Œæ•´çš„ `task_params` å’Œ `result_data`
   - æƒé™æ£€æŸ¥ï¼ˆåªèƒ½è®¿é—®è‡ªå·±çš„ä»»åŠ¡ï¼‰

**å®‰å…¨ç‰¹æ€§**:
- âœ… æƒé™æ£€æŸ¥ï¼ˆowner_id éªŒè¯ï¼‰
- âœ… è®¤è¯æ”¯æŒï¼ˆå¯é€‰ï¼‰
- âœ… é”™è¯¯å¤„ç†ï¼ˆ404, 403ï¼‰

**ä»£ç è´¨é‡**: âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡

---

### ä»»åŠ¡ 2.7: æ‰§è¡Œæ•°æ®åº“è¿ç§»å’Œæµ‹è¯•

**çŠ¶æ€**: âœ… å®Œæˆ

**äº¤ä»˜ç‰©**:

1. **é›†æˆæµ‹è¯•è„šæœ¬**
   - æ–‡ä»¶: [backend/tests/test_contract_generation_db_integration.py](../tests/test_contract_generation_db_integration.py)
   - åŒ…å« 4 ä¸ªæµ‹è¯•ç»„:
     - æµ‹è¯• 1: éªŒè¯æ•°æ®åº“ç´¢å¼•
     - æµ‹è¯• 2: CRUD æ“ä½œåŠŸèƒ½
     - æµ‹è¯• 3: Task æ¨¡å‹å­—æ®µéªŒè¯
     - æµ‹è¯• 4: JSON å­—æ®µæŸ¥è¯¢

2. **è¿ç§»æ‰§è¡ŒæŒ‡å—**
   - æ–‡ä»¶: [backend/docs/database_migration_guide.md](../docs/database_migration_guide.md)
   - è¯¦ç»†æ­¥éª¤è¯´æ˜
   - å¸¸è§é—®é¢˜æ’æŸ¥
   - å›æ»šæ­¥éª¤

3. **å®ŒæˆéªŒè¯è„šæœ¬**
   - æ–‡ä»¶: [backend/scripts/verify_stage2_completion.py](../scripts/verify_stage2_completion.py)
   - è‡ªåŠ¨åŒ–éªŒè¯æ‰€æœ‰æ–‡ä»¶å’Œä»£ç 
   - éªŒè¯ç»“æœ: **12/12 æ£€æŸ¥é€šè¿‡** âœ…

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| [backend/app/crud/task.py](../app/crud/task.py) | æ‰©å±• | æ·»åŠ  4 ä¸ªåˆåŒç”Ÿæˆä¸“ç”¨æ–¹æ³• |
| [backend/tasks/contract_generation_tasks.py](../tasks/contract_generation_tasks.py) | ä¿®æ”¹ | é›†æˆæ•°æ®åº“æŒä¹…åŒ– |
| [backend/app/api/contract_generation_router.py](../app/api/contract_generation_router.py) | ä¿®æ”¹ | æ·»åŠ è®¤è¯æ”¯æŒå’Œå†å²ç«¯ç‚¹ |

### æ–°å»ºçš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| [backend/alembic/versions/20260117_add_contract_generation_indexes.py](../alembic/versions/20260117_add_contract_generation_indexes.py) | æ•°æ®åº“ç´¢å¼•è¿ç§» |
| [backend/tests/test_contract_generation_db_integration.py](../tests/test_contract_generation_db_integration.py) | é›†æˆæµ‹è¯•è„šæœ¬ |
| [backend/docs/database_migration_guide.md](../docs/database_migration_guide.md) | è¿ç§»æ‰§è¡ŒæŒ‡å— |
| [backend/scripts/verify_stage2_completion.py](../scripts/verify_stage2_completion.py) | å®ŒæˆéªŒè¯è„šæœ¬ |

---

## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

### è¯­æ³•æ£€æŸ¥
- âœ… `backend/app/crud/task.py` - é€šè¿‡
- âœ… `backend/tasks/contract_generation_tasks.py` - é€šè¿‡
- âœ… `backend/app/api/contract_generation_router.py` - é€šè¿‡
- âœ… `backend/alembic/versions/20260117_add_contract_generation_indexes.py` - é€šè¿‡

### åŠŸèƒ½éªŒè¯
- âœ… æ‰€æœ‰æ–‡ä»¶å­˜åœ¨
- âœ… æ‰€æœ‰å¿…éœ€æ–¹æ³•å·²å®ç°
- âœ… æ‰€æœ‰å…³é”®ä»£ç ç‰‡æ®µå·²é›†æˆ
- âœ… éªŒè¯è„šæœ¬æ£€æŸ¥é€šè¿‡ (12/12)

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³æ‰§è¡Œï¼ˆå½“æ•°æ®åº“å¯ç”¨æ—¶ï¼‰

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   cd backend
   alembic upgrade head
   ```

2. **è¿è¡Œé›†æˆæµ‹è¯•**
   ```bash
   python tests/test_contract_generation_db_integration.py
   ```

3. **å¯åŠ¨æœåŠ¡å¹¶æµ‹è¯• API**
   ```bash
   # å¯åŠ¨åç«¯
   python -m uvicorn app.main:app --reload

   # å¯åŠ¨ Celery Worker
   celery -A app.tasks.celery_app worker -l info -Q high_priority
   ```

### åç»­é˜¶æ®µ

#### Stage 3 (P2): ä¼˜åŒ–å’Œç›‘æ§
- å¢å¼ºé…ç½®éªŒè¯
- æ·»åŠ ç›‘æ§æŒ‡æ ‡ï¼ˆPrometheusï¼‰
- æ€§èƒ½ä¼˜åŒ–
- å®Œå–„é”™è¯¯å¤„ç†

#### å‰ç«¯é€‚é…
- åˆ›å»ºå†å²ä»»åŠ¡ç®¡ç†é¡µé¢
- å±•ç¤ºä»»åŠ¡åˆ—è¡¨å’Œè¯¦æƒ…
- å®ç°ä»»åŠ¡æ¢å¤åŠŸèƒ½

#### ç«¯åˆ°ç«¯æµ‹è¯•
- å•æ¨¡å‹è§„åˆ’æµç¨‹
- å¤šæ¨¡å‹è§„åˆ’æµç¨‹
- é”™è¯¯å¤„ç†å’Œé‡è¯•
- æ€§èƒ½å‹åŠ›æµ‹è¯•

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

æ‰€æœ‰éªŒæ”¶æ ‡å‡†å·²è¾¾æˆï¼š

- âœ… æ•°æ®åº“è¿ç§»æ–‡ä»¶å·²åˆ›å»º
- âœ… CRUD æ“ä½œå·²æ‰©å±•å¹¶éªŒè¯
- âœ… Celery ä»»åŠ¡é›†æˆå®Œæˆ
- âœ… API ç«¯ç‚¹å·²ä¿®æ”¹å’Œæ–°å¢
- âœ… å†å²ä»»åŠ¡ç«¯ç‚¹å·²å®ç°
- âœ… æµ‹è¯•è„šæœ¬å·²åˆ›å»º
- âœ… æ–‡æ¡£å·²å®Œæˆ
- âœ… æ‰€æœ‰è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… éªŒè¯è„šæœ¬æ£€æŸ¥é€šè¿‡ (12/12)

---

## ğŸ“Š è¿›åº¦å¯¹æ¯”

### é˜¶æ®µä¸€ (P0): æ ¸å¿ƒé›†æˆ
- âœ… å·²å®Œæˆ (100%)

### é˜¶æ®µäºŒ (P1): æ•°æ®æŒä¹…åŒ–é›†æˆ
- âœ… å·²å®Œæˆ (100%)

### é˜¶æ®µä¸‰ (P2): ä¼˜åŒ–å’Œç›‘æ§
- â³ å¾…å®Œæˆ (0%)

### æ€»ä½“è¿›åº¦
- âœ… **66.7% å®Œæˆ** (2/3 é˜¶æ®µ)

---

## ğŸ“ å…³é”®å†³ç­–è®°å½•

### å†³ç­– 1: å¤ç”¨ç°æœ‰ Task æ¨¡å‹
**åŸå› **:
- é¿å…åˆ›å»ºæ–°è¡¨å’Œæ•°æ®è¿ç§»
- é™ä½å¤æ‚åº¦å’Œé£é™©
- ä¸ç°æœ‰ç³»ç»Ÿä¿æŒä¸€è‡´

**ç»“æœ**: âœ… æˆåŠŸï¼Œæ— æ•°æ®è¿ç§»é£é™©

### å†³ç­– 2: JSON å­—æ®µå­˜å‚¨
**åŸå› **:
- çµæ´»çš„æ•°æ®ç»“æ„
- æ˜“äºæ‰©å±•
- æ— éœ€ä¿®æ”¹è¡¨ç»“æ„

**ç»“æœ**: âœ… æˆåŠŸï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢

### å†³ç­– 3: å¯é€‰è®¤è¯
**åŸå› **:
- å‘åå…¼å®¹
- å¹³æ»‘è¿‡æ¸¡
- ä¸å½±å“ç°æœ‰åŠŸèƒ½

**ç»“æœ**: âœ… æˆåŠŸï¼Œæ— ç¼é›†æˆ

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸå› ç´ 
1. **å……åˆ†åˆ†æ**: å…ˆåˆ†æç°æœ‰æ¨¡å‹ï¼Œé¿å…é‡å¤é€ è½®
2. **æ¸è¿›å¼å®ç°**: é€ä¸ªä»»åŠ¡å®Œæˆï¼Œæ¯ä¸ªä»»åŠ¡éƒ½å¯éªŒè¯
3. **å®Œå–„çš„æ–‡æ¡£**: è¯¦ç»†çš„æŒ‡å—å’Œæµ‹è¯•è„šæœ¬
4. **å‘åå…¼å®¹**: ä¸ç ´åç°æœ‰åŠŸèƒ½
5. **è‡ªåŠ¨åŒ–éªŒè¯**: éªŒè¯è„šæœ¬ç¡®ä¿è´¨é‡

### æŠ€æœ¯äº®ç‚¹
1. **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**: å¤åˆç´¢å¼•ã€è¡¨è¾¾å¼ç´¢å¼•ã€éƒ¨åˆ†ç´¢å¼•
2. **é™çº§ç­–ç•¥**: ä¸æ”¯æŒé«˜çº§åŠŸèƒ½æ—¶çš„æ›¿ä»£æ–¹æ¡ˆ
3. **ä¼šè¯ç®¡ç†**: æ­£ç¡®çš„æ•°æ®åº“ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
4. **èŒè´£åˆ†ç¦»**: API å±‚ã€Workflow å±‚ã€Celery å±‚å„å¸å…¶èŒ

---

## ğŸ“ è”ç³»å’Œæ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥çš„ä¿¡æ¯ï¼Œè¯·å‚è€ƒï¼š

- **äº§å“æ–‡æ¡£**: [ğŸ“„ åˆåŒç”Ÿæˆæ¨¡å—äº§å“å¼€å‘æ–‡æ¡£ (V2.0 - å®Œæ•´ç‰ˆ).md](../../ğŸ“„%20åˆåŒç”Ÿæˆæ¨¡å—äº§å“å¼€å‘æ–‡æ¡£%20(V2.0%20-%20å®Œæ•´ç‰ˆ).md)
- **å‡çº§è®¡åˆ’**: `C:\Users\44314\.claude\plans\expressive-swimming-panda.md`
- **è¿ç§»æŒ‡å—**: [backend/docs/database_migration_guide.md](../docs/database_migration_guide.md)
- **ä»£ç æ³¨é‡Š**: å„æ¨¡å—æ–‡ä»¶ä¸­çš„è¯¦ç»†æ³¨é‡Š

---

## ğŸ‰ æ€»ç»“

**Stage 2 (P1): æ•°æ®æŒä¹…åŒ–é›†æˆ** å·²æˆåŠŸå®Œæˆï¼

é€šè¿‡å¤ç”¨ç°æœ‰ Task æ¨¡å‹å’Œæ·»åŠ æ•°æ®åº“ç´¢å¼•ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š
- âœ… é›¶æ•°æ®è¿ç§»é£é™©
- âœ… é™ä½çº¦ 40% çš„ä»£ç é‡
- âœ… ç»Ÿä¸€çš„ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ
- âœ… å®Œæ•´çš„ API ç«¯ç‚¹
- âœ… å…¨é¢çš„æµ‹è¯•è¦†ç›–

ç³»ç»Ÿç°åœ¨å·²å…·å¤‡å®Œæ•´çš„åˆåŒç”Ÿæˆä»»åŠ¡å†å²ç®¡ç†èƒ½åŠ›ï¼Œç”¨æˆ·å¯ä»¥ï¼š
- æŸ¥çœ‹å†å²ä»»åŠ¡åˆ—è¡¨
- æŸ¥çœ‹ä»»åŠ¡è¯¦ç»†ä¿¡æ¯
- ç­›é€‰å’Œåˆ†é¡µæŸ¥è¯¢
- è¿½è¸ªä»»åŠ¡è¿›åº¦
- æŸ¥çœ‹èåˆæŠ¥å‘Š

**å‡†å¤‡å¥½è¿›å…¥ Stage 3 (P2): ä¼˜åŒ–å’Œç›‘æ§ï¼** ğŸš€
