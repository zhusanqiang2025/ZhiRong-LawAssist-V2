#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
合同审查规则初始化脚本
用于创建企业级审查红线和规则
"""

import sys
import os

# 添加项目根目录到Python路径
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.database import SessionLocal
from app.models.rule import ReviewRule  # ✅ 从 contract.py 移动到独立的 rule.py
from datetime import datetime


# 企业级审查规则（基于四层审查法）
REVIEW_RULES = [
    {
        "name": "预付款比例红线",
        "description": "控制预付款比例，降低资金风险",
        "content": """
【预付款比例红线规则】

1. **基本原则**：预付款比例原则上不得超过合同总额的30%。

2. **特殊情况例外**：
   - 对于大型设备采购或工程建设，经特别批准可放宽至50%
   - 必须有明确的付款节点和验收标准

3. **审查要点**：
   - 检查合同中预付款比例是否超过30%（或经批准的50%）
   - 预付款是否与明确的里程碑或验收条件挂钩
   - 是否存在"全额预付"等高风险条款

4. **风险等级**: Critical（红线）

5. **建议措辞**：
   - "预付款比例过高，建议不超过合同总额的30%"
   - "预付款应与明确的验收节点挂钩"
""",
        "is_active": True
    },
    {
        "name": "争议解决条款",
        "description": "确保争议解决方式对公司有利",
        "content": """
【争议解决条款规则】

1. **优先顺序**：
   - 第一选择：约定在"甲方所在地法院"诉讼
   - 第二选择：约定在特定仲裁委员会（如北京仲裁委员会、上海仲裁委员会）仲裁
   - 禁止接受：被告所在地法院、对方所在地仲裁

2. **审查要点**：
   - 检查争议解决条款是否明确
   - 管辖法院/仲裁机构是否对公司有利
   - 是否存在"或裁或审"等无效约定

3. **风险等级**: High

4. **建议措辞**：
   - "因本合同引起的争议，应提交甲方所在地人民法院诉讼解决"
   - "争议提交北京仲裁委员会，按照申请仲裁时该会现行有效的仲裁规则进行仲裁"
""",
        "is_active": True
    },
    {
        "name": "违约责任完整性",
        "description": "确保双方违约责任对等且具体",
        "content": """
【违约责任完整性规则】

1. **核心原则**：双方违约责任应当对等、具体、可执行。

2. **审查要点**：
   - 是否明确约定了双方的违约情形
   - 违约金计算方式是否具体（如：每日万分之五）
   - 是否存在"甲方不承担违约责任"等不对等条款
   - 违约金是否过高或过低（一般不超过合同总额的30%）

3. **红线预警**：
   - 仅约定乙方违约责任，甲方无违约责任
   - 违约金条款模糊不清（如"承担相应责任"）
   - 免责条款过宽（如"甲方对任何损失不承担责任"）

4. **风险等级**: High（红线预警）

5. **建议措辞**：
   - "双方均应严格履行合同义务，任何一方违约应承担相应违约责任"
   - "违约方应向守约方支付违约金，计算方式为：[具体计算公式]"
""",
        "is_active": True
    },
    {
        "name": "合同性质与类型认定",
        "description": "明确合同法律性质，确保适用正确法规",
        "content": """
【合同性质与类型认定规则】

1. **典型合同类型**（基于《民法典》）：
   - 买卖合同、供用电水气热合同、赠与合同
   - 借款合同、保证合同、租赁合同、融资租赁合同
   - 保理合同、承揽合同、建设工程合同
   - 运输合同、技术合同、保管合同、仓储合同
   - 委托合同、物业服务合同、行纪合同、中介合同、合伙合同

2. **审查要点**：
   - 通读全文，判断合同属于哪种典型合同
   - 如不属于典型合同，应明确其基础法律关系
   - 检查合同名称与实际内容是否一致

3. **特殊风险**：
   - "名为合作实为借贷"：需警惕虚假表示
   - "名为买卖实为融资"：警惕融资性贸易风险

4. **风险等级**: Medium

5. **建议措辞**：
   - "本合同性质为[XXX]合同，应遵循《民法典》关于[XXX]合同的专门规定"
   - "合同名称与内容不一致，建议修改合同名称以反映实际法律关系"
""",
        "is_active": True
    },
    {
        "name": "条款完备性检查",
        "description": "确保核心条款齐备",
        "content": """
【条款完备性检查规则】

1. **必备条款清单**：
   - 标的物/服务内容
   - 数量与质量标准
   - 价款或报酬
   - 履行期限、地点、方式
   - 违约责任
   - 争议解决方式

2. **审查要点**：
   - 逐一核对必备条款是否齐备
   - 检查是否存在"另行协商"等模糊表述导致条款缺失
   - 关键条款是否具体明确

3. **常见缺失**：
   - 质量标准不明确
   - 履行期限模糊
   - 违约责任约定不清

4. **风险等级**: Medium

5. **建议措辞**：
   - "建议补充明确[XXX]的具体标准"
   - "建议约定明确的履行期限"
""",
        "is_active": True
    },
    {
        "name": "条款逻辑一致性",
        "description": "检查条款间是否存在矛盾或歧义",
        "content": """
【条款逻辑一致性规则】

1. **矛盾检查**：
   - 同一事项在不同条款中表述是否一致
   - 数字、日期、金额等关键信息是否前后一致
   - 权利义务是否对等

2. **常见矛盾类型**：
   - 价格条款：前文"固定总价"，后文"按实结算"
   - 期限条款：前文"1年有效期"，后文"2年质保期"
   - 支付条款：前文"月结"，后文"季结"

3. **歧义检查**：
   - 语言表述是否清晰
   - 是否存在多义词导致理解困难
   - 专业术语是否有定义

4. **风险等级**: Medium

5. **建议措辞**：
   - "条款[XXX]与[YYY]存在矛盾，建议统一"
   - "表述存在歧义，建议明确[XXX]的具体含义"
""",
        "is_active": True
    },
    {
        "name": "金额准确性核查",
        "description": "确保金额表述准确无误",
        "content": """
【金额准确性核查规则】

1. **核查要点**：
   - 大小写金额是否一致
   - 计算公式是否正确
   - 单位是否明确（元/万元/美元）
   - 是否含税（增值税税率）

2. **常见错误**：
   - 大小写不一致
   - 计算错误（如：单价×数量≠总价）
   - 税费承担约定不明

3. **红线预警**：
   - 金额表述模糊（如"相关费用"、"合理费用"）
   - 费用承担方不明确

4. **风险等级**: High（金额错误）

5. **建议措辞**：
   - "大小写金额不一致，请核实"
   - "建议明确费用承担方"
   - "建议明确是否含税及税率"
""",
        "is_active": True
    },
    {
        "name": "主体资格与合法性",
        "description": "确保合同主体具备相应资质",
        "content": """
【主体资格与合法性规则】

1. **审查要点**：
   - 合同主体是否具备签署该类合同的资质
   - 是否需要特殊许可（如建筑资质、特许经营许可）
   - 是否存在超越经营范围的情况

2. **高风险行业**：
   - 建筑工程：需检查建筑业企业资质证书
   - 医疗器械：需检查医疗器械经营许可证
   - 教育培训：需检查办学许可证
   - 金融业务：需检查金融许可证

3. **合法性红线**：
   - 合同内容是否违反法律法规强制性规定
   - 是否存在无效条款（如：排除对方主要权利）
   - 是否违反公序良俗

4. **风险等级**: Critical（红线）

5. **建议措辞**：
   - "建议核实[乙方]是否具备[XXX]资质"
   - "该条款可能因违反[XXX]规定而无效"
""",
        "is_active": True
    },
    {
        "name": "验收与交付条件",
        "description": "确保验收标准明确可执行",
        "content": """
【验收与交付条件规则】

1. **审查要点**：
   - 验收标准是否具体、可衡量
   - 验收程序是否明确
   - 不合格的处理方式是否约定

2. **常见问题**：
   - 验收标准模糊（如"符合行业标准"但未明确具体标准）
   - 验收期限不合理（如"甲方收到后3天内验收"）
   - "视为验收合格"条款过宽

3. **风险等级**: Medium

4. **建议措辞**：
   - "建议约定具体的验收标准"
   - "验收期限应合理，建议至少7个工作日"
   - "慎用'视为验收合格'条款"
""",
        "is_active": True
    },
    {
        "name": "保密与知识产权条款",
        "description": "保护公司核心信息和知识产权",
        "content": """
【保密与知识产权条款规则】

1. **保密条款**：
   - 是否明确约定保密信息的范围
   - 保密期限是否合理（建议不少于合同终止后3年）
   - 违反保密责任的违约责任是否明确

2. **知识产权条款**：
   - 明确合同履行过程中产生的知识产权归属
   - 对于委托开发，应明确约定知识产权归属
   - 避免默认知识产权归对方所有

3. **红线预警**：
   - 无保密条款
   - 知识产权约定不明导致公司权益受损

4. **风险等级**: Medium

5. **建议措辞**：
   - "建议补充保密条款"
   - "建议明确约定本合同产生的知识产权归[甲方]所有"
""",
        "is_active": True
    },
    {
        "name": "解除与终止条款",
        "description": "确保合同解除条件公平合理",
        "content": """
【解除与终止条款规则】

1. **审查要点**：
   - 解除条件是否具体、明确
   - 双方解除权是否对等
   - 合同终止后的处理是否约定

2. **常见问题**：
   - 仅一方享有解除权
   - 解除条件模糊（如"严重影响"未定义）
   - 无合同终止后的善后处理条款

3. **红线预警**：
   - "甲方不得解除本合同"等绝对化条款
   - 解除通知期过短

4. **风险等级**: High

5. **建议措辞**：
   - "建议赋予双方平等的解除权"
   - "建议约定明确的解除条件"
   - "建议补充合同终止后的善后处理条款"
""",
        "is_active": True
    },
    {
        "name": "不可抗力条款",
        "description": "确保不可抗力条款公平合理",
        "content": """
【不可抗力条款规则】

1. **审查要点**：
   - 不可抗力的定义是否合理
   - 通知义务是否明确
   - 减损义务是否约定

2. **常见问题**：
   - 不可抗力范围过窄或过宽
   - 无通知期限约定
   - 未约定减损义务

3. **风险等级**: Low

4. **建议措辞**：
   - "建议补充不可抗力条款"
   - "建议约定明确的不可抗力通知期限（如3日内）"
   - "建议约定不可抗力发生后的减损义务"
""",
        "is_active": True
    },
]


def init_review_rules():
    """初始化审查规则"""
    db = SessionLocal()
    try:
        # 清空现有规则（可选）
        # db.query(ReviewRule).delete()

        print("开始初始化审查规则...")

        created_count = 0
        updated_count = 0

        for rule_data in REVIEW_RULES:
            # 检查是否已存在同名规则
            existing_rule = db.query(ReviewRule).filter(
                ReviewRule.name == rule_data["name"]
            ).first()

            if existing_rule:
                # 更新现有规则
                existing_rule.description = rule_data["description"]
                existing_rule.content = rule_data["content"]
                existing_rule.is_active = rule_data["is_active"]
                updated_count += 1
                print(f"更新规则: {rule_data['name']}")
            else:
                # 创建新规则
                rule = ReviewRule(
                    name=rule_data["name"],
                    description=rule_data["description"],
                    content=rule_data["content"],
                    is_active=rule_data["is_active"],
                    created_at=datetime.utcnow()
                )
                db.add(rule)
                created_count += 1
                print(f"创建规则: {rule_data['name']}")

        db.commit()
        print(f"\n初始化完成！")
        print(f"- 新建规则: {created_count} 条")
        print(f"- 更新规则: {updated_count} 条")

        # 显示所有规则
        print("\n当前数据库中的审查规则:")
        all_rules = db.query(ReviewRule).all()
        for rule in all_rules:
            status = "✓ 启用" if rule.is_active else "✗ 禁用"
            print(f"  [{status}] {rule.name}: {rule.description}")

    except Exception as e:
        print(f"初始化失败: {e}")
        db.rollback()
        raise
    finally:
        db.close()


if __name__ == "__main__":
    init_review_rules()
