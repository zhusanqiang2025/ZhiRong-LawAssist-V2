import{u as ge,r as l,F as r,j as e,d as y,c as Q,C as v,S as p,B as k,T as fe,k as ye,I,q as ve,E as G,h as u,s as n,i as h,p as J,n as Se}from"./index-7T25hRnl.js";import{R as W,k as S}from"./DatabaseOutlined-C7q3oXD2.js";import{R as be}from"./ArrowLeftOutlined-C0dkYYT0.js";import{R as H}from"./UploadOutlined-CD3BBQem.js";import{S as E}from"./index-C60phfr4.js";import{R as U}from"./CheckCircleOutlined-DhhXUuLD.js";import{F as we}from"./Table-D0ZRbJRv.js";import{M as X}from"./index-CNC-4PM3.js";import{P as Y}from"./progress-BFvY0J03.js";import{U as ke}from"./index-Cn333nvA.js";import{P as Ie}from"./index-BhHARTUp.js";import{R as Ce}from"./DeleteOutlined-Bc5d-nRr.js";import{A as N}from"./DownloadOutlined-3LjHRHuZ.js";import{R as Re}from"./CloseCircleOutlined-CMvayiUb.js";import{R as Te}from"./WarningOutlined-CEayjfuK.js";import"./FileOutlined-B8Qj5hup.js";import"./useBubbleLock-rdPKXBE_.js";import"./index-CeAS_E37.js";import"./FolderOpenOutlined-BZWbWWbj.js";import"./PaperClipOutlined-DFi3U0Pa.js";const{Title:_e,Text:m,Paragraph:Ze}=fe,{TextArea:Fe}=I,{Option:i}=u,et=()=>{const Z=ge(),[ee,te]=l.useState([]),[se,P]=l.useState(!1),[o,ae]=l.useState({current:1,pageSize:10,total:0}),[ie,C]=l.useState(!1),[b]=r.useForm(),[x,c]=l.useState(0),[De,$]=l.useState([]),[le,M]=l.useState(!1),[j,B]=l.useState(null),[R,V]=l.useState(null),[ze,T]=l.useState(""),[re,_]=l.useState(!1),[A,ne]=l.useState(null),[F]=r.useForm(),[L,ce]=l.useState(""),[D,oe]=l.useState({total:0,active:0,public:0}),g=async(t=1,s=10)=>{P(!0);try{const a=await S.getUserDocuments({page:t,size:s,search:L||void 0});a.data.success&&(te(a.data.data.items||[]),ae({current:t,pageSize:s,total:a.data.data.total||0}),oe({total:a.data.data.total||0,active:a.data.data.items?.filter(d=>d.status==="active").length||0,public:a.data.data.items?.filter(d=>d.is_public).length||0}))}catch(a){n.error(a.response?.data?.detail||"加载文档失败")}finally{P(!1)}};l.useEffect(()=>{g()},[L]);const de=()=>{$([{title:"上传文件",status:"process"},{title:"内容提取",status:"wait"},{title:"重复检测",status:"wait"},{title:"确认信息",status:"wait"},{title:"完成上传",status:"wait"}]),c(0),B(null),T(""),V(null),b.resetFields(),C(!0)},ue=async t=>{V(t),c(1);try{if(t.size>52428800)return n.error("文件过大，请上传小于50MB的文件"),c(0),!1;const a=t.name.toLowerCase(),w=[".txt",".md",".json",".xml",".csv"].some(z=>a.endsWith(z));let f="";w?(f=await t.text(),T(f)):(f=`[文件: ${t.name}] 由后端DocumentPreprocessor处理`,T(f)),c(2),M(!0);const q=await S.checkDuplicate({title:t.name,content:f,category:b.getFieldValue("category")});B(q.data),$(z=>{const K=[...z];return K[2]={title:"重复检测",status:"finish",content:O(q.data)},K}),c(3)}catch(s){n.error("文件处理失败: "+(s.response?.data?.detail||s.message)),c(0)}finally{M(!1)}return!1},O=t=>{const{is_duplicate:s,similarity:a,recommendation:d,action:w}=t;return w==="block"?e.jsx(N,{type:"error",icon:e.jsx(Re,{}),message:`高度重复（相似度 ${(a*100).toFixed(1)}%）`,description:e.jsxs("div",{children:[e.jsx("p",{children:d}),t.original_item&&e.jsxs("p",{children:["系统已有文档：",e.jsx("strong",{children:t.original_item.title})]})]}),showIcon:!0}):w==="warn"?e.jsx(N,{type:"warning",icon:e.jsx(Te,{}),message:`内容相似（相似度 ${(a*100).toFixed(1)}%）`,description:e.jsxs("div",{children:[e.jsx("p",{children:d}),t.original_item&&e.jsxs("p",{children:["相似文档：",e.jsx("strong",{children:t.original_item.title})]})]}),showIcon:!0}):e.jsx(N,{type:"success",icon:e.jsx(U,{}),message:"检测通过",description:"该内容为独立内容，可以安全上传",showIcon:!0})},xe=async()=>{if(!R){n.warning("请先上传文件");return}if(j?.data.action==="block"){n.warning("该内容与系统知识库高度重复，无法上传");return}c(4);try{const t=await b.validateFields(),s=new FormData;s.append("file",R),t.title&&s.append("title",t.title),t.category&&s.append("category",t.category),t.tags&&s.append("tags",JSON.stringify(t.tags)),t.is_public!==void 0&&s.append("is_public",t.is_public.toString()),await S.uploadUserDocument(s),n.success("文档上传成功"),C(!1),g(o.current,o.pageSize)}catch(t){n.error("上传失败: "+(t.response?.data?.detail||t.message)),c(3)}},pe=t=>{ne(t),F.setFieldsValue({title:t.title,content:t.content,category:t.category,tags:t.tags,is_public:t.is_public}),_(!0)},he=async()=>{if(A)try{const t=await F.validateFields();await S.updateUserDocument(A.id.toString(),{title:t.title,content:t.content,category:t.category,tags:t.tags,is_public:t.is_public}),n.success("文档更新成功"),_(!1),g(o.current,o.pageSize)}catch(t){n.error("更新失败: "+(t.response?.data?.detail||t.message))}},me=async t=>{try{await S.deleteUserDocument(t.toString()),n.success("文档删除成功"),g(o.current,o.pageSize)}catch(s){n.error("删除失败: "+(s.response?.data?.detail||s.message))}},je=[{title:"标题",dataIndex:"title",key:"title",ellipsis:!0,render:(t,s)=>e.jsxs(p,{direction:"vertical",size:0,children:[e.jsx(m,{strong:!0,children:t}),e.jsx(m,{type:"secondary",style:{fontSize:12},children:s.source_type==="upload"?"文件上传":"手动添加"})]})},{title:"分类",dataIndex:"category",key:"category",width:120,render:t=>t?e.jsx(h,{color:"blue",children:t}):"-"},{title:"标签",dataIndex:"tags",key:"tags",width:150,render:t=>t&&t.length>0?e.jsxs(p,{size:4,wrap:!0,children:[t.slice(0,2).map((s,a)=>e.jsx(h,{color:"geekblue",children:s},a)),t.length>2&&e.jsxs(h,{children:["+",t.length-2]})]}):"-"},{title:"可见性",dataIndex:"is_public",key:"is_public",width:100,render:t=>t?e.jsx(h,{color:"green",icon:e.jsx(U,{}),children:"公开"}):e.jsx(h,{color:"default",children:"私有"})},{title:"状态",dataIndex:"status",key:"status",width:100,render:t=>{const a={active:{color:"success",text:"活跃"},archived:{color:"default",text:"归档"},deleted:{color:"error",text:"删除"}}[t]||{color:"default",text:t};return e.jsx(h,{color:a.color,children:a.text})}},{title:"更新时间",dataIndex:"updated_at",key:"updated_at",width:180,render:t=>new Date(t).toLocaleString("zh-CN")},{title:"操作",key:"actions",width:150,fixed:"right",render:(t,s)=>e.jsxs(p,{size:"small",children:[e.jsx(J,{title:"编辑",children:e.jsx(k,{type:"text",icon:e.jsx(Se,{}),onClick:()=>pe(s),disabled:s.status==="deleted"})}),e.jsx(Ie,{title:"确认删除",description:"删除后将无法恢复，是否继续？",onConfirm:()=>me(s.id),okText:"确认",cancelText:"取消",children:e.jsx(J,{title:"删除",children:e.jsx(k,{type:"text",danger:!0,icon:e.jsx(Ce,{}),disabled:s.status==="deleted"})})})]})}];return e.jsxs("div",{className:"user-kb-page",children:[e.jsx(y,{className:"kb-header-card",children:e.jsxs(Q,{align:"middle",justify:"space-between",children:[e.jsx(v,{children:e.jsxs(p,{size:"middle",children:[e.jsx(k,{icon:e.jsx(be,{}),onClick:()=>Z("/"),children:"返回工作台"}),e.jsx(W,{style:{fontSize:24,color:"#1890ff"}}),e.jsxs("div",{children:[e.jsx(_e,{level:3,style:{margin:0},children:"我的知识库"}),e.jsx(m,{type:"secondary",children:"管理您的私有法律知识库内容"})]})]})}),e.jsx(v,{children:e.jsx(k,{type:"primary",icon:e.jsx(H,{}),onClick:de,children:"上传文档"})})]})}),e.jsxs(Q,{gutter:16,style:{marginTop:16},children:[e.jsx(v,{span:8,children:e.jsx(y,{children:e.jsx(E,{title:"文档总数",value:D.total,prefix:e.jsx(ye,{}),valueStyle:{color:"#1890ff"}})})}),e.jsx(v,{span:8,children:e.jsx(y,{children:e.jsx(E,{title:"活跃文档",value:D.active,prefix:e.jsx(U,{}),valueStyle:{color:"#52c41a"}})})}),e.jsx(v,{span:8,children:e.jsx(y,{children:e.jsx(E,{title:"公开文档",value:D.public,prefix:e.jsx(W,{}),valueStyle:{color:"#722ed1"}})})})]}),e.jsxs(y,{style:{marginTop:16},title:"我的文档",children:[e.jsx(p,{style:{marginBottom:16},size:"middle",children:e.jsx(I.Search,{placeholder:"搜索文档标题或内容...",allowClear:!0,style:{width:400},onSearch:ce,prefix:e.jsx(ve,{})})}),e.jsx(we,{columns:je,dataSource:ee,rowKey:"id",loading:se,pagination:{...o,showSizeChanger:!0,showTotal:t=>`共 ${t} 条`,onChange:(t,s)=>g(t,s)},locale:{emptyText:e.jsx(G,{image:G.PRESENTED_IMAGE_SIMPLE,description:e.jsxs("div",{children:[e.jsx("p",{children:"您还没有上传任何文档"}),e.jsx("p",{className:"text-secondary",children:'点击上方"上传文档"按钮开始构建您的知识库'})]})})}})]}),e.jsxs(X,{title:"上传文档到知识库",open:ie,onCancel:()=>C(!1),onOk:xe,okText:"确认上传",cancelText:"取消",width:700,okButtonProps:{disabled:j?.data.action==="block"||x<3},children:[e.jsx("div",{style:{marginBottom:24},children:e.jsx(Y,{percent:x/4*100,status:x===4?"success":"active",strokeColor:{"0%":"#108ee9","100%":"#87d068"}})}),e.jsxs(p,{direction:"vertical",size:"large",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(m,{strong:!0,children:"1. 上传文件"}),e.jsx("div",{style:{marginTop:8},children:e.jsxs(ke.Dragger,{accept:".txt,.md,.doc,.docx,.pdf,.rtf,.odt,.jpg,.jpeg,.png,.bmp,.tiff,.gif",maxCount:1,beforeUpload:ue,fileList:[],disabled:x>=3,children:[e.jsx("p",{className:"ant-upload-drag-icon",children:e.jsx(H,{style:{fontSize:48,color:"#1890ff"}})}),e.jsx("p",{className:"ant-upload-text",children:"点击或拖拽文件到此区域上传"}),e.jsxs("p",{className:"ant-upload-hint",children:["支持 .txt、.md、.doc、.docx、.pdf、.rtf、.odt、.jpg、.png 等格式",e.jsx("br",{}),"文档类文件会自动提取文本，图片文件会自动OCR识别"]})]})})]}),x>=2&&e.jsxs("div",{children:[e.jsx(m,{strong:!0,children:"3. 重复检测结果"}),e.jsx("div",{style:{marginTop:8},children:le?e.jsxs("div",{style:{textAlign:"center",padding:20},children:[e.jsx(Y,{type:"circle",status:"active"}),e.jsx("p",{style:{marginTop:8},children:"正在检测内容重复度..."})]}):j&&O(j.data)})]}),x>=3&&j?.data.action!=="block"&&e.jsxs("div",{children:[e.jsx(m,{strong:!0,children:"4. 确认文档信息"}),e.jsxs(r,{form:b,layout:"vertical",style:{marginTop:8},children:[e.jsx(r.Item,{name:"title",label:"文档标题",initialValue:R?.name,rules:[{required:!0,message:"请输入文档标题"}],children:e.jsx(I,{placeholder:"请输入文档标题"})}),e.jsx(r.Item,{name:"category",label:"分类",children:e.jsxs(u,{placeholder:"选择分类",allowClear:!0,children:[e.jsx(i,{value:"民法",children:"民法"}),e.jsx(i,{value:"合同法",children:"合同法"}),e.jsx(i,{value:"公司法",children:"公司法"}),e.jsx(i,{value:"劳动法",children:"劳动法"}),e.jsx(i,{value:"刑法",children:"刑法"}),e.jsx(i,{value:"行政法",children:"行政法"}),e.jsx(i,{value:"其他",children:"其他"})]})}),e.jsx(r.Item,{name:"tags",label:"标签",children:e.jsx(u,{mode:"tags",placeholder:"输入标签，按回车添加"})}),e.jsx(r.Item,{name:"is_public",label:"可见性",valuePropName:"checked",initialValue:!1,children:e.jsxs(u,{children:[e.jsx(i,{value:!1,children:"私有（仅自己可见）"}),e.jsx(i,{value:!0,children:"公开（团队共享）"})]})})]})]})]})]}),e.jsx(X,{title:"编辑文档",open:re,onCancel:()=>_(!1),onOk:he,okText:"保存",cancelText:"取消",width:700,children:e.jsxs(r,{form:F,layout:"vertical",children:[e.jsx(r.Item,{name:"title",label:"文档标题",rules:[{required:!0,message:"请输入文档标题"}],children:e.jsx(I,{placeholder:"请输入文档标题"})}),e.jsx(r.Item,{name:"content",label:"文档内容",rules:[{required:!0,message:"请输入文档内容"}],children:e.jsx(Fe,{rows:10,placeholder:"请输入文档内容"})}),e.jsx(r.Item,{name:"category",label:"分类",children:e.jsxs(u,{placeholder:"选择分类",allowClear:!0,children:[e.jsx(i,{value:"民法",children:"民法"}),e.jsx(i,{value:"合同法",children:"合同法"}),e.jsx(i,{value:"公司法",children:"公司法"}),e.jsx(i,{value:"劳动法",children:"劳动法"}),e.jsx(i,{value:"刑法",children:"刑法"}),e.jsx(i,{value:"行政法",children:"行政法"}),e.jsx(i,{value:"其他",children:"其他"})]})}),e.jsx(r.Item,{name:"tags",label:"标签",children:e.jsx(u,{mode:"tags",placeholder:"输入标签，按回车添加"})}),e.jsx(r.Item,{name:"is_public",label:"可见性",valuePropName:"checked",children:e.jsxs(u,{children:[e.jsx(i,{value:!1,children:"私有（仅自己可见）"}),e.jsx(i,{value:!0,children:"公开（团队共享）"})]})})]})})]})};export{et as default};
