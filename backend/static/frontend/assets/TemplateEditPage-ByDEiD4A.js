import{r,z as se,_ as ae,aB as te,u as ne,x as re,F as n,s as m,j as e,av as R,e as le,S as w,B as $,T as ie,i as I,b as M,d,c as A,C as l,I as b,p as ce,n as oe,h as x}from"./index-7T25hRnl.js";import{c as u}from"./contractTemplates-BtLBDgE2.js";import{R as de}from"./ArrowLeftOutlined-C0dkYYT0.js";import{A as h}from"./DownloadOutlined-3LjHRHuZ.js";import{R as he}from"./CheckCircleOutlined-DhhXUuLD.js";import{R as xe}from"./InfoCircleOutlined-DoY051zu.js";import{D as pe}from"./index-CxNe3LSK.js";import{D as j}from"./index-CCRVD0dr.js";import{R as O}from"./SyncOutlined-BUyyz6IM.js";import{U as me}from"./index-Cn333nvA.js";import{R as ue}from"./UploadOutlined-CD3BBQem.js";import"./PaperClipOutlined-DFi3U0Pa.js";import"./DeleteOutlined-Bc5d-nRr.js";import"./progress-BFvY0J03.js";var je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M893.3 293.3L730.7 130.7c-7.5-7.5-16.7-13-26.7-16V112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V338.5c0-17-6.7-33.2-18.7-45.2zM384 184h256v104H384V184zm456 656H184V184h136v136c0 17.7 14.3 32 32 32h320c17.7 0 32-14.3 32-32V205.8l136 136V840zM512 442c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 224c-44.2 0-80-35.8-80-80s35.8-80 80-80 80 35.8 80 80-35.8 80-80 80z"}}]},name:"save",theme:"outlined"},ge=function(p,T){return r.createElement(se,ae({},p,{ref:T,icon:je}))},fe=r.forwardRef(ge);const{Header:ye,Content:H}=R,{Title:be,Text:S}=ie,{TextArea:K}=b,{TabPane:F}=M,{Dragger:ve}=me,{Option:a}=x,Le=()=>{const{templateId:o}=te(),p=ne(),{user:T}=re(),[N,k]=r.useState(!0),[P,D]=r.useState(!1),[U,z]=r.useState(!1),[g,q]=r.useState(null),[f,B]=r.useState(null),[G,W]=r.useState([]),[v,V]=r.useState(""),[_,J]=r.useState([]),[i,E]=r.useState(null),[y]=n.useForm(),Q=T?.is_admin||!1;r.useEffect(()=>{if(!Q){m.error("仅管理员可以编辑模板"),p("/contract");return}Y(),X()},[o]);const X=async()=>{try{const s=await u.getCategoryTree();W(s.map(t=>t.name))}catch(s){console.error("加载分类失败:",s)}},Y=async()=>{k(!0);let s;try{if(s=(await u.getTemplates({page:1,page_size:1e3})).templates.find(c=>c.id===o),!s){m.error("模板不存在"),p("/contract");return}q(s);try{if(!o)throw new Error("Template ID is missing");const c=await u.getTemplateContent(o);B({...c,template_id:o,name:s.name,editable:[".docx",".doc",".txt",".md",".rtf"].includes(s.file_type.toLowerCase())}),V(c.content),y.setFieldsValue({name:s.name,category:s.category,subcategory:s.subcategory,description:s.description,is_public:s.is_public,keywords:s.keywords?.join(", ")||"",tags:s.tags?.join(", ")||""}),s.name&&await C(s.name)}catch(c){console.warn("无法加载模板内容:",c),B(null),y.setFieldsValue({name:s.name,category:s.category,subcategory:s.subcategory,description:s.description,is_public:s.is_public,keywords:s.keywords?.join(", ")||"",tags:s.tags?.join(", ")||""}),s.name&&await C(s.name)}}catch(t){console.error("加载模板失败:",t),m.error("加载模板失败")}finally{k(!1)}},C=async s=>{try{z(!0);const t=await u.getLegalFeatures(s);E({matched_contract_type:s,legal_features:t,usage_scenario:t.usage_scenario||"",legal_basis:t.legal_basis||[],match_confidence:1}),t&&y.setFieldsValue({transaction_nature:t.transaction_nature,contract_object:t.contract_object,complexity:t.complexity,stance:t.stance}),m.success("已同步知识图谱法律特征")}catch{console.log("知识图谱中未找到该合同类型的法律特征"),E(null)}finally{z(!1)}},Z=async s=>{if(o){D(!0);try{const t={name:s.name,category:s.category,subcategory:s.subcategory,description:s.description,is_public:s.is_public,keywords:s.keywords,tags:s.tags};if(v&&f?.editable&&v!==f.content&&(t.content=v),_.length>0&&_[0].originFileObj){const c=new FormData;c.append("file",_[0].originFileObj),Object.keys(t).forEach(L=>{c.append(L,t[L])}),await u.updateTemplate(o,c)}else await u.updateTemplate(o,t);m.success("模板已更新"),p("/contract")}catch(t){console.error("保存失败:",t),m.error(t.response?.data?.detail||"保存失败")}finally{D(!1)}}},ee=s=>{J(s.fileList)};return N?e.jsx(R,{style:{minHeight:"100vh",background:"#f0f2f5"},children:e.jsx(H,{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(le,{size:"large",tip:"加载中..."})})}):g?e.jsxs(R,{style:{minHeight:"100vh",background:"#f0f2f5"},children:[e.jsxs(ye,{style:{background:"#fff",padding:"0 24px",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(w,{children:[e.jsx($,{type:"text",icon:e.jsx(de,{}),onClick:()=>p("/contract"),children:"返回"}),e.jsx(be,{level:3,style:{margin:0},children:"编辑模板"}),e.jsx(I,{color:"blue",children:"管理员模式"})]}),e.jsx(w,{children:e.jsx($,{type:"primary",icon:e.jsx(fe,{}),loading:P,onClick:()=>y.submit(),children:"保存更改"})})]}),e.jsxs(H,{style:{padding:"24px",maxWidth:1200,margin:"0 auto",width:"100%"},children:[e.jsx(h,{message:"管理员编辑模式",description:"您正在以管理员身份编辑此模板。您的更改将立即生效。",type:"info",showIcon:!0,icon:e.jsx(he,{}),style:{marginBottom:24}}),e.jsx(n,{form:y,layout:"vertical",onFinish:Z,onValuesChange:s=>{s.name&&C(s.name)},children:e.jsxs(M,{defaultActiveKey:"metadata",children:[e.jsxs(F,{tab:"基本信息",children:[e.jsx(d,{children:e.jsxs(A,{gutter:24,children:[e.jsx(l,{span:12,children:e.jsx(n.Item,{label:"模板名称",name:"name",rules:[{required:!0,message:"请输入模板名称"}],children:e.jsx(b,{placeholder:"请输入模板名称",prefix:e.jsx(oe,{}),suffix:e.jsx(ce,{title:"修改名称后将自动同步知识图谱中的法律特征",children:e.jsx(xe,{style:{color:"#1890ff"}})})})})}),e.jsx(l,{span:12,children:e.jsx(n.Item,{label:"类别",name:"category",rules:[{required:!0,message:"请选择类别"}],children:e.jsx(x,{placeholder:"请选择类别",showSearch:!0,allowClear:!0,children:G.map(s=>e.jsx(a,{value:s,children:s},s))})})}),e.jsx(l,{span:12,children:e.jsx(n.Item,{label:"子类别",name:"subcategory",children:e.jsx(b,{placeholder:"请输入子类别（可选）"})})}),e.jsx(l,{span:12,children:e.jsx(n.Item,{label:"公开状态",name:"is_public",valuePropName:"checked",children:e.jsxs(x,{children:[e.jsx(a,{value:!0,children:"公开"}),e.jsx(a,{value:!1,children:"私有"})]})})}),e.jsx(l,{span:24,children:e.jsx(n.Item,{label:"描述",name:"description",children:e.jsx(K,{rows:3,placeholder:"请输入模板描述"})})}),e.jsx(l,{span:12,children:e.jsx(n.Item,{label:"关键词",name:"keywords",children:e.jsx(b,{placeholder:"用逗号分隔，如: 劳动,合同,员工"})})}),e.jsx(l,{span:12,children:e.jsx(n.Item,{label:"标签",name:"tags",children:e.jsx(b,{placeholder:"用逗号分隔，如: 正式,标准模板"})})})]})}),i?.legal_features&&e.jsxs(d,{title:e.jsxs(w,{children:[e.jsx(O,{spin:U}),e.jsx("span",{children:"知识图谱法律特征"}),e.jsx(I,{color:"green",children:"已同步"})]}),style:{marginTop:16},children:[e.jsx(h,{message:"自动同步",description:"以下法律特征已从知识图谱中自动同步，您也可以手动修改。",type:"success",showIcon:!0,style:{marginBottom:16}}),e.jsxs(A,{gutter:16,children:[e.jsx(l,{span:8,children:e.jsx(n.Item,{label:"交易性质",name:"transaction_nature",children:e.jsxs(x,{placeholder:"选择交易性质",children:[e.jsx(a,{value:"转移所有权",children:"转移所有权"}),e.jsx(a,{value:"提供服务",children:"提供服务"}),e.jsx(a,{value:"许可使用",children:"许可使用"}),e.jsx(a,{value:"合作经营",children:"合作经营"}),e.jsx(a,{value:"融资借贷",children:"融资借贷"}),e.jsx(a,{value:"劳动用工",children:"劳动用工"}),e.jsx(a,{value:"争议解决",children:"争议解决"})]})})}),e.jsx(l,{span:8,children:e.jsx(n.Item,{label:"合同标的",name:"contract_object",children:e.jsxs(x,{placeholder:"选择合同标的",children:[e.jsx(a,{value:"货物",children:"货物"}),e.jsx(a,{value:"工程",children:"工程"}),e.jsx(a,{value:"智力成果",children:"智力成果"}),e.jsx(a,{value:"服务",children:"服务"}),e.jsx(a,{value:"股权",children:"股权"}),e.jsx(a,{value:"资金",children:"资金"}),e.jsx(a,{value:"劳动力",children:"劳动力"}),e.jsx(a,{value:"不动产",children:"不动产"}),e.jsx(a,{value:"动产",children:"动产"})]})})}),e.jsx(l,{span:8,children:e.jsx(n.Item,{label:"复杂程度",name:"complexity",children:e.jsxs(x,{placeholder:"选择复杂程度",children:[e.jsx(a,{value:"简单",children:"简单"}),e.jsx(a,{value:"中等",children:"中等"}),e.jsx(a,{value:"复杂",children:"复杂"})]})})}),e.jsx(l,{span:8,children:e.jsx(n.Item,{label:"起草立场",name:"stance",children:e.jsxs(x,{placeholder:"选择起草立场",children:[e.jsx(a,{value:"甲方",children:"甲方"}),e.jsx(a,{value:"乙方",children:"乙方"}),e.jsx(a,{value:"中立",children:"中立"}),e.jsx(a,{value:"平衡",children:"平衡"})]})})})]}),i.legal_features&&e.jsxs(e.Fragment,{children:[e.jsx(pe,{style:{margin:"16px 0"}}),e.jsxs(j,{bordered:!0,size:"small",column:2,children:[e.jsx(j.Item,{label:"交易对价类型",children:i.legal_features.consideration_type}),e.jsx(j.Item,{label:"交易对价详情",children:i.legal_features.consideration_detail}),e.jsx(j.Item,{label:"交易特征",span:2,children:i.legal_features.transaction_characteristics}),e.jsx(j.Item,{label:"适用场景",span:2,children:i.usage_scenario}),i.legal_basis&&i.legal_basis.length>0&&e.jsx(j.Item,{label:"法律依据",span:2,children:i.legal_basis.map((s,t)=>e.jsx(I,{color:"blue",children:s},t))})]})]})]}),!i?.legal_features&&e.jsx(d,{title:e.jsxs(w,{children:[e.jsx(O,{}),e.jsx("span",{children:"知识图谱法律特征"}),e.jsx(I,{color:"default",children:"未同步"})]}),style:{marginTop:16},children:e.jsx(h,{message:"未找到知识图谱特征",description:e.jsx("span",{children:"知识图谱中未找到该模板对应的法律特征。请检查模板名称是否正确， 或在知识图谱管理中添加该合同类型的法律特征。"}),type:"warning",showIcon:!0})})]},"metadata"),e.jsx(F,{tab:"内容编辑",children:f?f.editable?e.jsxs(d,{children:[e.jsx(h,{message:"内容编辑",description:"您可以直接编辑模板内容。更改将保存为新的文档文件。",type:"warning",showIcon:!0,style:{marginBottom:16}}),e.jsx(K,{value:v,onChange:s=>V(s.target.value),rows:20,placeholder:"模板内容...",style:{fontFamily:"monospace"}})]}):e.jsx(d,{children:e.jsx(h,{message:"不支持在线编辑",description:`此文件类型（${f.file_type}）不支持在线编辑。您可以上传新文件来替换。`,type:"warning",showIcon:!0})}):e.jsx(d,{children:e.jsx(h,{message:"内容加载失败",description:"无法加载模板内容，可能文件格式不支持或文件已损坏。",type:"error",showIcon:!0})})},"content"),e.jsx(F,{tab:"文件替换",children:e.jsxs(d,{children:[e.jsx(h,{message:"文件替换",description:"上传新文件将完全替换当前模板文件。原文件将被删除。",type:"warning",showIcon:!0,style:{marginBottom:16}}),e.jsxs(ve,{fileList:_,onChange:ee,beforeUpload:()=>!1,maxCount:1,accept:".docx,.doc,.pdf",children:[e.jsx("p",{className:"ant-upload-drag-icon",children:e.jsx(ue,{})}),e.jsx("p",{className:"ant-upload-text",children:"点击或拖拽文件到此区域上传"}),e.jsx("p",{className:"ant-upload-hint",children:"支持 .docx, .doc, .pdf 格式"})]}),g&&e.jsxs("div",{style:{marginTop:16},children:[e.jsxs(S,{type:"secondary",children:["当前文件: ",g.file_name]}),e.jsx("br",{}),e.jsxs(S,{type:"secondary",children:["文件类型: ",g.file_type]}),e.jsx("br",{}),e.jsxs(S,{type:"secondary",children:["文件大小: ",(g.file_size/1024).toFixed(2)," KB"]})]})]})},"file")]})})]})]}):null};export{Le as default};
