import{r as c,z as se,_ as te,j as e,d as y,T as O,I as F,B as j,ay as ne,S as W,H as xe,aB as ge,u as je,l as I,s as u,o as R,av as re,y as ke,bc as q,aX as J,e as K,c as Q,C as N,i as ye,G as we,bu as ve}from"./index-DsSH7ar9.js";import{r as Se}from"./index-BG4ynBuM.js";import{R as be}from"./react-markdown-BPiSPnC-.js";import{P as Ce}from"./progress-DKXx16Cn.js";import{S as ae}from"./index-CPCU-VE-.js";import{R as Ie}from"./ClockCircleOutlined-CRgYQNiM.js";import{R as Re}from"./CheckCircleOutlined-D8HzKhfL.js";import{t as Y}from"./websocketService-_0DTpPYY.js";import{A as Ne,R as Te}from"./DownloadOutlined-o4CB4bSj.js";import{R as $e,a as Me}from"./FileWordOutlined-dAgC8msp.js";import{M as Pe}from"./index-DTpoEitt.js";var ze={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0068.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"}}]},name:"mail",theme:"outlined"},_e=function(a,n){return c.createElement(se,te({},a,{ref:n,icon:ze}))},Ae=c.forwardRef(_e),We={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M690.1 377.4c5.9 0 11.8.2 17.6.5-24.4-128.7-158.3-227.1-319.9-227.1C209 150.8 64 271.4 64 420.2c0 81.1 43.6 154.2 111.9 203.6a21.5 21.5 0 019.1 17.6c0 2.4-.5 4.6-1.1 6.9-5.5 20.3-14.2 52.8-14.6 54.3-.7 2.6-1.7 5.2-1.7 7.9 0 5.9 4.8 10.8 10.8 10.8 2.3 0 4.2-.9 6.2-2l70.9-40.9c5.3-3.1 11-5 17.2-5 3.2 0 6.4.5 9.5 1.4 33.1 9.5 68.8 14.8 105.7 14.8 6 0 11.9-.1 17.8-.4-7.1-21-10.9-43.1-10.9-66 0-135.8 132.2-245.8 295.3-245.8zm-194.3-86.5c23.8 0 43.2 19.3 43.2 43.1s-19.3 43.1-43.2 43.1c-23.8 0-43.2-19.3-43.2-43.1s19.4-43.1 43.2-43.1zm-215.9 86.2c-23.8 0-43.2-19.3-43.2-43.1s19.3-43.1 43.2-43.1 43.2 19.3 43.2 43.1-19.4 43.1-43.2 43.1zm586.8 415.6c56.9-41.2 93.2-102 93.2-169.7 0-124-120.8-224.5-269.9-224.5-149 0-269.9 100.5-269.9 224.5S540.9 847.5 690 847.5c30.8 0 60.6-4.4 88.1-12.3 2.6-.8 5.2-1.2 7.9-1.2 5.2 0 9.9 1.6 14.3 4.1l59.1 34c1.7 1 3.3 1.7 5.2 1.7a9 9 0 006.4-2.6 9 9 0 002.6-6.4c0-2.2-.9-4.4-1.4-6.6-.3-1.2-7.6-28.3-12.2-45.3-.5-1.9-.9-3.8-.9-5.7.1-5.9 3.1-11.2 7.6-14.5zM600.2 587.2c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c0 19.8-16.2 35.9-36 35.9zm179.9 0c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9a36.08 36.08 0 01-36 35.9z"}}]},name:"wechat",theme:"outlined"},Oe=function(a,n){return c.createElement(se,te({},a,{ref:n,icon:We}))},Fe=c.forwardRef(Oe);const Z=({content:t})=>{const a=c.useRef(null);return c.useEffect(()=>{a.current&&a.current.scrollIntoView({behavior:"smooth"})},[t]),e.jsx(y,{title:"AI 生成文书初稿",className:"display-card",children:e.jsxs("div",{className:"markdown-body",children:[e.jsx(be,{remarkPlugins:[Se],children:t}),e.jsx("div",{ref:a})]})})},{TextArea:De}=F,{Paragraph:Ee}=O,Ge=({isSending:t,onSendMessage:a})=>{const[n,l]=c.useState(""),d=()=>{n.trim()&&(a(n),l(""))};return e.jsxs(y,{title:"多轮交互修改",size:"small",className:"chat-card",children:[e.jsx(Ee,{children:"如果您对初稿不满意，请在下方输入修改意见，AI将实时更新文书内容。"}),e.jsx(De,{rows:4,placeholder:"例如：请将甲方更改为“XXX公司”，并增加一条关于保密责任的条款。",value:n,onChange:f=>l(f.target.value)}),e.jsx(j,{type:"primary",icon:e.jsx(ne,{}),loading:t,onClick:d,style:{marginTop:16},block:!0,children:"发送修改意见"})]})},Ue=()=>e.jsx(y,{title:"AI 正在为您生成文书...",className:"display-card placeholder-card",children:e.jsxs("div",{className:"placeholder-content",children:[e.jsx("div",{className:"placeholder-line title-line"}),e.jsx("div",{className:"placeholder-line"}),e.jsx("div",{className:"placeholder-line short-line"}),e.jsx("div",{className:"placeholder-line"}),e.jsx("div",{className:"placeholder-line"}),e.jsx("div",{className:"placeholder-line medium-line"})]})}),{Text:w}=O,{Step:Be}=ae,Le=({progress:t,status:a,currentNode:n,estimatedTimeRemaining:l})=>{const d=f=>{switch(f){case"completed":return"success";case"processing":return"active";case"failed":return"exception";default:return"normal"}};return e.jsx(y,{size:"small",className:"overall-progress-card",children:e.jsxs(W,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(w,{strong:!0,children:"总体进度: "}),e.jsx(Ce,{percent:t,status:d(a),strokeColor:{"0%":"#108ee9","100%":"#87d068"}})]}),n&&e.jsxs("div",{children:[e.jsx(w,{type:"secondary",children:"当前节点: "}),e.jsx(w,{children:n})]}),l&&e.jsxs("div",{children:[e.jsx(w,{type:"secondary",children:"预计剩余时间: "}),e.jsxs(w,{children:[Math.round(l/60)," 分钟"]})]})]})})},He=({task:t,showTimeEstimates:a=!0,compact:n=!1})=>{const l=(i,m)=>{if(!m)return"wait";if(i===m)return"process";const T=["分析","起草","审查","完成"],x=T.indexOf(m);return T.indexOf(i)<x?"finish":"wait"},d=i=>{switch(i){case"finish":return e.jsx(Re,{});case"process":return e.jsx(xe,{});default:return e.jsx(Ie,{})}},f=t.workflowSteps||[{name:"分析",status:"pending"},{name:"起草",status:"pending"},{name:"审查",status:"pending"},{name:"完成",status:"pending"}];return e.jsx(y,{size:"small",title:"处理流程",className:"progress-timeline-card",children:e.jsx(ae,{direction:"vertical",size:n?"small":"default",current:f.findIndex(i=>i.status==="processing"),children:f.map((i,m)=>e.jsx(Be,{title:i.name,status:l(i.name,t.currentNode),icon:d(i.status),description:e.jsxs("div",{children:[i.status==="processing"&&e.jsx(w,{type:"secondary",children:"处理中..."}),i.status==="completed"&&e.jsx(w,{type:"secondary",children:"已完成"}),a&&i.estimatedTime&&e.jsx("div",{children:e.jsxs(w,{type:"secondary",style:{fontSize:"12px"},children:["预计时间: ",i.estimatedTime,"分钟"]})})]})},i.name))})})},{Content:Ve,Header:Xe}=re,{Paragraph:ee}=O,{TextArea:qe}=F,M=t=>{if(!t||t==="None")return"";let a=String(t).replace(/<think>[\s\S]*?<\/think>/gs,"").replace(/<execute>[\s\S]*$/g,"");return a=a.replace(/\r\n/g,`
`).replace(/\n{3,}/g,`

`).trim(),a},A=t=>{if(!t)return"";const a="【审查通过稿】",n="【主要修改说明】",l=t.indexOf(a);if(l===-1)return t;const d=t.indexOf(n,l);return(d!==-1?t.substring(l+a.length,d):t.substring(l+a.length)).trim()},cs=()=>{const{taskId:t}=ge(),a=je(),[n,l]=c.useState(null),[d,f]=c.useState(""),[i,m]=c.useState(!0),[T,x]=c.useState(!1),[D,E]=c.useState(!1),[k,G]=c.useState(""),[$,v]=c.useState(!1),[ce,U]=c.useState(""),[B,P]=c.useState(!1),[z,oe]=c.useState(!1),[h,ie]=c.useState(null),S=c.useRef(null),le=c.useRef(null),de=s=>{try{switch(JSON.parse(s).intent){case"analyze_risk":return"系统已完成背景情况分析，基于你的资料和信息，你是否需要我进行风险分析？如果你确认，我将启动风险分析报告工作流，为你输出专业的风险分析报告。";case"legal_consultation":return"系统已完成背景情况分析，基于你的资料和信息，你是否需要我生成合同？如果你确认，我将启动合同生成工作流，为你输出专业的合同文本。";case"draft_letter":return"系统已完成背景情况分析，基于你的资料和信息，你是否需要我草拟函件？如果你确认，我将启动函件起草工作流，为你输出专业的函件文本。";case"judicial_document":return"系统已完成背景情况分析，基于你的资料和信息，你是否需要我拟订司法文书？如果你确认，我将启动司法文书拟订工作流，为你输出专业的司法文书。";default:return"系统已完成背景情况分析，基于你的资料和信息，你是否需要我进行风险分析？如果你确认，我将启动风险分析报告工作流，为你输出专业的风险分析报告。"}}catch{return"系统已完成背景情况分析，基于你的资料和信息，你是否需要我进行风险分析？如果你确认，我将启动风险分析报告工作流，为你输出专业的风险分析报告。"}},L=c.useCallback(()=>({onProgress:s=>{I.task("收到进度更新:",s),ie(s),l(o=>{if(!o)return null;const r={...o,status:s.status,progress:s.progress,currentNode:s.currentNode,nodeProgress:s.nodeProgress,workflowSteps:s.workflowSteps,estimatedTimeRemaining:s.estimatedTimeRemaining,errorMessage:s.errorMessage};if(s.status==="completed"&&s.result){const p=s.result||"",g=M(p),C=A(g);f(C||g),v(!1),m(!1),x(!1)}else s.status==="failed"&&(m(!1),x(!1),u.error(`任务处理失败: ${s.errorMessage||"未知错误"}`));return r})},onCompleted:s=>{I.task("任务完成:",s),m(!1),x(!1),u.success("任务处理完成！")},onError:s=>{I.error("任务错误:",s),m(!1),x(!1),u.error(`任务处理失败: ${s}`)},onConnected:()=>{I.websocket("WebSocket连接成功"),P(!0)},onDisconnected:()=>{I.websocket("WebSocket连接断开"),P(!1)}}),[]),H=c.useCallback(async()=>{if(t)try{const s=localStorage.getItem("token");if(!s){console.warn("未找到认证token，无法连接WebSocket");return}const o=L();le.current=o,await Y.connect(t,s,o)}catch(s){console.error("WebSocket连接失败:",s),_()}},[t,L]),_=c.useCallback(()=>{if(S.current)return;const s=window.setInterval(async()=>{if(t)try{const r=(await R.getTaskStatus(t)).data;if(l(r),r.status==="completed"||r.status==="failed")if(b(),m(!1),x(!1),r.status==="completed"){if(r.analysis_report&&!r.final_document)U(r.analysis_report),v(!0),f("");else if(r.result){const p=r.result||"",g=M(p),C=A(g);f(C||g),v(!1)}}else u.error(`任务处理失败: ${M(r.result)||"未知错误"}`);else m(!0)}catch(o){console.error("轮询任务状态失败:",o),u.error("轮询任务状态失败"),b(),m(!1),x(!1)}},3e3);S.current=s},[t]),b=c.useCallback(()=>{S.current&&(clearInterval(S.current),S.current=null),Y.disconnect(),P(!1)},[]);c.useEffect(()=>{if(!t){u.error("无效的任务ID，正在返回首页..."),a("/");return}return H(),()=>{b()}},[t,a,H,b]),c.useEffect(()=>{(async()=>{if(t)try{const r=(await R.getTaskStatus(t)).data;if(l(r),(r.status==="completed"||r.status==="failed")&&(b(),m(!1),x(!1),r.status==="completed")){if(r.analysis_report&&!r.final_document)U(r.analysis_report),v(!0);else if(r.result){const p=r.result||"",g=M(p),C=A(g);f(C||g),v(!1)}}}catch(o){console.error("获取任务状态失败:",o)}})()},[t]);const ue=async()=>{if(!(!t||!n))try{const s=new FormData;s.append("task_id",t),s.append("action","generate"),s.append("demand",n.user_demand||""),await R.createAnalysisTask(s),l({...n,status:"processing",result:""}),v(!1),m(!0),f(""),u.success("已确认，AI正在进行分析，请您耐心等待……"),_()}catch(s){const o=s.response?.data?.detail||"确认失败。";u.error(o),console.error("Confirm generation error:",s)}},me=()=>{a("/",{state:{taskId:t,demand:n?.user_demand}})},fe=async s=>{if(!t||!n)return;if(!d.trim()){u.error("当前没有可供修改的文稿内容。");return}const o=n.doc_type;if(!o){u.error("无法确定当前文档类型，无法提交修改。");return}x(!0),m(!0),b();try{await R.sendModificationRequest(t,{original_content:d,modification_suggestion:s,type:o}),l({...n,status:"processing",result:""}),_()}catch(r){const p=r.response?.data?.detail||"发送修改意见失败。";u.error(p),console.error("Send modification error:",r),x(!1),m(!1)}},V=async s=>{if(!d.trim()||!t||!n){u.warning("没有可供生成的合同正文内容。");return}const o=n.doc_type;if(s==="word"&&!o){u.error("无法确定文档类型，无法生成Word文件。");return}E(!0),G("");try{const p=(await R.generateFile(t,{content:d,format:s,doc_type:o})).data.file_url;G(p);const g=`${window.location.origin}${p}`;Pe.success({title:"文件生成成功！",content:e.jsxs("div",{children:[e.jsx("p",{children:"您的文件已准备就绪，可以下载或分享。"}),e.jsx(F,{readOnly:!0,value:g,addonAfter:e.jsx(ve,{onClick:()=>{navigator.clipboard.writeText(g),u.success("链接已复制！")}})})]}),okText:"知道了"})}catch(r){const p=r.response?.data?.detail||"文件生成失败。";u.error(p),console.error("Generate file error:",r)}finally{E(!1)}},X=s=>{if(!k){u.warning("请先生成文件以获取分享链接。");return}const o=`${window.location.origin}${k}`;navigator.clipboard.writeText(o),u.success(`下载链接已复制，请在${s==="feishu"?"飞书":"微信"}中粘贴发送。`)},he=()=>{if(!k){u.warning("请先生成文件以获取分享链接。");return}const s=`${window.location.origin}${k}`,o="分享法律文书文件",r=`您好，

这是为您生成的法律文书文件，请通过以下链接下载：
${s}

祝好！`;window.location.href=`mailto:?subject=${encodeURIComponent(o)}&body=${encodeURIComponent(r)}`},pe=()=>!i&&!n?.status||n?.status==="completed"&&d?null:e.jsxs("div",{className:"progress-section",children:[h&&e.jsx(Le,{progress:h.progress,status:h.status,currentNode:h.currentNode,estimatedTimeRemaining:h.estimatedTimeRemaining}),e.jsx("div",{className:"connection-status",children:e.jsxs(W,{children:[e.jsx("span",{className:`status-indicator ${B?"connected":"disconnected"}`,children:B?e.jsxs(e.Fragment,{children:[e.jsx(q,{})," WebSocket连接正常"]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{})," ",S.current?"轮询模式":"连接断开"]})}),n&&e.jsx(ye,{color:n.status==="processing"?"blue":n.status==="completed"?"green":n.status==="failed"?"red":"default",children:n.status==="processing"?"处理中":n.status==="completed"?"已完成":n.status==="failed"?"失败":"等待中"})]})}),(h?.workflowSteps||n?.workflowSteps)&&e.jsx("div",{className:"progress-details-toggle",children:e.jsx(j,{type:"text",icon:e.jsx(we,{}),onClick:()=>oe(!z),children:z?"隐藏进度详情":"显示进度详情"})}),z&&e.jsx(He,{task:n||h||{},showTimeEstimates:!0,compact:!1})]});return i&&!n?e.jsx("div",{className:"loading-page",children:e.jsx(Ue,{})}):e.jsxs(re,{className:"result-layout",children:[e.jsxs(Xe,{className:"result-header",children:[e.jsxs("div",{className:"logo",onClick:()=>a("/"),style:{cursor:"pointer"},children:[e.jsx(ke,{})," ",e.jsx("span",{children:"法律文书生成助手"})]}),e.jsx("div",{children:e.jsx(j,{onClick:()=>a("/"),children:"创建新任务"})})]}),e.jsxs(Ve,{className:"result-content",children:[pe(),e.jsxs("div",{className:"content-grid",children:[e.jsx("div",{className:"file-display-pane",children:i||n?.status==="processing"?e.jsx("div",{className:"processing-content",children:$?e.jsx(y,{title:"案情分析完成",className:"display-card",children:e.jsxs("div",{className:"markdown-body",children:[e.jsx(Ne,{message:"确认您的需求",description:de(ce),type:"info",showIcon:!0}),e.jsxs("div",{style:{marginTop:"20px",display:"flex",gap:"10px"},children:[e.jsx(j,{type:"primary",icon:e.jsx(q,{}),onClick:ue,children:"确认"}),e.jsx(j,{icon:e.jsx(J,{}),onClick:me,children:"返回修改"})]})]})}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{content:d}),!d&&e.jsxs("div",{className:"processing-placeholder",children:[e.jsx(K,{size:"large",tip:"AI正在分析您的需求，请稍候..."}),e.jsxs("div",{className:"processing-tips",children:[e.jsx("p",{children:"• 系统正在分析您的文档内容"}),e.jsx("p",{children:"• 提取关键法律要素"}),e.jsx("p",{children:"• 生成专业的法律文书"})]})]})]})}):e.jsx(Z,{content:d})}),e.jsx("div",{className:"control-pane",children:e.jsx("div",{className:"control-pane-scrollable",children:e.jsxs(W,{direction:"vertical",size:"middle",style:{width:"100%"},children:[h&&e.jsx(y,{title:"实时处理状态",size:"small",className:"progress-info-card",children:e.jsxs("div",{className:"progress-info",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"当前节点:"})," ",h.currentNode||"等待中"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"总体进度:"})," ",Math.round(h.progress),"%"]}),h.estimatedTimeRemaining&&e.jsxs("p",{children:[e.jsx("strong",{children:"预计剩余时间:"})," ",Math.round(h.estimatedTimeRemaining/60),"分钟"]})]})}),e.jsx(Ge,{isSending:T,onSendMessage:fe}),e.jsxs(y,{title:"确认与生成文件",size:"small",children:[e.jsx(ee,{type:"secondary",style:{marginBottom:16},children:"请确认或编辑以下合同正文，然后生成文件。"}),e.jsx(qe,{rows:8,value:d,onChange:s=>f(s.target.value),placeholder:"AI生成的最终文稿将在此处显示，您可直接编辑。",disabled:n?.status!=="completed"||$}),e.jsx(K,{spinning:D,tip:"文件生成中...",children:e.jsxs(Q,{gutter:16,style:{marginTop:16},children:[e.jsx(N,{span:12,children:e.jsx(j,{icon:e.jsx($e,{}),block:!0,onClick:()=>V("word"),disabled:n?.status!=="completed"||$,children:"生成 Word"})}),e.jsx(N,{span:12,children:e.jsx(j,{icon:e.jsx(Me,{}),block:!0,onClick:()=>V("pdf"),disabled:n?.status!=="completed"||$,children:"生成 PDF"})})]})})]}),e.jsxs(y,{title:"文件交付",size:"small",children:[e.jsx(j,{type:"primary",icon:e.jsx(Te,{}),disabled:!k,block:!0,href:k,download:!0,children:"直接下载"}),e.jsx(ee,{style:{textAlign:"center",margin:"16px 0",color:"#999"},children:"或分享至"}),e.jsxs(Q,{gutter:16,children:[e.jsx(N,{span:8,children:e.jsx(j,{icon:e.jsx(ne,{}),block:!0,onClick:()=>X("feishu"),disabled:!k,children:"飞书"})}),e.jsx(N,{span:8,children:e.jsx(j,{icon:e.jsx(Fe,{}),block:!0,onClick:()=>X("wechat"),disabled:!k,children:"微信"})}),e.jsx(N,{span:8,children:e.jsx(j,{icon:e.jsx(Ae,{}),block:!0,onClick:he,disabled:!k,children:"邮件"})})]})]})]})})})]})]})]})};export{cs as default};
