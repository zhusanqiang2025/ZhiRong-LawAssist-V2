# 本地配置修改说明

## 飞书集成本地开发 - 配置文件修改说明

本文档说明飞书集成本地开发过程中所有修改和新增的配置文件。

---

## 一、修改的文件

### 1. `docker-compose.local.yml`

**修改内容：**

- **Redis 服务增强**
  - 添加密码认证：`--requirepass 123myredissecret`
  - 开启持久化：`--appendonly yes`
  - 添加数据卷挂载：`redis_data:/data`
  - 添加健康检查：`redis-cli -a 123myredissecret ping`

- **Backend 服务增强**
  - 修改 Redis 地址：从 `host.docker.internal` 改为 `redis`（容器名）
  - 添加完整 Redis 环境变量：`REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`, `REDIS_DB`
  - 添加 Celery 环境变量：`CELERY_BROKER_URL`, `CELERY_RESULT_BACKEND`, `CELERY_ENABLED=true`
  - 修改依赖条件：使用健康检查 `condition: service_healthy`

- **新增网络和数据卷**
  - 网络：`legal_doc_local_network`（bridge 驱动）
  - 数据卷：`redis_data`

**修改原因：**
- 支持飞书集成所需的 Token 缓存（Redis）
- 支持 Celery 定时任务（Token 自动刷新）
- 确保容器间网络通信正常

---

### 2. `backend/Dockerfile.local`

**修改内容：**

在文件末尾（启动命令前）新增以下环境变量：

```dockerfile
# 系统服务账号配置（非敏感）
ENV SYSTEM_SERVICE_EMAIL=zhusanqhang@az028.cn

# JWT Token 管理配置（非敏感）
ENV JWT_TOKEN_EXPIRE_HOURS=24
ENV JWT_TOKEN_REFRESH_INTERVAL_HOURS=1.5
ENV REDIS_TOKEN_KEY=feishu_integration:access_token

# 飞书开放平台配置（非敏感，基础API地址）
ENV FEISHU_BASE_API_URL=https://open.feishu.cn
ENV FEISHU_TENANT_TOKEN_CACHE_KEY=feishu_integration:tenant_token
ENV FEISHU_TENANT_TOKEN_EXPIRE_SECONDS=7200

# 日志配置（非敏感）
ENV FEISHU_LOG_LEVEL=INFO
ENV FEISHU_LOG_FILE=logs/feishu_integration.log
```

**修改原因：**
- 提供飞书集成所需的默认配置
- 敏感配置（密码、密钥）通过 `.env` 文件传入

---

### 3. `.gitignore`

**修改内容：**

在环境变量部分添加：

```
backend/.env
```

**修改原因：**
- 防止敏感配置文件（`backend/.env`）被提交到代码仓库

---

### 4. `backend/app/tasks/celery_app.py`

**修改内容：**

在 `include` 列表中添加：

```python
"app.tasks.feishu_integration_tasks", # ✨ 飞书集成本地开发：飞书集成任务模块
```

**修改原因：**
- 注册飞书集成的 Celery 定时任务模块

---

### 5. `backend/app/api/v1/router.py`

**修改内容：**

1. 导入飞书回调模块：
```python
from app.api.v1.endpoints import feishu_callback  # 飞书集成本地开发
```

2. 注册飞书回调路由：
```python
api_router.include_router(feishu_callback.router, prefix="/feishu", tags=["Feishu Integration (Local)"])
```

**修改原因：**
- 将飞书回调接口注册到 API 路由中

---

## 二、新增的文件

### 1. `backend/.env`

**文件作用：**
管理飞书集成所需的敏感配置信息

**配置项说明：**

| 配置项 | 说明 | 替换要求 |
|--------|------|----------|
| `SYSTEM_SERVICE_PASSWORD` | 系统服务账号登录密码 | **必须替换**为实际密码 |
| `FEISHU_APP_ID` | 飞书开放平台测试应用的 App ID | **必须替换**为飞书应用 APPID |
| `FEISHU_APP_SECRET` | 飞书开放平台测试应用的 App Secret | **必须替换**为飞书应用 Secret |
| `REDIS_PASSWORD` | Redis 密码 | 需与 docker-compose.local.yml 一致 |
| `FEISHU_ENCRYPT_KEY` | 飞书事件回调加密密钥 | 可选（正式环境建议配置） |
| `FEISHU_VERIFICATION_TOKEN` | 飞书事件回调验证令牌 | 可选（正式环境建议配置） |

---

### 2. `backend/app/utils/token_manager.py`

**文件作用：**
飞书集成专用系统服务账号的 JWT Token 全自动化管理工具

**核心功能：**
- 初始化获取 Token（调用登录接口）
- Token 有效性校验（基于时间戳）
- 自动刷新 Token（重试机制）
- 全局获取 Token（统一接口）
- Token 存储（Redis 优先，内存兜底）

---

### 3. `backend/app/utils/feishu_api.py`

**文件作用：**
飞书开放平台 API 基础调用工具类

**核心功能：**
- tenant_access_token 自动获取与缓存
- 飞书 API 通用请求方法（GET/POST/PUT/DELETE）
- 飞书多维表操作（获取数据、更新数据、创建记录）
- 飞书消息发送（文本消息、卡片消息）
- 飞书卡片回调解析

---

### 4. `backend/app/tasks/feishu_integration_tasks.py`

**文件作用：**
飞书集成专用的 Celery 定时任务模块

**核心功能：**
- Token 定时刷新任务
- 自动注册到 Celery Beat
- 可配置刷新间隔（默认 1.5 小时）

---

### 5. `backend/app/api/v1/endpoints/feishu_callback.py`

**文件作用：**
飞书开放平台回调基础处理接口

**核心功能：**
- 飞书回调统一根路由 `/api/v1/feishu/callback`
- 立场选择回调接口 `/position`
- URL 验证接口 `/url-verification`
- 飞书回调验签（可选，本地开发可跳过）

---

## 三、配置替换步骤

### 启动前必须完成的配置替换：

1. **编辑 `backend/.env` 文件**

2. **替换系统服务账号密码**
   ```bash
   SYSTEM_SERVICE_PASSWORD=你的实际密码
   ```

3. **配置飞书开放平台应用**
   - 访问 [飞书开放平台](https://open.feishu.cn)
   - 创建测试应用
   - 获取 App ID 和 App Secret
   - 替换配置：
     ```bash
     FEISHU_APP_ID=cli_xxxxxxxxxxxxx
     FEISHU_APP_SECRET=你的AppSecret
     ```

4. **（可选）配置飞书回调验证**
   - 在飞书开放平台配置事件回调
   - 获取 Encrypt Key 和 Verification Token
   - 替换配置：
     ```bash
     FEISHU_ENCRYPT_KEY=你的EncryptKey
     FEISHU_VERIFICATION_TOKEN=你的VerificationToken
     ```

---

## 四、文件结构总览

```
legal_assistant_v3/
├── docker-compose.local.yml      # 修改：Redis/Celery 配置
├── .gitignore                     # 修改：忽略 backend/.env
├── backend/
│   ├── .env                       # 新增：敏感配置
│   ├── Dockerfile.local           # 修改：飞书集成环境变量
│   └── app/
│       ├── api/
│       │   └── v1/
│       │       ├── router.py      # 修改：注册飞书路由
│       │       └── endpoints/
│       │           └── feishu_callback.py  # 新增：飞书回调接口
│       ├── tasks/
│       │   ├── celery_app.py      # 修改：注册飞书任务模块
│       │   └── feishu_integration_tasks.py  # 新增：Token 定时刷新
│       └── utils/
│           ├── token_manager.py   # 新增：JWT Token 管理
│           └── feishu_api.py      # 新增：飞书 API 调用
```

---

## 五、注意事项

1. **隔离开发原则**：所有修改仅限 `.local` 文件和本地新增文件，不影响线上代码

2. **敏感配置保护**：`backend/.env` 已添加到 `.gitignore`，不会被提交

3. **配置优先级**：环境变量优先级：`.env` > `Dockerfile.local ENV` > 代码默认值

4. **后续迁移**：迁移到线上时，仅需修改配置文件，无需修改代码
