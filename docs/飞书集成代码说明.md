# 飞书集成代码说明

## 飞书集成本地开发 - 代码架构与使用说明

---

## 一、模块架构总览

```
飞书集成模块
├── 配置层
│   ├── docker-compose.local.yml    # 容器编排配置
│   ├── backend/Dockerfile.local    # 后端构建配置
│   └── backend/.env                # 敏感配置
├── 工具层
│   ├── token_manager.py            # JWT Token 管理
│   └── feishu_api.py               # 飞书 API 调用
├── 任务层
│   └── feishu_integration_tasks.py # Celery 定时任务
└── 接口层
    └── feishu_callback.py          # 飞书回调接口
```

---

## 二、核心模块详解

### 1. Token 管理工具 (`token_manager.py`)

#### 功能概述

自动管理系统服务账号（`zhusanqiang@az028.cn`）的 JWT Token，包括获取、校验、刷新和缓存。

#### 核心类和方法

| 方法名 | 功能说明 | 使用场景 |
|--------|----------|----------|
| `get_valid_token()` | 获取有效的 JWT Token | 对外统一接口，自动处理刷新 |
| `refresh_access_token()` | 刷新 JWT Token | Token 即将过期时调用 |
| `_fetch_access_token()` | 调用登录接口获取 Token | 内部方法，获取新 Token |
| `_is_token_valid()` | 校验 Token 是否有效 | 内部方法，检查有效期 |
| `clear_token_cache()` | 清除 Token 缓存 | 测试或强制重新获取 |

#### 使用示例

```python
from app.utils.token_manager import get_valid_token

# 获取有效的 JWT Token（自动处理刷新）
token = get_valid_token()

# 使用 Token 调用后端 API
headers = {"Authorization": f"Bearer {token}"}
response = requests.get("http://localhost:8000/api/v1/users", headers=headers)
```

#### Token 存储策略

1. **优先级**：Redis > 内存
2. **Redis Key**：`feishu_integration:access_token`
3. **有效期判断**：基于时间戳 + `JWT_TOKEN_EXPIRE_HOURS`
4. **刷新时机**：剩余有效期 < `JWT_TOKEN_REFRESH_INTERVAL_HOURS`

#### 异常处理

```python
from app.utils.token_manager import TokenRetrieveError, TokenRefreshError

try:
    token = get_valid_token()
except TokenRetrieveError as e:
    # Token 获取失败（网络错误、认证失败等）
    print(f"获取 Token 失败: {e}")
except TokenRefreshError as e:
    # Token 刷新失败（已重试 2 次）
    print(f"刷新 Token 失败: {e}")
```

---

### 2. 飞书 API 工具 (`feishu_api.py`)

#### 功能概述

封装飞书开放平台 API 调用，包括 tenant_access_token 管理、多维表操作、消息发送等。

#### 核心类和方法

| 方法名 | 功能说明 | 参数 |
|--------|----------|------|
| `get_tenant_access_token()` | 获取飞书应用 Token | 无 |
| `feishu_api_request()` | 通用 API 请求 | method, api_path, payload, params |
| `get_base_table_data()` | 获取多维表数据 | app_token, table_id, page_size |
| `update_base_table_data()` | 更新多维表数据 | app_token, table_id, record_id, fields |
| `create_base_table_record()` | 创建多维表记录 | app_token, table_id, fields |
| `send_feishu_text_msg()` | 发送文本消息 | receive_id, content, receive_id_type |
| `send_feishu_card_msg()` | 发送卡片消息 | receive_id, card_content, receive_id_type |
| `parse_feishu_card_callback()` | 解析卡片回调 | callback_data |

#### 使用示例

##### 示例 1：获取多维表数据

```python
from app.utils.feishu_api import get_base_table_data

# 获取多维表数据（分页）
data = get_base_table_data(
    app_token="app_xxxxxxxxxxxxx",
    table_id="tblxxxxxxxxxxxxx",
    page_size=100
)

records = data.get("data", {}).get("items", [])
print(f"获取到 {len(records)} 条记录")

# 获取下一页
if data.get("data", {}).get("has_more"):
    page_token = data.get("data", {}).get("page_token")
    next_data = get_base_table_data(
        app_token="app_xxxxxxxxxxxxx",
        table_id="tblxxxxxxxxxxxxx",
        page_size=100,
        page_token=page_token
    )
```

##### 示例 2：更新多维表记录

```python
from app.utils.feishu_api import update_base_table_data

# 更新记录
result = update_base_table_data(
    app_token="app_xxxxxxxxxxxxx",
    table_id="tblxxxxxxxxxxxxx",
    record_id="recxxxxxxxxxxxxx",
    fields={
        "审核状态": "已通过",
        "审核意见": "符合要求"
    }
)
```

##### 示例 3：发送飞书消息

```python
from app.utils.feishu_api import send_feishu_text_msg, send_feishu_card_msg

# 发送文本消息
send_feishu_text_msg(
    receive_id="ouxxxxxxxxxxxxx",
    content="您好，您的合同审查任务已完成",
    receive_id_type="user_id"
)

# 发送卡片消息
card_content = {
    "config": {"wide_screen_mode": True},
    "header": {
        "title": {"content": "合同审查通知", "tag": "plain_text"},
        "template": "blue"
    },
    "elements": [
        {
            "tag": "div",
            "text": {
                "tag": "lark_md",
                "content": "您有新的合同审查任务，请及时处理。"
            }
        },
        {
            "tag": "action",
            "actions": [
                {
                    "tag": "button",
                    "text": {"content": "查看详情", "tag": "plain_text"},
                    "type": "default",
                    "value": "view_detail"
                }
            ]
        }
    ]
}

send_feishu_card_msg(
    receive_id="ouxxxxxxxxxxxxx",
    card_content=card_content,
    receive_id_type="user_id"
)
```

#### Tenant Access Token 缓存

- **缓存位置**：Redis（优先）或内存
- **缓存 Key**：`feishu_integration:tenant_token`
- **有效期**：2 小时（7200 秒）
- **自动刷新**：Token 过期时自动重新获取

---

### 3. Celery 定时任务 (`feishu_integration_tasks.py`)

#### 功能概述

通过 Celery Beat 定时刷新 JWT Token，确保 Token 始终有效。

#### 核心任务

| 任务名称 | 执行间隔 | 功能说明 |
|----------|----------|----------|
| `refresh_feishu_integration_token` | 90 分钟（可配置） | 刷新系统服务账号的 JWT Token |

#### 使用示例

##### 示例 1：手动触发任务

```python
from app.tasks.feishu_integration_tasks import refresh_feishu_integration_token

# 同步执行
result = refresh_feishu_integration_token()
print(result)  # {'status': 'success', 'token_length': 235, ...}

# 异步执行（需要 Celery Worker 运行）
task = refresh_feishu_integration_token.delay()
print(f"Task ID: {task.id}")

# 获取任务结果
result = task.get(timeout=30)
```

##### 示例 2：查看任务状态

```python
from app.tasks.feishu_integration_tasks import refresh_feishu_integration_token

task = refresh_feishu_integration_token.delay()

# 检查任务状态
print(f"State: {task.state}")  # PENDING, STARTED, SUCCESS, FAILURE
print(f"Result: {task.result}")  # 任务返回值

# 等待任务完成
result = task.get(timeout=30)
```

#### 定时配置

通过环境变量 `JWT_TOKEN_REFRESH_INTERVAL_HOURS` 配置执行间隔（默认 1.5 小时）：

```bash
# backend/.env
JWT_TOKEN_REFRESH_INTERVAL_HOURS=1.5
```

---

### 4. 飞书回调接口 (`feishu_callback.py`)

#### 功能概述

处理飞书开放平台的回调事件，包括 URL 验证、卡片点击等。

#### 接口列表

| 接口路径 | 方法 | 功能说明 |
|----------|------|----------|
| `/api/v1/feishu/callback/test` | GET | 测试接口，检查服务状态 |
| `/api/v1/feishu/callback/url-verification` | POST | URL 验证，飞书配置回调时调用 |
| `/api/v1/feishu/callback/position` | POST | 立场选择回调，处理审核人操作 |

#### 回调数据格式

##### URL 验证请求

```json
{
  "token": "verification_token",
  "challenge": "challenge_string"
}
```

响应：
```json
{
  "challenge": "challenge_string"
}
```

##### 立场选择回调请求

```json
{
  "token": "verification_token",
  "timestamp": "1234567890",
  "nonce": "random_nonce",
  "event": {
    "operator": {
      "user_id": "ou_xxx"
    },
    "action": {
      "value": "approve"  // approve/reject/revision
    }
  }
}
```

响应：
```json
{
  "code": 0,
  "msg": "success"
}
```

#### 业务逻辑处理

在 `handle_position_callback` 函数中，TODO 部分需要添加具体业务逻辑：

```python
# 示例：对接合同审查模块
if action_value == "approve":
    # 1. 查询审核任务
    # task = get_review_task_by_user(user_id)
    # 2. 更新任务状态
    # update_task_status(task.id, "approved")
    # 3. 发送后续通知
    # send_notification(task.creator_id, "审核已通过")
    pass
```

---

## 三、调用关系图

```
┌─────────────────────────────────────────────────────────────┐
│                        业务调用层                            │
│  合同审查模块、其他业务模块需要调用飞书集成功能               │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    get_valid_token()                        │
│              获取有效的 JWT Token（统一接口）                 │
└───────────────────────────┬─────────────────────────────────┘
                            │
            ┌───────────────┴───────────────┐
            ▼                               ▼
┌───────────────────────────┐   ┌───────────────────────────┐
│      Redis 缓存           │   │      内存缓存（兜底）      │
│  feishu_integration:      │   │   _memory_token_store     │
│      access_token         │   │                           │
└─────────────┬─────────────┘   └─────────────┬─────────────┘
              │                               │
              ▼                               │
      ┌───────────────┐                       │
      │ Token 有效？   │                       │
      └───────┬───────┘                       │
              │                               │
      ┌───────┴───────┐                       │
      │ Yes           │ No                    │
      ▼               ▼                       │
   返回 Token    ┌─────────────────┐          │
                │ refresh_access_ │          │
                │    token()      │          │
                └────────┬─────────┘          │
                         │                     │
                         ▼                     │
              ┌──────────────────┐            │
              │ POST /api/v1/    │            │
              │ auth/login       │            │
              └────────┬─────────┘            │
                       │                      │
                       └──────────┬───────────┘
                                  ▼
                          ┌───────────────┐
                          │ 保存到缓存     │
                          │ Redis + 内存   │
                          └───────┬───────┘
                                  ▼
                            返回 Token
```

---

## 四、配置依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                    docker-compose.local.yml                 │
│  ├─ Redis 配置（密码、持久化、健康检查）                     │
│  ├─ Backend 环境变量（Redis/Celery 连接信息）               │
│  └─ 网络配置（容器间通信）                                   │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  backend/Dockerfile.local                   │
│  ├─ 系统服务账号邮箱（SYSTEM_SERVICE_EMAIL）                │
│  ├─ JWT Token 配置（有效期、刷新间隔）                      │
│  ├─ 飞书 API 配置（基础地址、Token 缓存 Key）                │
│  └─ 日志配置（日志级别、日志文件）                          │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      backend/.env                           │
│  ├─ 系统服务账号密码（SYSTEM_SERVICE_PASSWORD）             │
│  ├─ 飞书应用密钥（FEISHU_APP_ID/SECRET）                    │
│  ├─ Redis 密码（REDIS_PASSWORD）                            │
│  └─ 飞书回调密钥（ENCRYPT_KEY/VERIFICATION_TOKEN）          │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              token_manager.py + feishu_api.py               │
│  ├─ 读取环境变量（优先 .env，其次 Dockerfile ENV）           │
│  ├─ 连接 Redis（失败时降级到内存）                          │
│  ├─ 调用后端登录接口（获取 JWT Token）                      │
│  └─ 调用飞书开放平台 API（tenant_access_token）             │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、与合同审查模块集成

### 集成方式

飞书集成作为独立的工具模块，可被合同审查模块调用：

```python
# 示例：合同审查完成后发送飞书通知
from app.utils.feishu_api import send_feishu_card_msg
from app.utils.token_manager import get_valid_token

def on_contract_review_completed(task_id, reviewer_id, result):
    """合同审查完成后的飞书通知"""
    # 获取审核人信息
    reviewer = get_reviewer_info(reviewer_id)

    # 发送飞书卡片通知
    card = build_review_complete_card(task_id, result)
    send_feishu_card_msg(
        receive_id=reviewer.feishu_user_id,
        card_content=card
    )
```

### 数据流

```
┌──────────────────┐
│  合同审查模块     │
│  (业务逻辑)       │
└─────────┬────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────┐
│                 飞书集成模块                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 1. 获取 JWT Token（token_manager）             │   │
│  │ 2. 调用后端 API（获取审核人信息）               │   │
│  │ 3. 获取飞书 Tenant Token（feishu_api）         │   │
│  │ 4. 发送飞书消息（feishu_api）                   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
          │
          ▼
┌──────────────────┐
│   飞书开放平台    │
│  (发送通知/卡片)  │
└──────────────────┘
```

---

## 六、后续开发建议

### 1. 立场选择回调业务逻辑

在 `feishu_callback.py` 的 `handle_position_callback` 函数中添加：

```python
# TODO: 实现具体业务逻辑
# 1. 根据 user_id 查询对应的审核任务
# 2. 更新任务状态（立场选择结果）
# 3. 发送后续通知或触发下一步流程
# 4. 可能需要调用合同审查模块的接口
```

### 2. 飞书多维表数据同步

```python
# 示例：同步合同审查结果到飞书多维表
def sync_review_result_to_bitable(review_data):
    from app.utils.feishu_api import create_base_table_record

    result = create_base_table_record(
        app_token=os.getenv("FEISHU_BITABLE_APP_TOKEN"),
        table_id=os.getenv("FEISHU_REVIEW_TABLE_ID"),
        fields={
            "合同名称": review_data["contract_name"],
            "审核状态": review_data["status"],
            "审核意见": review_data["comment"],
            "审核时间": datetime.now().isoformat()
        }
    )
    return result
```

### 3. 飞书卡片交互增强

```python
# 示例：构建带按钮的审核卡片
def build_review_card(task_id):
    return {
        "config": {"wide_screen_mode": True},
        "header": {
            "title": {"content": "合同审查任务", "tag": "plain_text"},
            "template": "blue"
        },
        "elements": [
            {"tag": "div", "text": {"tag": "plain_text", "content": "请审核以下合同"}},
            {
                "tag": "action",
                "actions": [
                    {"tag": "button", "text": {"content": "通过", "tag": "plain_text"}, "value": f"approve_{task_id}"},
                    {"tag": "button", "text": {"content": "拒绝", "tag": "plain_text"}, "value": f"reject_{task_id}"},
                    {"tag": "button", "text": {"content": "需修改", "tag": "plain_text"}, "value": f"revision_{task_id}"}
                ]
            }
        ]
    }
```

---

## 七、调试技巧

### 1. 查看飞书 API 调用日志

```bash
# 查看飞书集成相关日志
docker-compose -f docker-compose.local.yml logs backend | grep feishu_integration
```

### 2. 测试单个函数

```python
# 进入容器
docker-compose -f docker-compose.local.yml exec backend bash

# 测试 Token 管理
python -c "from app.utils.token_manager import get_valid_token; print(get_valid_token())"

# 测试飞书 API
python -c "from app.utils.feishu_api import get_tenant_access_token; print(get_tenant_access_token())"
```

### 3. 清除 Redis 缓存

```bash
# 进入 Redis
docker-compose -f docker-compose.local.yml exec redis redis-cli -a 123myredissecret

# 删除 Token 缓存
DEL feishu_integration:access_token
DEL feishu_integration:tenant_token
```

---

**代码说明文档更新日期：2026-01-26**
