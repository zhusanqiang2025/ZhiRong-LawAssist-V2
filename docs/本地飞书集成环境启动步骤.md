# 本地飞书集成环境启动步骤

## 飞书集成本地开发 - 环境启动完整步骤

---

## 一、启动前准备

### 1. 确认配置文件替换

在启动前，请确保已完成 `backend/.env` 文件的配置替换：

```bash
cd "e:\legal_document_assistant v3-1.0\legal_assistant_v3\backend"
notepad .env
```

**必须替换的配置项：**
- `SYSTEM_SERVICE_PASSWORD` - 系统服务账号密码
- `FEISHU_APP_ID` - 飞书应用 APPID
- `FEISHU_APP_SECRET` - 飞书应用 Secret

### 2. 确认 Docker 环境

```bash
# 检查 Docker 是否运行
docker --version
docker ps
```

---

## 二、启动本地环境

### 步骤 1：构建并启动容器

```bash
cd "e:\legal_document_assistant v3-1.0\legal_assistant_v3"

# 构建并启动服务
docker-compose -f docker-compose.local.yml up -d --build
```

**预期输出：**
```
Creating network "legal_assistant_v3_legal_doc_local_network"...
Creating volume "legal_assistant_v3_redis_data"...
Creating legal_doc_redis_local ...
Creating legal_doc_backend_local ...
```

### 步骤 2：查看服务状态

```bash
# 查看容器状态
docker-compose -f docker-compose.local.yml ps
```

**预期输出：**
```
NAME                          STATUS              PORTS
legal_doc_backend_local       Up                  0.0.0.0:8000->8000/tcp
legal_doc_redis_local         Up (healthy)        0.0.0.0:6379->6379/tcp
```

### 步骤 3：查看服务日志

```bash
# 查看所有服务日志
docker-compose -f docker-compose.local.yml logs -f

# 仅查看 backend 日志
docker-compose -f docker-compose.local.yml logs -f backend
```

**预期日志输出（启动成功）：**
```
backend_1  | INFO:     Started server process [1]
backend_1  | INFO:     Waiting for application startup.
backend_1  | INFO:     Application startup complete.
backend_1  | INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

## 三、验证服务

### 验证 1：Backend API 健康检查

```bash
# 访问健康检查接口
curl http://localhost:8000/api/v1/health/
```

**预期响应：**
```json
{
  "status": "ok"
}
```

### 验证 2：飞书回调接口

```bash
# 访问飞书回调测试接口
curl http://localhost:8000/api/v1/feishu/callback/test
```

**预期响应：**
```json
{
  "status": "ok",
  "message": "飞书回调接口正常工作",
  "endpoints": [
    "/api/v1/feishu/callback/position - 立场选择回调",
    "/api/v1/feishu/callback/url-verification - URL 验证",
    "/api/v1/feishu/callback/test - 测试接口"
  ]
}
```

### 验证 3：Redis 连接

```bash
# 进入 backend 容器
docker-compose -f docker-compose.local.yml exec backend bash

# 测试 Redis 连接
python -c "import redis; r=redis.Redis(host='redis', port=6379, password='123myredissecret', decode_responses=True); print(r.ping())"

# 退出容器
exit
```

**预期输出：**
```
True
```

### 验证 4：Swagger API 文档

浏览器访问：http://localhost:8000/docs

检查是否能看到「Feishu Integration (Local)」分组下的接口。

---

## 四、（可选）启动 Celery Worker

如果需要测试 Token 定时刷新任务：

### 步骤 1：启动 Celery Worker

```bash
# 在新的终端窗口中启动 Celery Worker
docker-compose -f docker-compose.local.yml exec backend celery -A app.tasks.celery_app worker --loglevel=info
```

**预期输出：**
```
-------------- celery@xxx v5.3.4
---- **** -----
--- * ***  * -- Linux-x.x.x-x.x-xxxxx
-- * - **** ---
- ** ---------- [config]
- ** ---------- .> app:         legal_assistant:0x...
- ** ---------- .> transport:   redis://:***@redis:6379/0
- ** ---------- .> results:     redis://:***@redis:6379/0
- *** --- * --- .> concurrency: 2
-- ******* ---- .> task events: OFF
--- ***** -----
-------------- [queues]
                .> high_priority    exchange=high_priority direct=<bound>
                .> medium_priority  exchange=medium_priority direct=<bound>
                .> low_priority     exchange=low_priority direct=<bound>

[tasks]
  . app.tasks.feishu_integration_tasks.refresh_feishu_integration_token
  . ...

[INFO] Ready to accept tasks.
```

### 步骤 2：启动 Celery Beat（定时任务调度器）

```bash
# 在另一个新的终端窗口中启动 Celery Beat
docker-compose -f docker-compose.local.yml exec backend celery -A app.tasks.celery_app beat --loglevel=info
```

**预期输出：**
```
celery beat v5.3.4 is starting.
__    -    ... [config]
    -    ... .> scheduler:    DatabaseScheduler
    -    ... .> app:          legal_assistant:0x...
LocalTime: 2026-01-26 12:00:00
Configuration:>
    . broker -> redis://:***@redis:6379/0
    . loader -> celery.loaders.app.AppLoader
    . scheduler -> celery.beat.PersistentScheduler
    . logfile -> [stderr]@%INFO
    . maxinterval -> 5.00 seconds (5s)
[INFO] Scheduler: Sending due task feishu-integration-token-refresh
```

---

## 五、服务管理命令

### 停止服务

```bash
# 停止所有服务
docker-compose -f docker-compose.local.yml down

# 停止服务并删除数据卷（清空 Redis 数据）
docker-compose -f docker-compose.local.yml down -v
```

### 重启服务

```bash
# 重启所有服务
docker-compose -f docker-compose.local.yml restart

# 重启单个服务
docker-compose -f docker-compose.local.yml restart backend
```

### 查看日志

```bash
# 查看所有日志
docker-compose -f docker-compose.local.yml logs

# 实时跟踪日志
docker-compose -f docker-compose.local.yml logs -f

# 查看最近 100 行日志
docker-compose -f docker-compose.local.yml logs --tail=100

# 仅查看 backend 日志
docker-compose -f docker-compose.local.yml logs -f backend
```

### 进入容器调试

```bash
# 进入 backend 容器
docker-compose -f docker-compose.local.yml exec backend bash

# 进入 Redis 容器
docker-compose -f docker-compose.local.yml exec redis redis-cli -a 123myredissecret
```

---

## 六、常见问题排查

### 问题 1：Backend 服务启动失败

**排查步骤：**
```bash
# 查看 backend 日志
docker-compose -f docker-compose.local.yml logs backend

# 检查端口是否被占用
netstat -ano | findstr :8000
```

**常见原因：**
- 端口 8000 已被占用 → 停止占用进程或修改 docker-compose.local.yml 端口映射
- 代码语法错误 → 检查日志中的错误信息

### 问题 2：Redis 连接失败

**排查步骤：**
```bash
# 检查 Redis 容器状态
docker-compose -f docker-compose.local.yml ps redis

# 检查 Redis 日志
docker-compose -f docker-compose.local.yml logs redis

# 手动测试 Redis 连接
docker-compose -f docker-compose.local.yml exec redis redis-cli -a 123myredissecret ping
```

**预期输出：**
```
PONG
```

### 问题 3：Token 获取失败

**排查步骤：**
1. 检查 `backend/.env` 配置是否正确
2. 检查系统服务账号密码是否正确
3. 查看 backend 日志中的错误信息

**日志关键词：**
```
feishu_integration.token_manager
Token 获取失败
登录接口返回错误
```

### 问题 4：Celery Worker 无法启动

**排查步骤：**
1. 确保 Redis 服务正常运行
2. 检查 Celery 配置（`CELERY_BROKER_URL`、`CELERY_RESULT_BACKEND`）
3. 查看 Celery Worker 日志

---

## 七、内网穿透配置（飞书回调）

由于飞书回调需要公网地址，本地开发时需要使用内网穿透工具：

### 使用 ngrok（推荐）

```bash
# 启动 ngrok
ngrok http 8000

# 获取公网地址（如：https://xxx.ngrok.io）
```

**飞书开放平台回调地址配置：**
```
https://xxx.ngrok.io/api/v1/feishu/callback/position
```

### 使用其他内网穿透工具

- **cpolar**: `cpolar http 8000`
- **localtunnel**: `lt --port 8000`
- **frp**: 自建 frp 服务器

---

## 八、完成验证清单

- [ ] `backend/.env` 配置已替换
- [ ] Docker 容器正常启动
- [ ] Backend API 健康检查通过
- [ ] 飞书回调接口可访问
- [ ] Redis 连接正常
- [ ] Swagger 文档可访问
- [ ] （可选）Celery Worker 正常运行
- [ ] （可选）内网穿透工具已启动

---

**启动完成后，即可开始测试飞书集成功能！**
