合同审查模块与飞书多维表集成 - 需求对齐确认 & 核心方案框架
已完成全维度需求精准对齐，基于你确认的所有细节，梳理出无歧义的集成核心方案框架，该框架严格遵循你的要求，同时预留了对其他模块的拓展空间，后续可直接基于此框架落地技术实现，先做整体方案确认，无问题后可拆解为具体开发任务。
一、核心集成定位
飞书多维表为前端操作 / 数据存储入口，智融法助 2.0 为后端业务执行引擎，实现飞书发起 - 系统执行 - 结果回写 - 飞书通知的端到端闭环，单表承载全流程数据，通过状态字段驱动流程流转，实时触发 + 异步执行 + 全链路状态回写。
二、飞书多维表侧 - 最终确认配置
1. 核心数据表
单表设计：合同审查总表（唯一数据表，无分表）
2. 最终字段配置（按你确认的字段为准，流程流转核心依赖「审查状态」）
字段类型	字段名称	字段说明	赋值方式	核心作用
文本	序号	自定义序号	手动 / 自动	基础标识
文本	初审编号	审查任务编号	系统回写	业务唯一标识
附件	待审查合同文件	原始上传合同	业务员表单提交	业务源文件
附件	格式转换后合同	非 docx 转换后的标准文件	系统回写（如需）	审查入参文件
关联	所在单位	提报人所属单位	与提报人自动关联	维度筛选
人员	提报人	合同提报人	业务员表单提交（本人）	权限 / 通知关联
人员	审查人	法务审查人	业务员表单提交选择	权限 / 通知 / 交互关联
文本	合同名称	合同名称	系统提取（文件名 / 元数据）	业务标识
文本	提取的元数据	合同核心信息	系统回写（当事人 / 金额等）	业务结果展示
文本	选择的立场	法务审查立场	系统回写（法务卡片确认后）	审查入参
附件	审查后合同	深度审查完成的合同	系统回写	最终业务结果
单选	审查状态	流程状态	系统实时回写	流程流转核心驱动
文本	系统合同 ID	智融法助内合同 ID	系统回写	飞书 - 系统双向关联核心标识
文本	失败原因	流程失败详情	系统回写（仅失败时）	问题排查
3. 表单配置
业务员提报表单：仅展示待审查合同文件、提报人、审查人3 个字段，极简提报，其余字段由系统自动赋值 / 回写。
4. 附件权限规则
所有系统回写的附件（格式转换后合同、审查后合同），仅提报人、审查人、飞书管理员可访问，飞书接口调用时携带对应权限凭证。
三、触发服务 - 最终确认方案
1. 实现形式
飞书多维表事件订阅（机器人），实时触发（飞书端表单提交 / 数据变更后，主动推送事件至智融法助系统）。
2. 核心触发条件
仅当合同审查总表中满足：审查状态 = 待审查 且 待审查合同文件有值 时，触发系统业务流程，无其他过滤条件。
3. 重复触发防护
系统接收到触发事件后，第一时间将飞书数据表对应行的审查状态更新为「提取元数据中」，锁定行数据，避免同一任务被多次触发。
4. 事件监听范围
仅监听合同审查总表的新增行、行数据更新事件，聚焦核心触发场景。
四、智融法助 2.0 侧 - 业务模块调用 & 数据关联方案
1. 核心接口复用（无二次开发，直接调用现有接口）
流程环节	调用现有接口	接口类型	核心作用
格式转换	/api/preprocessor/convert-async	异步 POST	非 docx 文件转标准 docx，返回任务 ID
元数据提取	合同审查模块原生元数据提取接口	同步 / 异步	提取合同名称 / 当事人 / 金额等核心信息
深度审查	/api/contract/{contract_id}/deep-review	异步 POST（Celery）	执行合同深度审查，返回任务 ID
2. Celery 任务状态监听
系统实时监听格式转换、深度审查的 Celery 异步任务状态，任务状态变更（成功 / 失败 / 进行中）后，立即将状态回写至飞书多维表对应字段，并触发对应流程环节。
3. 双向数据关联规则
飞书端：唯一标识为飞书原生行 ID；
系统端：接收到触发事件后，生成contract_id（系统内合同唯一标识）；
关联核心：系统生成contract_id后，立即回写至飞书数据表的系统合同 ID字段，后续所有流程环节，均通过飞书行 ID + 系统合同 ID做双向精准关联，确保数据不串行。
五、飞书生态交互 - 消息 & 交互方案
1. 审查立场确认
形式：飞书个人会话机器人卡片（仅发送至对应审查人个人飞书会话，无群聊推送）；
卡片内容：包含合同名称、待审查合同文件链接、立场选择按钮（如「甲方立场」「乙方立场」「中立立场」）；
交互：审查人点击卡片按钮后，系统接收确认结果，回写至飞书数据表选择的立场字段，并触发深度审查流程。
2. 消息推送规则
统一推送形式：飞书机器人个人会话推送（非官方消息），推送内容带飞书数据表对应行的直接访问链接。
推送场景	推送对象	推送内容示例
深度审查启动	审查人 + 提报人	【合同审查】XX 合同已启动深度审查，审查状态：审查中，点击查看详情：XXX
审查完成	提报人 + 审查人	【合同审查】XX 合同审查完成，可查看 / 下载审查后合同，点击查看详情：XXX
流程失败（任意环节）	审查人（仅审查人）	【合同审查】XX 合同审查失败，失败原因：XXX，点击查看详情：XXX
3. 推送时机
所有推送均为实时推送，流程环节状态变更后立即触发推送。
六、端到端流程 - 最终确认（含状态流转）
基于以上所有配置，梳理精准无歧义的端到端流程 + 审查状态全流转，流程中所有审查状态为系统自动回写，为核心流转驱动：
端到端全流程
业务员在飞书多维表填写合同提报表单（仅 3 字段：待审查合同文件 + 提报人 + 审查人），提交后写入「合同审查总表」，审查状态默认 = 待审查；
飞书事件订阅实时触发，系统检测到「审查状态 = 待审查 + 文件有值」，立即将审查状态更新为「提取元数据中」（防重复触发）；
系统读取飞书端待审查合同文件，判断文件后缀是否为 docx：
✅ 是 docx：直接进入合同元数据提取环节；
❌ 非 docx：调用/api/preprocessor/convert-async做格式转换，审查状态更新为「格式转换中」，转换成功后将格式转换后合同回写至飞书，进入合同元数据提取环节；
系统调用元数据提取接口，提取合同名称 / 当事人 / 金额等信息，将「合同名称」「提取的元数据」回写至飞书；
系统向审查人发送飞书个人会话卡片，请求确认审查立场，审查状态更新为「选择立场」；
审查人在飞书卡片中确认立场，系统接收结果并将「选择的立场」回写至飞书；
系统生成contract_id，回写至飞书「系统合同 ID」字段，调用/api/contract/{contract_id}/deep-review启动深度审查，审查状态更新为「审查中」，实时推送启动通知至审查人 + 提报人；
系统实时监听 Celery 深度审查任务状态，审查完成后：
将审查后合同回写至飞书；
审查状态更新为「审查完成」；
实时推送审查完成通知至审查人 + 提报人；
业务员 / 审查人在飞书多维表点击链接，查看 / 下载审查后合同，流程结束。
审查状态全流转（系统自动回写，无人工干预）
待审查 → 提取元数据中（防重复触发） → 「格式转换中」（非 docx 时）→ 选择立场（元数据提取后）→ 审查中（立场确认后）→ 审查完成（审查结束）/失败（任意环节出错）。
异常处理流程（任意环节失败）
任意环节（格式转换 / 元数据提取 / 深度审查 / 立场交互）失败后，系统立即将审查状态更新为「失败」；
将具体失败原因（如文件损坏 / 转换超时 / 提取失败 / 卡片交互失败）回写至飞书失败原因字段；
实时推送失败通知至审查人（仅审查人），通知带失败原因 + 详情链接；
失败后可由审查人在飞书端将审查状态手动改回「待审查」，重新触发流程。
七、拓展预留设计（核心，满足后续多模块集成需求）
本次集成方案为模块化设计，所有与飞书多维表交互的逻辑均封装为通用飞书操作 SDK，预留多模块集成入口，后续集成合同生成 / 智能咨询 / 风险评估 / 案件分析等模块时，无需重构核心代码，仅需做 3 点简单适配：
飞书侧：新增对应模块的数据表（或在总表中增加「业务模块标识」字段），复用现有字段设计（仅新增模块专属业务字段）；
触发侧：新增对应模块的飞书事件订阅规则，复用现有触发服务框架；
业务侧：在通用飞书 SDK 中，对接对应模块的现有 API，复用现有状态回写 / 消息推送 / 异常处理逻辑。
八、核心技术实现框架（整体）
本次集成的技术实现分为4 个核心模块，均为松耦合设计，便于开发 / 测试 / 维护 / 拓展：
飞书开放平台对接模块：封装飞书多维表 / 机器人 / 消息的所有 API，提供增删改查 / 事件监听 / 卡片推送 / 消息发送等通用能力（通用 SDK，后续可复用）；
触发与流程控制模块：接收飞书事件，做触发条件判断 / 防重复触发 / 流程调度 / 状态统一回写，为核心流程引擎；
智融法助业务调用模块：封装现有业务接口（格式转换 / 元数据提取 / 深度审查），提供同步 / 异步调用 + 任务状态监听能力；
异常处理与通知模块：统一捕获所有环节的异常，做失败原因记录 / 状态回写 / 精准消息推送，为流程兜底。