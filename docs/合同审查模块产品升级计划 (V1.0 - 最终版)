📄 合同审查模块产品升级计划 (V1.0 - 最终版)
🎯 1. 概述
1.1 升级目标
本次升级旨在全面提升合同审查模块的用户体验、审查精准性和系统健壮性。通过引入“交易结构复选”、“主体风险提示”、“审查记录与历史任务管理”以及“长文本优化”等功能，使系统更能适应复杂、多样化的合同审查需求。

1.2 核心理念
用户赋能: 增强用户在审查流程中的参与度和控制权。
风险全面: 不仅审查条款，也关注合同当事人风险。
任务无感: 实现后台任务执行与历史记录查询，保障流程连续性。
性能优化: 针对长文本进行优化，提升处理效率和稳定性。
🏗️ 2. 架构设计
2.1 总体架构
在现有双系统（V1/V2）架构基础上，集成新功能：

前端: 增加“交易结构确认”、“主体风险展示”、“历史任务”UI。
后端: 扩展规则系统、集成风险查询、实现任务管理与长文本处理。
数据: 扩展模型、新增任务记录表。
服务: 复用 Celery 任务机制。
2.2 核心组件更新
见附图

🔄 3. 核心流程更新
3.1 主流程图 (含新功能)
graph TD
    Start([用户上传合同]) --> A[元数据提取与确认]
    A --> B{用户确认/编辑}
    B --> C[选择交易结构<br/>选择立场<br/>选择自定义规则]
    C --> D[启动深度审查]
    D --> E{选择审查系统<br/>use_langgraph?}
    E -->|True| F[V2: LangGraph 三阶段<br/>(集成分块处理)]
    E -->|False| G[V1: 传统四层<br/>(集成分块处理)]
    F --> H[...审查中...]
    G --> H
    H --> I[查询主体风险<br/>(EntityRiskService)]
    I --> J[生成审查结果<br/>(含主体风险标签)]
    J --> K[前端展示结果]
    K --> L[用户操作<br/>(选择修订/编辑意见)]

    A -.-> M[用户未完成退出]
    M -.-> N[Celery 后台执行<br/>(如果需要)]
    N -.-> O[保存任务状态<br/>(ContractReviewTask)]

    P[用户查看历史] --> Q[历史任务列表<br/>(ContractReviewTask)]
    Q --> R[继续未完成任务<br/>或 查看已完成任务]
    R --> S{任务状态?}
    S -->|Paused| T[恢复执行]
    S -->|Completed| U[查看结果]
    S -->|Failed| V[重试或查看错误]

    subgraph "新功能区域"
        C
        I
        O
        Q
        R
    end

3.2 详细流程说明 (含新功能)
阶段一：元数据确认 (新增“交易结构”)
元数据提取: 保持原有 AI 提取逻辑 (enhanced_extract_metadata)。
前端确认: 在 ContractReview.tsx 的元数据确认页面，新增“确认本次交易结构”区域。
UI: 提供一个复选框列表，选项根据 AI 提取的 legal_features 或知识图谱匹配结果动态生成。
交互: 用户可勾选一个或多个交易结构。
数据传递: 用户点击“开始审查”时，将选中的 transaction_structures 数组通过 startDeepReview API 传递给后端。

阶段二：AI 审查 (集成“交易结构”、“主体风险”、“长文本优化”)
接收参数: contract_router.py 的 start_deep_review 端点接收 transaction_structures 参数。
更新元数据: 将 transaction_structures 保存到 ContractDoc.metadata_info 中。
调用审查服务:
V1 & V2: 在调用审查服务前，先使用 utils.chunk_contract_text 对 contract_text 进行分块处理。
V1 (传统法): ContractReviewService.run_deep_review 接收分块后的文本列表和 transaction_structures，在内部循环处理或进行预处理。
V2 (LangGraph): LangGraphReviewService.run_deep_review 将分块逻辑或分块后的文本列表作为 initial_state 的一部分传递给 LangGraph。LangGraph 节点 (如 ai_reviewer_node) 需要修改以适应分块处理（例如，在 Stage 3 中，对每个块进行审查，然后聚合结果，或使用滑动窗口机制）。
规则系统增强 (V1 & V2):
RuleAssembler.assemble_prompt_context 方法新增 transaction_structures 参数。
新增 get_transaction_structure_rules 方法，根据传入的 transaction_structures 加载规则。
加载的规则与其他规则一起组装成 Prompt 上下文，传递给 LLM。
主体风险查询 (V1 & V2):
在审查流程的后期，调用 EntityRiskService.query_entity_risk 查询合同当事人风险信息。
将查询到的风险信息与审查项关联。
生成审查结果: 审查项 (ContractReviewItem) 生成时，对于涉及特定主体的审查项，填充其 entity_risk 字段。

阶段三：结果展示 (新增“主体风险”标签)
前端获取: ContractReview.tsx 获取审查结果列表。
前端渲染:
对于每个 review_item，如果其 entity_risk 字段不为空，则显示“主体风险”标签。
点击标签可展开显示具体的主体风险详情。
增加一个独立的“主体审查” Tab，集中展示所有主体风险。
阶段四：任务历史与管理 (复用 Celery 机制)
任务启动: 用户点击“开始审查”后，后端检查是否需要后台执行。如果需要，则将审查任务提交给 Celery。
Celery 任务 (复用/扩展):
方案A (推荐): 创建一个更通用的 Celery 任务 perform_document_ai_task，它接收 task_type ('review' 或 'generation') 和其他参数。根据 task_type 动态选择执行 LangGraphReviewService 或 LangGraphGenerationService 的逻辑。
方案B (独立): 为审查创建独立的 perform_contract_review 任务。该任务负责获取 ContractDoc，调用审查服务，更新 ContractReviewTask 状态。
历史记录查询 API: 新增 GET /api/contract/review-tasks 等端点，查询 ContractReviewTask 表。
前端历史页面 (ContractReviewHistory.tsx): 实现任务列表、分页、操作（继续、查看、删除）。

🚀 4. 开发任务清单 (Roadmap)
阶段一：核心功能集成 (High Priority)
任务 1.1: 前端元数据页面改造
在 ContractReview.tsx 中增加“确认本次交易结构”的 UI 组件。
实现复用逻辑和将 transaction_structures 传递给 API。
任务 1.2: API 层改造
修改 contract_router.py 中的 start_deep_review 端点，接收 transaction_structures 参数。
任务 1.3: 服务层集成 transaction_structures
修改 ContractReviewService.run_deep_review 和 LangGraphReviewService.run_deep_review，接收并处理 transaction_structures。
任务 1.4: 规则系统增强
修改 RuleAssembler.assemble_prompt_context，增加 transaction_structures 参数。
实现 get_transaction_structure_rules 方法。
任务 1.5: 数据模型扩展
修改 ContractDoc 模型，增加 transaction_structures 字段（JSON 类型）。
修改 ContractReviewItem 模型，增加 entity_risk 字段（JSON 类型）。
任务 1.6: 主体风险查询服务
创建 services/entity_risk_service.py，实现 query_entity_risk 方法。
任务 1.7: 审查流程集成主体风险
在 V1/V2 的审查流程中调用 EntityRiskService，并将结果存入 ContractReviewItem。
任务 1.8: 前端审查结果页面改造
在 ContractReview.tsx 的结果展示区域，根据 entity_risk 字段渲染“主体风险”标签和详情。
阶段二：长文本优化 (High Priority)
任务 2.1: 创建文本分块工具
创建 services/contract_review/utils.py，实现 chunk_contract_text 函数。
任务 2.2: 服务层集成分块
修改 ContractReviewService，在审查前对文本进行分块处理。
修改 LangGraphReviewService，将分块逻辑传递给工作流。
任务 2.3: LangGraph 节点适配分块
修改 ai_reviewer_node 中的 execute_stage_1, execute_stage_2, execute_stage_3，使其能处理文本块或利用分块信息。
任务 2.4: 前端提示
在 ContractReview.tsx 的上传页面增加合同长度提示。
阶段三：任务历史与管理 (High Priority)
任务 3.1: 设计任务历史模型
创建 models/contract_review_task.py，定义 ContractReviewTask 模型。
任务 3.2: 创建 Celery 任务
方案A: 修改现有通用任务或创建新的 perform_document_ai_task，支持 task_type='review'。
方案B: 创建独立的 tasks/contract_review_tasks.py，定义 perform_contract_review。
任务 3.3: 实现任务管理 API
在 contract_router.py 或新路由文件中，添加 GET /review-tasks, PUT /review-tasks/{id}/resume, DELETE /review-tasks/{id} 等端点。
任务 3.4: 创建历史任务前端页面
创建 frontend/src/pages/ContractReviewHistory.tsx。
任务 3.5: 集成 Celery 与任务记录
修改 Celery 任务，在开始、暂停、完成、失败时更新 ContractReviewTask 状态。
任务 3.6: 从前端链接到历史页面
在 ContractReview.tsx 或导航栏中增加“历史任务”链接。
阶段四：优化与完善 (Low Priority)
任务 4.1: 清理未使用的代码
任务 4.2: LLM 客户端单例化
任务 4.3: 集成 RAG 检索与物理模板加载 (如果审查模块也需要)
任务 4.4: SKILL/Tool 改造 (如果需要)
🧪 5. 测试计划
5.1 单元测试
RuleAssembler 的 get_transaction_structure_rules 方法。
EntityRiskService 的 query_entity_risk 方法。
utils.chunk_contract_text 方法。
ContractReviewTask 模型的 CRUD 操作。
5.2 集成测试
交易结构选择 -> 审查 -> 结果中包含对应规则的审查项。
主体风险查询 -> 审查结果中包含 entity_risk 信息。
大文件上传 -> 分块处理 -> 审查 -> 完成。
任务提交 -> Celery 执行 -> 状态更新 -> 前端历史页面查询。
历史任务恢复 -> Celery 继续执行 -> 状态更新。
5.3 性能测试
大文件（如 5000 字以上）审查时后台任务的性能。
大量历史任务对数据库查询性能的影响。
分块处理对审查准确性和效率的影响。
📚 6. 附录
6.1 状态定义 (ContractReviewTask.status)
pending, running, paused, completed, failed, cancelled

6.2 API 端点列表
(参考 contract_router.py 和新增的 /review-tasks 相关端点)