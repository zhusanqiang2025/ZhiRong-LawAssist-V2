# 使用官方Python运行时作为基础镜像
# 原来的 python:3.11-slim 在国内拉不动，必须换成下面这个长地址：
FROM swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/python:3.11-slim

# 设置工作目录
WORKDIR /app

# 设置时区为中国时区
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
RUN sed -i 's|deb.debian.org|mirrors.cloud.tencent.com|g' /etc/apt/sources.list.d/debian.sources

# 3. 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
ENV PYTHONUNBUFFERED=1

# ==================== API 密钥配置 ====================
# 【修复】使用有效的 API Key
# DeepSeek / LangChain / OpenAI API Key
ENV DEEPSEEK_API_KEY=7adb34bf-3cb3-4dea-af41-b79de8c08ca3
ENV DEEPSEEK_API_URL=https://sd4a58h819ma6giel1ck0.apigateway-cn-beijing.volceapi.com/v1
ENV DEEPSEEK_MODEL=Qwen3-235B-A22B-Thinking-2507
ENV DEEPSEEK_TEMPERATURE=0.7
ENV DEEPSEEK_MAX_TOKENS=2000
ENV DEEPSEEK_TIMEOUT=60

# LangChain API (用于风险评估等核心功能)
ENV LANGCHAIN_API_KEY=7adb34bf-3cb3-4dea-af41-b79de8c08ca3
ENV LANGCHAIN_API_BASE_URL=https://sd4a58h819ma6giel1ck0.apigateway-cn-beijing.volceapi.com/v1
ENV MODEL_NAME=Qwen3-235B-A22B-Thinking-2507

# OpenAI API (用于合同生成模块)
ENV OPENAI_API_KEY=7adb34bf-3cb3-4dea-af41-b79de8c08ca3
ENV OPENAI_API_BASE=https://sd4a58h819ma6giel1ck0.apigateway-cn-beijing.volceapi.com/v1

# Qwen3-235B-Thinking 模型配置
# 【修复】使用有效的 API Key
ENV QWEN3_THINKING_API_KEY=7adb34bf-3cb3-4dea-af41-b79de8c08ca3
ENV QWEN3_THINKING_API_URL=https://sd4a58h819ma6giel1ck0.apigateway-cn-beijing.volceapi.com/v1
ENV QWEN3_THINKING_MODEL=Qwen3-235B-A22B-Thinking-2507
ENV QWEN3_THINKING_TIMEOUT=120
ENV QWEN3_THINKING_ENABLED=true

# ==================== 数据库配置 ====================
ENV POSTGRES_SERVER=postgres18-0.postgres18.gms.svc.cluster.local
ENV POSTGRES_PORT=5432
ENV POSTGRES_DB=legal_assistant_db
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=postgres
ENV DATABASE_URL=postgresql://postgres:postgres@postgres18-0.postgres18.gms.svc.cluster.local:5432/legal_assistant_db

# ==================== Redis 配置（已移除，使用内存缓存）====================
# ENV REDIS_HOST=redis7.gms.svc.cluster.local
# ENV REDIS_PORT=6379
# ENV REDIS_DB=0
# ENV REDIS_URL=redis://redis7.gms.svc.cluster.local:6379/0
# ENV CELERY_BROKER_URL=redis://redis:6379/0
# ENV CELERY_RESULT_BACKEND=redis://redis:6379/0

# ==================== 管理员账户配置 ====================
# 首次部署时自动创建管理员账户（如果数据库为空）
# 此账户既是应用系统管理员，也是飞书集成的应用访问账户
ENV DEFAULT_ADMIN_EMAIL=zhusanqiang@az028.cn
ENV DEFAULT_ADMIN_PASSWORD=01689101abc
# 数据种子脚本也使用的管理员配置（与上面保持一致）
ENV SEED_ADMIN_EMAIL=zhusanqiang@az028.cn
ENV SEED_ADMIN_PASSWORD=01689101abc

# ==================== 其他服务配置 ====================
ENV SECRET_KEY=a_very_long_and_super_secret_random_string_that_is_hard_to_guess
ENV ACCESS_TOKEN_EXPIRE_MINUTES=1440
ENV ONLYOFFICE_JWT_SECRET=legal_doc_secret_2025
# 后端公网访问地址（与前端共用域名，用于飞书回调等外部访问）
ENV BACKEND_PUBLIC_URL=https://legal-assistant-v3.azgpu02.azshentong.com
# 前端访问地址（用于飞书通知跳转到前端审查结果页面）
# ⚠️ 生产环境实际地址
ENV FRONTEND_PUBLIC_URL=https://legal-assistant-v3.azgpu02.azshentong.com
# 额外的允许跨域访问地址（可选，逗号分隔）
ENV ALLOWED_ORIGINS=

# Dify 配置 (暂时禁用)
ENV DIFY_ENABLED=false
ENV DIFY_GUIDANCE_ANALYSIS_ENABLED=false
ENV DIFY_EXPERT_CONSULTATION_ENABLED=false

# ==================== 飞书集成配置 ====================
# 飞书应用凭证（实际配置值）
ENV FEISHU_APP_ID=cli_a764e1e9d1f9500c
ENV FEISHU_APP_SECRET=WElXdiIIoX2pOQUKiivhdf8MENQb28iR
# 飞书 API 基础地址
ENV FEISHU_BASE_API_URL=https://open.feishu.cn/open-apis
# 飞书回调验证密钥
ENV FEISHU_ENCRYPT_KEY=wzC6b0QXee1aKMcuAMGzvg5RZoT2j0Sd
ENV FEISHU_VERIFICATION_TOKEN=sWMXUy2DRkuvthwTlQg4z58O7kgbwmeT
# 飞书多维表配置（实际配置值）
ENV FEISHU_BITABLE_APP_TOKEN=ZChtbTe0YaAnIss6EVpcStLcnbc
ENV FEISHU_BITABLE_TABLE_ID=tbliwRvXwY2wCBnn
# 飞书卡片回调地址（自动基于 BACKEND_PUBLIC_URL 生成）
ENV FEISHU_CARD_CALLBACK_URL=
# 系统服务账户（用于飞书集成调用审查模块 - 实际配置值）
ENV SYSTEM_SERVICE_EMAIL=zhusanqiang@az028.cn
ENV SYSTEM_SERVICE_PASSWORD=01689101abc
# 默认审查人 OPEN_ID（可选）
ENV DEFAULT_REVIEWER_OPEN_ID=
# 审查模块 API 地址（Docker 网络内使用）
ENV REVIEW_API_BASE=http://backend:8000

# MinerU PDF 解析服务（公网地址）
ENV MINERU_API_URL=https://newapi.dev.azshentong.com/v1
ENV MINERU_API_KEY=sk-qu85R6PvJu89AAnVdUph5qW1zisvrydVHBAopLluM650TTlE
ENV MINERU_API_TIMEOUT=120
ENV MINERU_ENABLED=true

# OCR 服务（公网地址）
ENV OCR_API_URL=https://newapi.dev.azshentong.com/v1
ENV OCR_API_KEY=sk-EQOScNCvMG5SHHmfiwVOI1IdnS47bF6lPrtvQEZTFxsTyH2S
ENV OCR_API_TIMEOUT=60
ENV OCR_ENABLED=true

# AI 文档预处理
ENV AI_POSTPROCESS_ENABLED=true
ENV AI_POSTPROCESS_MODEL=qwen3-vl:32b-thinking-q8_0
ENV AI_POSTPROCESS_API_URL=https://newapi.dev.azshentong.com/v1
ENV AI_POSTPROCESS_API_KEY=sk-KTBuFAEubEOFBpGeVEVisvORtTkvny6OHAiPPGaHQuLAvJ
ENV AI_AUTH_TYPE=bearer
ENV AI_POSTPROCESS_TIMEOUT=30
ENV AI_POSTPROCESS_BATCH_SIZE=5
ENV AI_POSTPROCESS_CONFIDENCE_THRESHOLD=0.7
ENV AI_POSTPROCESS_ONLY_AMBIGUOUS=true

# GPT-OSS-120B 模型
ENV GPT_OSS_120B_API_URL=http://101.126.134.56:11434/v1
ENV GPT_OSS_120B_MODEL=gpt-oss:120b

# BGE 嵌入模型（公网地址）
ENV BGE_EMBEDDING_API_URL=https://newapi.dev.azshentong.com/v1
ENV BGE_EMBEDDING_API_KEY=sk-ZLvhvOzb6KriMr961O8AGo73wG9nRblmDiECFybokz6r3iM8
ENV BGE_RERANKER_API_URL=https://newapi.dev.azshentong.com/v1
ENV BGE_RERANKER_API_KEY=sk-moDTih3CzjnCB8YP9RB829O1ckRPFXbzZC4VAi1Juf5gt2Nw
ENV BGE_MODEL_NAME=bge-m3
ENV BGE_EMBEDDING_DIM=1024
ENV BGE_TIMEOUT=30

# Celery 任务队列（已禁用，需要 Redis）
ENV CELERY_ENABLED=false
ENV CELERY_TASK_TRACK_STARTED=true
ENV CELERY_TASK_TIME_LIMIT=3600
ENV CELERY_TASK_SOFT_TIME_LIMIT=3300

# Flower 监控
ENV FLOWER_PORT=5556

# 向量数据库
ENV CHROMA_PERSIST_DIR=./storage/chroma_db
ENV VECTOR_DB_TYPE=chroma

# 4. 更换 Debian 系统源 (加速 apt install)
RUN sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list.d/debian.sources

# 5. 安装系统依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc \
        libpq-dev \
        libreoffice \
        fonts-liberation \
        tesseract-ocr \
        tesseract-ocr-chi-sim \
        graphviz \
        curl \
        && rm -rf /var/lib/apt/lists/*

# 7.5. 安装 Node.js 20.x 并构建前端
# 使用 npm 中国镜像加速下载
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs 

# 复制requirements文件
COPY requirements.txt .

# 安装Python依赖（运行时环境）
RUN pip config set global.index-url https://mirrors.cloud.tencent.com/pypi/simple \
    && pip install --no-cache-dir -r requirements.txt

# 6. 复制后端代码（复制 backend 目录内容到 /app）
COPY backend /app

# 7. 复制前端代码并构建
COPY frontend /app/frontend
WORKDIR /app/frontend
RUN npm config set registry https://registry.npmmirror.com && \
    npm ci --verbose && \
    npx vite build

# 8. 将前端构建产物复制到后端静态目录
WORKDIR /app
RUN mkdir -p static/frontend && \
    cp -r frontend/dist/* static/frontend/

# 9. 暴露端口
EXPOSE 8000

# 10. 启动应用
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--ws-ping-interval", "20", "--ws-ping-timeout", "300"]
