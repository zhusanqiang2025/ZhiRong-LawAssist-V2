# 任务显示功能更新说明

**更新时间**: 2026-01-14 14:47
**状态**: ✅ 已完成

---

## 一、更新内容

### 1. Banner 下方区域：改为"进行中的任务"

**位置**: [SceneSelectionPage.tsx:551-603](frontend/src/pages/SceneSelectionPage.tsx#L551-L603)

**变更内容**:
- ✅ 原来的"最近任务"统计卡片改为"进行中的任务"详细展示
- ✅ 仅显示状态为 `pending` 或 `processing` 的任务
- ✅ 以卡片形式展示最多 4 个进行中的任务
- ✅ 每个任务卡片显示：
  - 任务标题（自动截断）
  - 进度条（蓝色动态进度条）
  - 创建时间（相对时间格式）
- ✅ 整个卡片区域采用蓝色主题（#1890ff）
- ✅ 添加说明文字："您关闭浏览器后，这些任务仍在后台继续执行"

**视觉效果**:
```
┌─────────────────────────────────────────────────────────────┐
│ 🔄 进行中的任务 (3)    您关闭浏览器后，这些任务仍在后台继续执行 │
├─────────────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│ │案件分析  │ │风险评估  │ │合同审查  │ │文书起草  │         │
│ │██████░░░░│ │██████████│ │███░░░░░░░│ │███████░░░│         │
│ │5分钟前   │ │2小时前   │ │1天前     │ │3天前     │         │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘         │
└─────────────────────────────────────────────────────────────┘
```

**用途**: 展示用户中途退出但尚未完成的工作，体现 Celery 任务持久化特性

---

### 2. 左侧边栏：优化"最近任务"列表

**位置**: [SceneSelectionPage.tsx:643-726](frontend/src/pages/SceneSelectionPage.tsx#L643-L726)

**新增功能**:

#### 2.1 添加刷新按钮
- 标题栏右侧新增"刷新"按钮
- 点击可手动刷新任务列表
- 加载时显示旋转图标

#### 2.2 优化任务项显示
- ✅ 添加状态图标：
  - 🔄 进行中任务：蓝色旋转图标
  - ✅ 已完成任务：绿色勾选图标
- ✅ 进度条仅在进行中的任务显示
- ✅ 优化字体大小和间距
- ✅ 添加任务项之间的分隔线

#### 2.3 改进空状态
- ✅ 加载时显示"加载中..."提示
- ✅ 无任务时显示居中的"暂无最近任务"
- ✅ 有任务时显示"查看全部 →"链接（指向 /tasks 页面）

#### 2.4 限制高度
- 设置 `maxHeight: '40vh'` 防止列表过长
- 超出部分可滚动

**视觉效果**:
```
┌──────────────────────────┐
│ 最近任务        [刷新]   │
├──────────────────────────┤
│ 🔄 案件分析: 张三诉李四 │
│    ████████░░  5分钟前   │
├──────────────────────────┤
│ ✅ 风险评估: 合同审查    │
│    1小时前              │
├──────────────────────────┤
│ 🔄 文书起草: 答辩状      │
│    ██████░░░░  2小时前   │
├──────────────────────────┤
│      查看全部 →          │
└──────────────────────────┘
```

---

## 二、技术实现

### 2.1 API 调用

**后端端点**:
- `GET /api/v1/tasks?status=pending,processing&limit=10` - 获取进行中的任务
- `GET /api/v1/tasks?status=completed&limit=10` - 获取已完成的任务

**状态映射** ([tasks.py:386-403](backend/app/api/v1/endpoints/tasks.py#L386-L403)):
```python
status_map = {
    'pending': '进行中',
    'processing': '进行中',
    'completed': '已完成',
    'failed': '失败',
    'cancelled': '已取消'
}
```

### 2.2 数据格式

**任务对象结构**:
```typescript
interface TaskItem {
  id: string;           // 任务ID
  title: string;        // 任务标题（优先使用 doc_type，其次 user_demand）
  status: string;       // 状态：'进行中' | '已完成' | '失败' | '已取消'
  progress: number;     // 进度 0-100
  time: string;         // 相对时间：'5分钟前' | '2小时前' | '1天前'
  created_at?: string;  // ISO格式时间戳
}
```

### 2.3 响应式设计

**Banner 下方进行中任务**:
- `xs={24}` - 移动端：1列
- `sm={12}` - 平板：2列
- `md={6}` - 桌面：4列
- 最多显示 4 个任务

**左侧任务列表**:
- 固定最大高度：40vh
- 内容过多时自动滚动
- 最多显示 5 个任务（混合进行中和已完成）

---

## 三、用户体验优化

### 3.1 Celery 任务持久化展示

**目的**: 让用户直观感受到 Celery 系统的优势

**实现方式**:
1. Banner 下方专门展示"进行中的任务"
2. 添加说明文字："您关闭浏览器后，这些任务仍在后台继续执行"
3. 点击任务卡片可跳转到结果页面查看

**测试场景**:
1. 用户提交一个案件分析任务
2. **立即关闭浏览器** ← 关键
3. 等待 1-2 分钟
4. 重新打开并登录
5. **Banner 下方应该看到该任务仍在进行中**
6. 最终可以查看完整的分析结果

### 3.2 刷新机制

**自动刷新**: 页面加载时自动获取任务列表
**手动刷新**: 点击"刷新"按钮立即更新

### 3.3 空状态处理

- **无进行中任务**: Banner 下方不显示该区域
- **无最近任务**: 左侧显示"暂无最近任务"
- **加载中**: 显示加载动画和提示文字

---

## 四、与后端 API 的集成

### 4.1 后端 API 状态

**文件**: [backend/app/api/v1/endpoints/tasks.py](backend/app/api/v1/endpoints/tasks.py)

**可用端点**:
| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/v1/tasks` | GET | 获取任务列表（支持状态过滤） |
| `/api/v1/tasks/stats` | GET | 获取任务统计 |
| `/api/v1/tasks/unviewed` | GET | 获取未查看的已完成任务 |
| `/api/v1/tasks/{task_id}/status` | GET | 获取任务状态 |
| `/api/v1/tasks/{task_id}/mark-viewed` | POST | 标记任务为已查看 |
| `/api/v1/tasks/{task_id}/cancel` | POST | 取消任务 |

**路由注册**: [backend/app/api/v1/router.py:22](backend/app/api/v1/router.py#L22)
```python
api_router.include_router(tasks.router, prefix="/tasks", tags=["Tasks"])
```

### 4.2 数据来源

**数据库表**: `tasks` 表

**字段映射**:
```python
{
    "id": task.id,                      # UUID
    "title": task.doc_type or user_demand,
    "status": status_map[task.status],  # 状态映射
    "progress": task.progress or 0,     # 0-100
    "time": format_relative_time(created_at),
    "created_at": task.created_at.isoformat()
}
```

---

## 五、测试建议

### 5.1 功能测试

1. **测试任务列表显示**:
   - 登录系统
   - 提交一个测试任务（案件分析）
   - 刷新页面
   - 检查左侧"最近任务"是否显示
   - 检查 Banner 下方是否显示"进行中的任务"

2. **测试任务持久化**:
   - 提交任务后立即关闭浏览器
   - 等待 1-2 分钟
   - 重新打开并登录
   - 验证任务仍在进行或已完成

3. **测试刷新按钮**:
   - 点击左侧"刷新"按钮
   - 验证任务列表更新

### 5.2 UI 测试

- 响应式布局（移动端/平板/桌面）
- 任务标题截断（超过 30 字符）
- 进度条动画效果
- 空状态显示
- 加载状态显示

---

## 六、已知限制

1. **任务数量限制**:
   - Banner 下方最多显示 4 个进行中的任务
   - 左侧列表最多显示 5 个任务

2. **刷新频率**:
   - 当前仅在页面加载时自动刷新
   - 后续可考虑添加定时轮询（如每 30 秒）

3. **数据来源**:
   - 当前从数据库 `tasks` 表读取
   - 需要确保系统中有任务数据

---

## 七、后续优化建议

1. **添加实时更新**: 使用 WebSocket 推送任务状态变化
2. **添加任务筛选**: 允许用户按类型/状态筛选任务
3. **添加任务排序**: 支持按时间/进度/类型排序
4. **添加任务操作**: 支持取消/重试失败的任务
5. **添加任务详情**: 点击任务显示更多详细信息

---

## 八、相关文件

### 前端
- [frontend/src/pages/SceneSelectionPage.tsx](frontend/src/pages/SceneSelectionPage.tsx) - 主页面
- [frontend/src/api/index.ts](frontend/src/api/index.ts) - API 调用

### 后端
- [backend/app/api/v1/endpoints/tasks.py](backend/app/api/v1/endpoints/tasks.py) - 任务 API
- [backend/app/api/v1/router.py](backend/app/api/v1/router.py) - 路由注册
- [backend/app/models/task.py](backend/app/models/task.py) - 任务模型

### 文档
- [CELERY_STATUS_REPORT.md](./CELERY_STATUS_REPORT.md) - Celery 系统状态报告
- [CELERY_QUICK_START.md](./CELERY_QUICK_START.md) - 快速开始指南

---

**总结**: 任务显示功能已全面优化，Banner 下方改为展示"进行中的任务"以突出 Celery 任务持久化特性，左侧任务列表添加刷新按钮和优化显示效果。前端已重新构建并部署，请刷新浏览器查看效果。
